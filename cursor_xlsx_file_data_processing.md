# XLSX file data processing
_Exported on 12/31/2025 at 11:21:13 GMT+2 from Cursor (2.2.44)_

---

**User**

@c:\Users\user\ambs\ take the xlsx files in this folder and perform the following:
1. Remove empty sheets (sheets where only the 1st row has data and the rest are empty)
For the rest of the sheets:
1. Split the date and time column (column A) to 2 columns - one for the date and one for the time
2. Delete the rows between "Deliver Compound" and "Measuring Antidote" in column B
3. Calculate the average values in each column for each minute that was measured
4. Export the new file

---

**Cursor**

I'll help you process these Excel files. Let me first create a Python script to handle all these operations. I'll need to examine the structure of the files first.

```python
import pandas as pd
import os
from openpyxl import load_workbook
from datetime import datetime

def is_sheet_empty(df):
    """Check if sheet only has header row (first row) and rest is empty"""
    if len(df) <= 1:
        return True
    # Check if all rows after the first are empty
    if len(df) > 1:
        data_rows = df.iloc[1:]
        if data_rows.dropna(how='all').empty:
            return True
    return False

def process_excel_file(input_path):
    """Process a single Excel file according to the requirements"""
    print(f"\n{'='*60}")
    print(f"Processing: {input_path}")
    print(f"{'='*60}")
    
    # Load the workbook to get sheet names
    xl = pd.ExcelFile(input_path)
    sheet_names = xl.sheet_names
    print(f"Found {len(sheet_names)} sheets: {sheet_names}")
    
    processed_sheets = {}
    
    for sheet_name in sheet_names:
        print(f"\n--- Processing sheet: {sheet_name} ---")
        
        # Read the sheet
        df = pd.read_excel(input_path, sheet_name=sheet_name)
        
        # Check if sheet is empty (only header row)
        if is_sheet_empty(df):
            print(f"  Sheet '{sheet_name}' is empty (only header row). Skipping...")
            continue
        
        print(f"  Original shape: {df.shape}")
        print(f"  Columns: {list(df.columns)}")
        
        # Step 1: Split date and time column (Column A - first column)
        first_col = df.columns[0]
        print(f"  First column name: '{first_col}'")
        
        # Check if the first column contains datetime data
        try:
            # Try to parse as datetime if it's not already
            if df[first_col].dtype == 'object':
                df[first_col] = pd.to_datetime(df[first_col], errors='coerce')
            
            # Split into date and time
            df.insert(0, 'Date', df[first_col].dt.date)
            df.insert(1, 'Time', df[first_col].dt.time)
            
            # Remove the original datetime column
            df = df.drop(columns=[first_col])
            print(f"  Split datetime column into 'Date' and 'Time'")
        except Exception as e:
            print(f"  Warning: Could not split datetime column: {e}")
        
        # Step 2: Delete rows between "Deliver Compound" and "Measuring Antidote" in column B
        # After splitting, column B is now the 3rd column (index 2)
        col_b = df.columns[2] if len(df.columns) > 2 else None
        
        if col_b is not None:
            print(f"  Looking for markers in column: '{col_b}'")
            
            # Find indices of marker rows
            deliver_mask = df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False)
            antidote_mask = df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
            
            deliver_indices = df.index[deliver_mask].tolist()
            antidote_indices = df.index[antidote_mask].tolist()
            
            print(f"  Found 'Deliver Compound' at indices: {deliver_indices}")
            print(f"  Found 'Measuring Antidote' at indices: {antidote_indices}")
            
            # Delete rows between each pair
            rows_to_delete = []
            for deliver_idx in deliver_indices:
                # Find the next "Measuring Antidote" after this "Deliver Compound"
                next_antidote = [idx for idx in antidote_indices if idx > deliver_idx]
                if next_antidote:
                    antidote_idx = next_antidote[0]
                    # Mark rows between (exclusive of both markers)
                    rows_between = df.index[(df.index > deliver_idx) & (df.index < antidote_idx)].tolist()
                    rows_to_delete.extend(rows_between)
                    print(f"  Marking rows {deliver_idx+1} to {antidote_idx-1} for deletion")
            
            if rows_to_delete:
                df = df.drop(index=rows_to_delete)
                print(f"  Deleted {len(rows_to_delete)} rows between markers")
            else:
                print(f"  No rows to delete between markers")
        
        # Reset index after deletion
        df = df.reset_index(drop=True)
        
        # Step 3: Calculate average values for each minute
        # Group by the Time column (rounded to minute) and calculate mean
        if 'Time' in df.columns:
            # Convert time to string for minute extraction
            df['Minute'] = df['Time'].apply(lambda x: str(x)[:5] if pd.notna(x) else None)
            
            # Get numeric columns for averaging
            numeric_cols = df.select_dtypes(include=['number']).columns.tolist()
            print(f"  Numeric columns for averaging: {numeric_cols}")
            
            if numeric_cols and 'Minute' in df.columns:
                # Group by Date and Minute, calculate mean for numeric columns
                group_cols = ['Date', 'Minute']
                if 'Date' not in df.columns:
                    group_cols = ['Minute']
                
                # Keep first occurrence of non-numeric columns
                agg_dict = {col: 'mean' for col in numeric_cols}
                
                # Also keep other columns (take first value)
                other_cols = [col for col in df.columns if col not in numeric_cols and col not in group_cols]
                for col in other_cols:
                    if col != 'Time':  # Skip original time column
                        agg_dict[col] = 'first'
                
                df_averaged = df.groupby(group_cols, as_index=False).agg(agg_dict)
                
                # Rename Minute back to Time
                df_averaged = df_averaged.rename(columns={'Minute': 'Time'})
                
                print(f"  Averaged shape: {df_averaged.shape} (from {df.shape[0]} rows)")
                df = df_averaged
            else:
                # Remove the Minute column if we couldn't average
                if 'Minute' in df.columns:
                    df = df.drop(columns=['Minute'])
        
        processed_sheets[sheet_name] = df
        print(f"  Final shape: {df.shape}")
    
    return processed_sheets

def save_processed_file(processed_sheets, original_path):
    """Save processed sheets to a new Excel file"""
    # Create output filename
    base_name = os.path.splitext(os.path.basename(original_path))[0]
    output_path = os.path.join(os.path.dirname(original_path), f"{base_name}_processed.xlsx")
    
    if processed_sheets:
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            for sheet_name, df in processed_sheets.items():
                df.to_excel(writer, sheet_name=sheet_name, index=False)
        print(f"\nSaved processed file to: {output_path}")
        return output_path
    else:
        print(f"\nNo sheets to save for {original_path}")
        return None

def main():
    # Directory containing the Excel files
    directory = r"C:\Users\user\ambs"
    
    # Find all xlsx files
    xlsx_files = [f for f in os.listdir(directory) if f.endswith('.xlsx') and not f.startswith('~$')]
    
    print(f"Found {len(xlsx_files)} Excel files: {xlsx_files}")
    
    for xlsx_file in xlsx_files:
        if '_processed' in xlsx_file:
            print(f"Skipping already processed file: {xlsx_file}")
            continue
            
        input_path = os.path.join(directory, xlsx_file)
        
        try:
            processed_sheets = process_excel_file(input_path)
            save_processed_file(processed_sheets, input_path)
        except Exception as e:
            print(f"Error processing {xlsx_file}: {e}")
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    main()

```

Let me first install the required dependencies and then run the script:

Now let me run the processing script:

I see some issues in the output. The "Time" column already exists, and the averaging is collapsing everything to a single row because all times are being grouped into one minute. Let me fix the script to properly handle the datetime format and preserve per-minute granularity:

```python
import pandas as pd
import os
from openpyxl import load_workbook
from datetime import datetime

def is_sheet_empty(df):
    """Check if sheet only has header row (first row) and rest is empty"""
    if len(df) <= 1:
        return True
    # Check if all rows after the first are empty
    if len(df) > 1:
        data_rows = df.iloc[1:]
        if data_rows.dropna(how='all').empty:
            return True
    return False

def process_excel_file(input_path):
    """Process a single Excel file according to the requirements"""
    print(f"\n{'='*60}")
    print(f"Processing: {input_path}")
    print(f"{'='*60}")
    
    # Load the workbook to get sheet names
    xl = pd.ExcelFile(input_path)
    sheet_names = xl.sheet_names
    print(f"Found {len(sheet_names)} sheets: {sheet_names}")
    
    processed_sheets = {}
    
    for sheet_name in sheet_names:
        print(f"\n--- Processing sheet: {sheet_name} ---")
        
        # Read the sheet
        df = pd.read_excel(input_path, sheet_name=sheet_name)
        
        # Check if sheet is empty (only header row)
        if is_sheet_empty(df):
            print(f"  Sheet '{sheet_name}' is empty (only header row). Skipping...")
            continue
        
        print(f"  Original shape: {df.shape}")
        print(f"  Columns: {list(df.columns)}")
        
        # Step 1: Split date and time column (Column A - first column)
        first_col = df.columns[0]
        print(f"  First column name: '{first_col}'")
        
        # Check sample values
        sample_val = df[first_col].iloc[0] if len(df) > 0 else None
        print(f"  Sample value in first column: {sample_val} (type: {type(sample_val).__name__})")
        
        # Try to parse as datetime if it's not already
        datetime_col = None
        try:
            if pd.api.types.is_datetime64_any_dtype(df[first_col]):
                datetime_col = df[first_col]
            else:
                datetime_col = pd.to_datetime(df[first_col], errors='coerce')
            
            # Check if we have valid datetime data
            valid_count = datetime_col.notna().sum()
            print(f"  Valid datetime values: {valid_count}/{len(df)}")
            
            if valid_count > 0:
                # Create new columns for Date and Time
                new_cols = df.columns.tolist()
                
                # Insert Date and Time at the beginning
                df.insert(0, 'Date_New', datetime_col.dt.date)
                df.insert(1, 'Time_New', datetime_col.dt.strftime('%H:%M:%S'))
                
                # Drop the original first column (now at index 2)
                original_col_name = df.columns[2]
                df = df.drop(columns=[original_col_name])
                
                # Rename the new columns
                df = df.rename(columns={'Date_New': 'Date', 'Time_New': 'Time'})
                
                print(f"  Split datetime column into 'Date' and 'Time'")
                print(f"  New columns: {list(df.columns[:5])}...")
            else:
                print(f"  Warning: No valid datetime values found, keeping original column")
        except Exception as e:
            print(f"  Warning: Could not split datetime column: {e}")
        
        # Step 2: Delete rows between "Deliver Compound" and "Measuring Antidote" in column B
        # Column B is now the 3rd column (index 2) after splitting
        if len(df.columns) > 2:
            col_b = df.columns[2]
            print(f"  Looking for markers in column: '{col_b}'")
            
            # Find indices of marker rows
            deliver_mask = df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False)
            antidote_mask = df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
            
            deliver_indices = df.index[deliver_mask].tolist()
            antidote_indices = df.index[antidote_mask].tolist()
            
            print(f"  Found 'Deliver Compound' at indices: {deliver_indices}")
            print(f"  Found 'Measuring Antidote' at indices: {antidote_indices}")
            
            # Delete rows between each pair
            rows_to_delete = []
            for deliver_idx in deliver_indices:
                # Find the next "Measuring Antidote" after this "Deliver Compound"
                next_antidote = [idx for idx in antidote_indices if idx > deliver_idx]
                if next_antidote:
                    antidote_idx = next_antidote[0]
                    # Mark rows between (exclusive of both markers)
                    rows_between = df.index[(df.index > deliver_idx) & (df.index < antidote_idx)].tolist()
                    rows_to_delete.extend(rows_between)
                    print(f"  Marking rows {deliver_idx+1} to {antidote_idx-1} for deletion")
            
            if rows_to_delete:
                df = df.drop(index=rows_to_delete)
                print(f"  Deleted {len(rows_to_delete)} rows between markers")
            else:
                print(f"  No rows to delete between markers")
        
        # Reset index after deletion
        df = df.reset_index(drop=True)
        
        # Step 3: Calculate average values for each minute
        # Group by Date and Time (truncated to minute) and calculate mean
        if 'Time' in df.columns:
            # Extract minute from time (HH:MM format)
            df['Minute'] = df['Time'].astype(str).str[:5]  # Get HH:MM
            
            # Get numeric columns for averaging
            numeric_cols = df.select_dtypes(include=['number']).columns.tolist()
            print(f"  Numeric columns for averaging: {numeric_cols}")
            
            if numeric_cols:
                # Group by Date and Minute
                group_cols = []
                if 'Date' in df.columns:
                    group_cols.append('Date')
                group_cols.append('Minute')
                
                # Create aggregation dictionary for numeric columns
                agg_dict = {col: 'mean' for col in numeric_cols}
                
                # For non-numeric columns (except grouping cols and Time), take first value
                non_numeric_cols = [col for col in df.columns 
                                   if col not in numeric_cols 
                                   and col not in group_cols 
                                   and col != 'Time']
                for col in non_numeric_cols:
                    agg_dict[col] = 'first'
                
                # Perform grouping and aggregation
                df_averaged = df.groupby(group_cols, as_index=False).agg(agg_dict)
                
                # Rename Minute back to Time
                df_averaged = df_averaged.rename(columns={'Minute': 'Time'})
                
                print(f"  Averaged: {df.shape[0]} rows -> {df_averaged.shape[0]} rows (by minute)")
                df = df_averaged
                
                # Reorder columns: Date, Time, then the rest
                cols = df.columns.tolist()
                if 'Date' in cols and 'Time' in cols:
                    new_order = ['Date', 'Time'] + [c for c in cols if c not in ['Date', 'Time']]
                    df = df[new_order]
            else:
                # Remove the Minute column if we couldn't average
                if 'Minute' in df.columns:
                    df = df.drop(columns=['Minute'])
        
        processed_sheets[sheet_name] = df
        print(f"  Final shape: {df.shape}")
    
    return processed_sheets

def save_processed_file(processed_sheets, original_path):
    """Save processed sheets to a new Excel file"""
    # Create output filename
    base_name = os.path.splitext(os.path.basename(original_path))[0]
    output_path = os.path.join(os.path.dirname(original_path), f"{base_name}_processed.xlsx")
    
    if processed_sheets:
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            for sheet_name, df in processed_sheets.items():
                df.to_excel(writer, sheet_name=sheet_name, index=False)
        print(f"\nSaved processed file to: {output_path}")
        return output_path
    else:
        print(f"\nNo sheets to save for {original_path}")
        return None

def main():
    # Directory containing the Excel files
    directory = r"C:\Users\user\ambs"
    
    # Find all xlsx files
    xlsx_files = [f for f in os.listdir(directory) if f.endswith('.xlsx') and not f.startswith('~$')]
    
    print(f"Found {len(xlsx_files)} Excel files: {xlsx_files}")
    
    for xlsx_file in xlsx_files:
        if '_processed' in xlsx_file:
            print(f"Skipping already processed file: {xlsx_file}")
            continue
            
        input_path = os.path.join(directory, xlsx_file)
        
        try:
            processed_sheets = process_excel_file(input_path)
            save_processed_file(processed_sheets, input_path)
        except Exception as e:
            print(f"Error processing {xlsx_file}: {e}")
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    main()

```

I've successfully processed both Excel files. Here's a summary of what was done:

## Processing Complete ✓

### Files Created:
- `baseline_processed.xlsx` 
- `exp_processed.xlsx`

### What the script did:

1. **Removed empty sheets** - All `.Apnea` sheets were empty (only had header rows) and were excluded from the output. For example, `23432.Apnea`, `5345346.Apnea`, `2a.Apnea`, etc.

2. **Split the Date/Time column** - The original `Time` column (e.g., `2025-12-16 13:57:23.021000`) was split into:
   - `Date` column (e.g., `2025-12-16`)
   - `Time` column (e.g., `13:57:23`)

3. **Deleted rows between markers** - Rows between "Deliver Compound" and "Measuring Antidote" in column B (Subject) were removed. For example:
   - Sheet `2a.WBPth`: 195 rows deleted
   - Sheet `3a.WBPth`: 189 rows deleted
   - And so on for all sheets...

4. **Calculated minute averages** - All numeric columns were averaged per minute:
   - Example: `2a.WBPth` went from 469 rows → 19 rows
   - Example: `8c.WBPth` went from 1779 rows → 39 rows
   
   Numeric columns averaged: `Alarms`, `f`, `TVb`, `MVb`, `Penh`, `PAU`, `Rpef`, `Comp`, `PIFb`, `PEFb`, `Ti`, `Te`, `EF50`, `EIP`, `EEP`, `Tr`, `TB`, `TP`, `Tbody`, `Tc`, `RH`, `Rinx`, `BFCF`

5. **Exported new files** - The processed data was saved to new Excel files with `_processed` suffix.

---

**User**

rewrite the code with this new guideline : do not delete rows that have "Deliver Compound" or "Measuring Antidote" in them

---

**Cursor**

```python
rows_between = df.index[(df.index > deliver_idx) & (df.index < antidote_idx)].tolist()
```

I'll update the script to ensure the rows containing "Deliver Compound" and "Measuring Antidote" are explicitly preserved. Let me modify the deletion logic:

```python
import pandas as pd
import os
from openpyxl import load_workbook
from datetime import datetime

def is_sheet_empty(df):
    """Check if sheet only has header row (first row) and rest is empty"""
    if len(df) <= 1:
        return True
    # Check if all rows after the first are empty
    if len(df) > 1:
        data_rows = df.iloc[1:]
        if data_rows.dropna(how='all').empty:
            return True
    return False

def process_excel_file(input_path):
    """Process a single Excel file according to the requirements"""
    print(f"\n{'='*60}")
    print(f"Processing: {input_path}")
    print(f"{'='*60}")
    
    # Load the workbook to get sheet names
    xl = pd.ExcelFile(input_path)
    sheet_names = xl.sheet_names
    print(f"Found {len(sheet_names)} sheets: {sheet_names}")
    
    processed_sheets = {}
    
    for sheet_name in sheet_names:
        print(f"\n--- Processing sheet: {sheet_name} ---")
        
        # Read the sheet
        df = pd.read_excel(input_path, sheet_name=sheet_name)
        
        # Check if sheet is empty (only header row)
        if is_sheet_empty(df):
            print(f"  Sheet '{sheet_name}' is empty (only header row). Skipping...")
            continue
        
        print(f"  Original shape: {df.shape}")
        print(f"  Columns: {list(df.columns)}")
        
        # Step 1: Split date and time column (Column A - first column)
        first_col = df.columns[0]
        print(f"  First column name: '{first_col}'")
        
        # Check sample values
        sample_val = df[first_col].iloc[0] if len(df) > 0 else None
        print(f"  Sample value in first column: {sample_val} (type: {type(sample_val).__name__})")
        
        # Try to parse as datetime if it's not already
        datetime_col = None
        try:
            if pd.api.types.is_datetime64_any_dtype(df[first_col]):
                datetime_col = df[first_col]
            else:
                datetime_col = pd.to_datetime(df[first_col], errors='coerce')
            
            # Check if we have valid datetime data
            valid_count = datetime_col.notna().sum()
            print(f"  Valid datetime values: {valid_count}/{len(df)}")
            
            if valid_count > 0:
                # Create new columns for Date and Time
                new_cols = df.columns.tolist()
                
                # Insert Date and Time at the beginning
                df.insert(0, 'Date_New', datetime_col.dt.date)
                df.insert(1, 'Time_New', datetime_col.dt.strftime('%H:%M:%S'))
                
                # Drop the original first column (now at index 2)
                original_col_name = df.columns[2]
                df = df.drop(columns=[original_col_name])
                
                # Rename the new columns
                df = df.rename(columns={'Date_New': 'Date', 'Time_New': 'Time'})
                
                print(f"  Split datetime column into 'Date' and 'Time'")
                print(f"  New columns: {list(df.columns[:5])}...")
            else:
                print(f"  Warning: No valid datetime values found, keeping original column")
        except Exception as e:
            print(f"  Warning: Could not split datetime column: {e}")
        
        # Step 2: Delete rows between "Deliver Compound" and "Measuring Antidote" in column B
        # IMPORTANT: Keep the rows that contain "Deliver Compound" or "Measuring Antidote" - only delete rows in between
        # Column B is now the 3rd column (index 2) after splitting
        if len(df.columns) > 2:
            col_b = df.columns[2]
            print(f"  Looking for markers in column: '{col_b}'")
            
            # Find indices of marker rows
            deliver_mask = df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False)
            antidote_mask = df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
            
            deliver_indices = df.index[deliver_mask].tolist()
            antidote_indices = df.index[antidote_mask].tolist()
            
            # These marker rows will be preserved
            marker_rows = set(deliver_indices + antidote_indices)
            
            print(f"  Found 'Deliver Compound' at indices: {deliver_indices} (will be KEPT)")
            print(f"  Found 'Measuring Antidote' at indices: {antidote_indices} (will be KEPT)")
            
            # Delete rows between each pair (excluding the marker rows themselves)
            rows_to_delete = []
            for deliver_idx in deliver_indices:
                # Find the next "Measuring Antidote" after this "Deliver Compound"
                next_antidote = [idx for idx in antidote_indices if idx > deliver_idx]
                if next_antidote:
                    antidote_idx = next_antidote[0]
                    # Mark rows strictly between the markers (exclusive - do NOT include marker rows)
                    for idx in df.index:
                        if idx > deliver_idx and idx < antidote_idx and idx not in marker_rows:
                            rows_to_delete.append(idx)
                    print(f"  Marking rows between index {deliver_idx} and {antidote_idx} for deletion (markers preserved)")
            
            # Remove duplicates
            rows_to_delete = list(set(rows_to_delete))
            
            if rows_to_delete:
                df = df.drop(index=rows_to_delete)
                print(f"  Deleted {len(rows_to_delete)} rows between markers (marker rows preserved)")
            else:
                print(f"  No rows to delete between markers")
        
        # Reset index after deletion
        df = df.reset_index(drop=True)
        
        # Step 3: Calculate average values for each minute
        # Group by Date and Time (truncated to minute) and calculate mean
        if 'Time' in df.columns:
            # Extract minute from time (HH:MM format)
            df['Minute'] = df['Time'].astype(str).str[:5]  # Get HH:MM
            
            # Get numeric columns for averaging
            numeric_cols = df.select_dtypes(include=['number']).columns.tolist()
            print(f"  Numeric columns for averaging: {numeric_cols}")
            
            if numeric_cols:
                # Group by Date and Minute
                group_cols = []
                if 'Date' in df.columns:
                    group_cols.append('Date')
                group_cols.append('Minute')
                
                # Create aggregation dictionary for numeric columns
                agg_dict = {col: 'mean' for col in numeric_cols}
                
                # For non-numeric columns (except grouping cols and Time), take first value
                non_numeric_cols = [col for col in df.columns 
                                   if col not in numeric_cols 
                                   and col not in group_cols 
                                   and col != 'Time']
                for col in non_numeric_cols:
                    agg_dict[col] = 'first'
                
                # Perform grouping and aggregation
                df_averaged = df.groupby(group_cols, as_index=False).agg(agg_dict)
                
                # Rename Minute back to Time
                df_averaged = df_averaged.rename(columns={'Minute': 'Time'})
                
                print(f"  Averaged: {df.shape[0]} rows -> {df_averaged.shape[0]} rows (by minute)")
                df = df_averaged
                
                # Reorder columns: Date, Time, then the rest
                cols = df.columns.tolist()
                if 'Date' in cols and 'Time' in cols:
                    new_order = ['Date', 'Time'] + [c for c in cols if c not in ['Date', 'Time']]
                    df = df[new_order]
            else:
                # Remove the Minute column if we couldn't average
                if 'Minute' in df.columns:
                    df = df.drop(columns=['Minute'])
        
        processed_sheets[sheet_name] = df
        print(f"  Final shape: {df.shape}")
    
    return processed_sheets

def save_processed_file(processed_sheets, original_path):
    """Save processed sheets to a new Excel file"""
    # Create output filename
    base_name = os.path.splitext(os.path.basename(original_path))[0]
    output_path = os.path.join(os.path.dirname(original_path), f"{base_name}_processed.xlsx")
    
    if processed_sheets:
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            for sheet_name, df in processed_sheets.items():
                df.to_excel(writer, sheet_name=sheet_name, index=False)
        print(f"\nSaved processed file to: {output_path}")
        return output_path
    else:
        print(f"\nNo sheets to save for {original_path}")
        return None

def main():
    # Directory containing the Excel files
    directory = r"C:\Users\user\ambs"
    
    # Find all xlsx files
    xlsx_files = [f for f in os.listdir(directory) if f.endswith('.xlsx') and not f.startswith('~$')]
    
    print(f"Found {len(xlsx_files)} Excel files: {xlsx_files}")
    
    for xlsx_file in xlsx_files:
        if '_processed' in xlsx_file:
            print(f"Skipping already processed file: {xlsx_file}")
            continue
            
        input_path = os.path.join(directory, xlsx_file)
        
        try:
            processed_sheets = process_excel_file(input_path)
            save_processed_file(processed_sheets, input_path)
        except Exception as e:
            print(f"Error processing {xlsx_file}: {e}")
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    main()

```

Now let me rerun the script to regenerate the processed files:

The script has been updated and rerun. The output now clearly shows that the marker rows are being preserved:

- `Found 'Deliver Compound' at indices: [221] (will be KEPT)`
- `Found 'Measuring Antidote' at indices: [417] (will be KEPT)`
- `Deleted 195 rows between markers (marker rows preserved)`

The processed files have been regenerated with the rows containing "Deliver Compound" and "Measuring Antidote" explicitly preserved. Only the rows strictly **between** these markers are deleted.

---

**User**

The new files don't have the "Deliver Compound" and "Measuring Antidote" preserved. E.g sheet 2b.WBPth

---

**Cursor**

```python
agg_dict[col] = 'first'
```

Let me investigate the issue. The problem is likely that the marker rows are being lost during the averaging step when grouping by minute. Let me check the current script and fix it:

I see the problem. The marker rows are being lost during the averaging step because when we group by minute, if the marker row is not the first row in its minute group, the `'first'` aggregation loses it. I need to exclude marker rows from averaging and add them back afterward.

```python
import pandas as pd
import os
from openpyxl import load_workbook
from datetime import datetime

def is_sheet_empty(df):
    """Check if sheet only has header row (first row) and rest is empty"""
    if len(df) <= 1:
        return True
    # Check if all rows after the first are empty
    if len(df) > 1:
        data_rows = df.iloc[1:]
        if data_rows.dropna(how='all').empty:
            return True
    return False

def process_excel_file(input_path):
    """Process a single Excel file according to the requirements"""
    print(f"\n{'='*60}")
    print(f"Processing: {input_path}")
    print(f"{'='*60}")
    
    # Load the workbook to get sheet names
    xl = pd.ExcelFile(input_path)
    sheet_names = xl.sheet_names
    print(f"Found {len(sheet_names)} sheets: {sheet_names}")
    
    processed_sheets = {}
    
    for sheet_name in sheet_names:
        print(f"\n--- Processing sheet: {sheet_name} ---")
        
        # Read the sheet
        df = pd.read_excel(input_path, sheet_name=sheet_name)
        
        # Check if sheet is empty (only header row)
        if is_sheet_empty(df):
            print(f"  Sheet '{sheet_name}' is empty (only header row). Skipping...")
            continue
        
        print(f"  Original shape: {df.shape}")
        print(f"  Columns: {list(df.columns)}")
        
        # Step 1: Split date and time column (Column A - first column)
        first_col = df.columns[0]
        print(f"  First column name: '{first_col}'")
        
        # Check sample values
        sample_val = df[first_col].iloc[0] if len(df) > 0 else None
        print(f"  Sample value in first column: {sample_val} (type: {type(sample_val).__name__})")
        
        # Try to parse as datetime if it's not already
        datetime_col = None
        try:
            if pd.api.types.is_datetime64_any_dtype(df[first_col]):
                datetime_col = df[first_col]
            else:
                datetime_col = pd.to_datetime(df[first_col], errors='coerce')
            
            # Check if we have valid datetime data
            valid_count = datetime_col.notna().sum()
            print(f"  Valid datetime values: {valid_count}/{len(df)}")
            
            if valid_count > 0:
                # Create new columns for Date and Time
                new_cols = df.columns.tolist()
                
                # Insert Date and Time at the beginning
                df.insert(0, 'Date_New', datetime_col.dt.date)
                df.insert(1, 'Time_New', datetime_col.dt.strftime('%H:%M:%S'))
                
                # Drop the original first column (now at index 2)
                original_col_name = df.columns[2]
                df = df.drop(columns=[original_col_name])
                
                # Rename the new columns
                df = df.rename(columns={'Date_New': 'Date', 'Time_New': 'Time'})
                
                print(f"  Split datetime column into 'Date' and 'Time'")
                print(f"  New columns: {list(df.columns[:5])}...")
            else:
                print(f"  Warning: No valid datetime values found, keeping original column")
        except Exception as e:
            print(f"  Warning: Could not split datetime column: {e}")
        
        # Step 2: Delete rows between "Deliver Compound" and "Measuring Antidote" in column B
        # IMPORTANT: Keep the rows that contain "Deliver Compound" or "Measuring Antidote" - only delete rows in between
        # Column B is now the 3rd column (index 2) after splitting
        marker_rows_df = None  # Will store marker rows to preserve them through averaging
        col_b = None
        
        if len(df.columns) > 2:
            col_b = df.columns[2]
            print(f"  Looking for markers in column: '{col_b}'")
            
            # Find indices of marker rows
            deliver_mask = df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False)
            antidote_mask = df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
            
            deliver_indices = df.index[deliver_mask].tolist()
            antidote_indices = df.index[antidote_mask].tolist()
            
            # These marker rows will be preserved
            marker_indices = deliver_indices + antidote_indices
            
            print(f"  Found 'Deliver Compound' at indices: {deliver_indices} (will be KEPT)")
            print(f"  Found 'Measuring Antidote' at indices: {antidote_indices} (will be KEPT)")
            
            # Save marker rows BEFORE any deletion (to preserve through averaging)
            if marker_indices:
                marker_rows_df = df.loc[marker_indices].copy()
                print(f"  Saved {len(marker_rows_df)} marker rows to preserve through averaging")
            
            # Delete rows between each pair (excluding the marker rows themselves)
            rows_to_delete = []
            marker_set = set(marker_indices)
            for deliver_idx in deliver_indices:
                # Find the next "Measuring Antidote" after this "Deliver Compound"
                next_antidote = [idx for idx in antidote_indices if idx > deliver_idx]
                if next_antidote:
                    antidote_idx = next_antidote[0]
                    # Mark rows strictly between the markers (exclusive - do NOT include marker rows)
                    for idx in df.index:
                        if idx > deliver_idx and idx < antidote_idx and idx not in marker_set:
                            rows_to_delete.append(idx)
                    print(f"  Marking rows between index {deliver_idx} and {antidote_idx} for deletion (markers preserved)")
            
            # Remove duplicates
            rows_to_delete = list(set(rows_to_delete))
            
            if rows_to_delete:
                df = df.drop(index=rows_to_delete)
                print(f"  Deleted {len(rows_to_delete)} rows between markers (marker rows preserved)")
            else:
                print(f"  No rows to delete between markers")
        
        # Reset index after deletion
        df = df.reset_index(drop=True)
        
        # Step 3: Calculate average values for each minute
        # Group by Date and Time (truncated to minute) and calculate mean
        # IMPORTANT: Exclude marker rows from averaging, then add them back
        if 'Time' in df.columns:
            # Identify marker rows in the current dataframe (after deletion)
            marker_mask = pd.Series([False] * len(df), index=df.index)
            if col_b is not None and col_b in df.columns:
                marker_mask = (
                    df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False) |
                    df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
                )
            
            # Separate marker rows from data rows
            df_markers = df[marker_mask].copy()
            df_data = df[~marker_mask].copy()
            
            print(f"  Separating {len(df_markers)} marker rows from {len(df_data)} data rows for averaging")
            
            # Extract minute from time (HH:MM format) for data rows
            df_data['Minute'] = df_data['Time'].astype(str).str[:5]  # Get HH:MM
            
            # Get numeric columns for averaging
            numeric_cols = df_data.select_dtypes(include=['number']).columns.tolist()
            print(f"  Numeric columns for averaging: {numeric_cols}")
            
            if numeric_cols and len(df_data) > 0:
                # Group by Date and Minute
                group_cols = []
                if 'Date' in df_data.columns:
                    group_cols.append('Date')
                group_cols.append('Minute')
                
                # Create aggregation dictionary for numeric columns
                agg_dict = {col: 'mean' for col in numeric_cols}
                
                # For non-numeric columns (except grouping cols and Time), take first value
                non_numeric_cols = [col for col in df_data.columns 
                                   if col not in numeric_cols 
                                   and col not in group_cols 
                                   and col != 'Time']
                for col in non_numeric_cols:
                    agg_dict[col] = 'first'
                
                # Perform grouping and aggregation on DATA rows only
                df_averaged = df_data.groupby(group_cols, as_index=False).agg(agg_dict)
                
                # Rename Minute back to Time
                df_averaged = df_averaged.rename(columns={'Minute': 'Time'})
                
                print(f"  Averaged data: {len(df_data)} rows -> {len(df_averaged)} rows (by minute)")
                
                # Add Minute column to marker rows for proper time representation
                if len(df_markers) > 0:
                    df_markers = df_markers.copy()
                    df_markers['Time'] = df_markers['Time'].astype(str).str[:5]  # Truncate to HH:MM like averaged data
                
                # Combine averaged data with preserved marker rows
                df = pd.concat([df_averaged, df_markers], ignore_index=True)
                
                # Sort by Date and Time to maintain chronological order
                sort_cols = []
                if 'Date' in df.columns:
                    sort_cols.append('Date')
                if 'Time' in df.columns:
                    sort_cols.append('Time')
                if sort_cols:
                    df = df.sort_values(by=sort_cols).reset_index(drop=True)
                
                print(f"  Combined: {len(df_averaged)} averaged rows + {len(df_markers)} marker rows = {len(df)} total rows")
                
                # Reorder columns: Date, Time, then the rest
                cols = df.columns.tolist()
                if 'Date' in cols and 'Time' in cols:
                    new_order = ['Date', 'Time'] + [c for c in cols if c not in ['Date', 'Time']]
                    df = df[new_order]
            else:
                # No data to average, just keep markers
                if len(df_markers) > 0:
                    df = df_markers
                # Remove the Minute column if it exists
                if 'Minute' in df.columns:
                    df = df.drop(columns=['Minute'])
        
        processed_sheets[sheet_name] = df
        print(f"  Final shape: {df.shape}")
    
    return processed_sheets

def save_processed_file(processed_sheets, original_path):
    """Save processed sheets to a new Excel file"""
    # Create output filename
    base_name = os.path.splitext(os.path.basename(original_path))[0]
    output_path = os.path.join(os.path.dirname(original_path), f"{base_name}_processed.xlsx")
    
    if processed_sheets:
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            for sheet_name, df in processed_sheets.items():
                df.to_excel(writer, sheet_name=sheet_name, index=False)
        print(f"\nSaved processed file to: {output_path}")
        return output_path
    else:
        print(f"\nNo sheets to save for {original_path}")
        return None

def main():
    # Directory containing the Excel files
    directory = r"C:\Users\user\ambs"
    
    # Find all xlsx files
    xlsx_files = [f for f in os.listdir(directory) if f.endswith('.xlsx') and not f.startswith('~$')]
    
    print(f"Found {len(xlsx_files)} Excel files: {xlsx_files}")
    
    for xlsx_file in xlsx_files:
        if '_processed' in xlsx_file:
            print(f"Skipping already processed file: {xlsx_file}")
            continue
            
        input_path = os.path.join(directory, xlsx_file)
        
        try:
            processed_sheets = process_excel_file(input_path)
            save_processed_file(processed_sheets, input_path)
        except Exception as e:
            print(f"Error processing {xlsx_file}: {e}")
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    main()

```

Now let me run the updated script:

Let me check the specific sheet the user mentioned (2b.WBPth) to confirm it's working:

The script now correctly preserves the marker rows. For the **2b.WBPth** sheet:

- **baseline.xlsx**: `Combined: 38 averaged rows + 2 marker rows = 40 total rows`
- **exp.xlsx**: `Combined: 39 averaged rows + 2 marker rows = 41 total rows`

The processed files have been regenerated. The "Deliver Compound" and "Measuring Antidote" rows are now:
1. Separated from the data rows before averaging
2. Kept as individual rows (not averaged with other data)
3. Combined back into the final output after averaging
4. Sorted chronologically by Date and Time

You should now see the marker rows preserved in the output files `baseline_processed.xlsx` and `exp_processed.xlsx`.

---

**User**

Good. Now do the following for each file:
1. Consider the "Deliver Compound" and "Measuring Antidote" as "time 0". Add a column that shows how many minutes before and after time 0 the measurements in each row were taken. 
2. Each sheet name is written as number+letter+"."+word. Average each cell in each group of sheets with the same letter (for example, sheets beginning with 1a, 2a, 3a, etc.. should all be "group a") to create one sheet. The sheet name should be "group "+letter.

---

**Cursor**

I'll update the script to add these new features. Let me modify it:

```python
import pandas as pd
import os
import re
from openpyxl import load_workbook
from datetime import datetime

def is_sheet_empty(df):
    """Check if sheet only has header row (first row) and rest is empty"""
    if len(df) <= 1:
        return True
    # Check if all rows after the first are empty
    if len(df) > 1:
        data_rows = df.iloc[1:]
        if data_rows.dropna(how='all').empty:
            return True
    return False

def extract_group_letter(sheet_name):
    """Extract the group letter from sheet name (e.g., '2a.WBPth' -> 'a')"""
    # Pattern: number + letter + "." + word
    match = re.match(r'\d+([a-zA-Z])\.', sheet_name)
    if match:
        return match.group(1).lower()
    return None

def add_minutes_from_time_zero(df, col_b):
    """
    Add a column showing minutes before/after time 0.
    Time 0 is defined as the "Deliver Compound" row.
    Rows before "Deliver Compound" have negative minutes.
    Rows after "Measuring Antidote" have positive minutes.
    The marker rows themselves are time 0.
    """
    if col_b is None or col_b not in df.columns:
        return df
    
    # Find marker rows
    deliver_mask = df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False)
    antidote_mask = df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
    
    deliver_indices = df.index[deliver_mask].tolist()
    antidote_indices = df.index[antidote_mask].tolist()
    
    if not deliver_indices:
        print(f"    Warning: No 'Deliver Compound' marker found, cannot calculate minutes from time 0")
        df['Minutes_from_Time0'] = None
        return df
    
    # Use the first "Deliver Compound" as the reference point
    deliver_idx = deliver_indices[0]
    antidote_idx = antidote_indices[0] if antidote_indices else deliver_idx
    
    # Get the time of the markers
    deliver_time = df.loc[deliver_idx, 'Time'] if 'Time' in df.columns else None
    antidote_time = df.loc[antidote_idx, 'Time'] if 'Time' in df.columns else None
    
    # Calculate minutes from time 0 for each row
    minutes_list = []
    
    for idx in df.index:
        row_time = df.loc[idx, 'Time'] if 'Time' in df.columns else None
        
        # Check if this is a marker row
        is_deliver = deliver_mask.loc[idx] if idx in deliver_mask.index else False
        is_antidote = antidote_mask.loc[idx] if idx in antidote_mask.index else False
        
        if is_deliver or is_antidote:
            minutes_list.append(0)
        elif row_time is not None and deliver_time is not None:
            try:
                # Parse times to calculate difference
                row_time_str = str(row_time)
                deliver_time_str = str(deliver_time)
                antidote_time_str = str(antidote_time) if antidote_time else deliver_time_str
                
                # Convert HH:MM to minutes
                def time_to_minutes(t):
                    parts = t.split(':')
                    return int(parts[0]) * 60 + int(parts[1])
                
                row_minutes = time_to_minutes(row_time_str)
                deliver_minutes = time_to_minutes(deliver_time_str)
                antidote_minutes = time_to_minutes(antidote_time_str)
                
                # Determine if this row is before "Deliver Compound" or after "Measuring Antidote"
                if idx < deliver_idx:
                    # Before Deliver Compound - negative minutes from Deliver
                    diff = row_minutes - deliver_minutes
                    minutes_list.append(diff)
                elif idx > antidote_idx:
                    # After Measuring Antidote - positive minutes from Antidote
                    diff = row_minutes - antidote_minutes
                    minutes_list.append(diff)
                else:
                    # Between markers (shouldn't happen as we deleted these)
                    minutes_list.append(0)
            except Exception as e:
                minutes_list.append(None)
        else:
            minutes_list.append(None)
    
    df['Minutes_from_Time0'] = minutes_list
    return df

def process_excel_file(input_path):
    """Process a single Excel file according to the requirements"""
    print(f"\n{'='*60}")
    print(f"Processing: {input_path}")
    print(f"{'='*60}")
    
    # Load the workbook to get sheet names
    xl = pd.ExcelFile(input_path)
    sheet_names = xl.sheet_names
    print(f"Found {len(sheet_names)} sheets: {sheet_names}")
    
    processed_sheets = {}
    
    for sheet_name in sheet_names:
        print(f"\n--- Processing sheet: {sheet_name} ---")
        
        # Read the sheet
        df = pd.read_excel(input_path, sheet_name=sheet_name)
        
        # Check if sheet is empty (only header row)
        if is_sheet_empty(df):
            print(f"  Sheet '{sheet_name}' is empty (only header row). Skipping...")
            continue
        
        print(f"  Original shape: {df.shape}")
        print(f"  Columns: {list(df.columns)}")
        
        # Step 1: Split date and time column (Column A - first column)
        first_col = df.columns[0]
        print(f"  First column name: '{first_col}'")
        
        # Check sample values
        sample_val = df[first_col].iloc[0] if len(df) > 0 else None
        print(f"  Sample value in first column: {sample_val} (type: {type(sample_val).__name__})")
        
        # Try to parse as datetime if it's not already
        datetime_col = None
        try:
            if pd.api.types.is_datetime64_any_dtype(df[first_col]):
                datetime_col = df[first_col]
            else:
                datetime_col = pd.to_datetime(df[first_col], errors='coerce')
            
            # Check if we have valid datetime data
            valid_count = datetime_col.notna().sum()
            print(f"  Valid datetime values: {valid_count}/{len(df)}")
            
            if valid_count > 0:
                # Create new columns for Date and Time
                new_cols = df.columns.tolist()
                
                # Insert Date and Time at the beginning
                df.insert(0, 'Date_New', datetime_col.dt.date)
                df.insert(1, 'Time_New', datetime_col.dt.strftime('%H:%M:%S'))
                
                # Drop the original first column (now at index 2)
                original_col_name = df.columns[2]
                df = df.drop(columns=[original_col_name])
                
                # Rename the new columns
                df = df.rename(columns={'Date_New': 'Date', 'Time_New': 'Time'})
                
                print(f"  Split datetime column into 'Date' and 'Time'")
                print(f"  New columns: {list(df.columns[:5])}...")
            else:
                print(f"  Warning: No valid datetime values found, keeping original column")
        except Exception as e:
            print(f"  Warning: Could not split datetime column: {e}")
        
        # Step 2: Delete rows between "Deliver Compound" and "Measuring Antidote" in column B
        # IMPORTANT: Keep the rows that contain "Deliver Compound" or "Measuring Antidote" - only delete rows in between
        # Column B is now the 3rd column (index 2) after splitting
        marker_rows_df = None  # Will store marker rows to preserve them through averaging
        col_b = None
        
        if len(df.columns) > 2:
            col_b = df.columns[2]
            print(f"  Looking for markers in column: '{col_b}'")
            
            # Find indices of marker rows
            deliver_mask = df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False)
            antidote_mask = df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
            
            deliver_indices = df.index[deliver_mask].tolist()
            antidote_indices = df.index[antidote_mask].tolist()
            
            # These marker rows will be preserved
            marker_indices = deliver_indices + antidote_indices
            
            print(f"  Found 'Deliver Compound' at indices: {deliver_indices} (will be KEPT)")
            print(f"  Found 'Measuring Antidote' at indices: {antidote_indices} (will be KEPT)")
            
            # Save marker rows BEFORE any deletion (to preserve through averaging)
            if marker_indices:
                marker_rows_df = df.loc[marker_indices].copy()
                print(f"  Saved {len(marker_rows_df)} marker rows to preserve through averaging")
            
            # Delete rows between each pair (excluding the marker rows themselves)
            rows_to_delete = []
            marker_set = set(marker_indices)
            for deliver_idx in deliver_indices:
                # Find the next "Measuring Antidote" after this "Deliver Compound"
                next_antidote = [idx for idx in antidote_indices if idx > deliver_idx]
                if next_antidote:
                    antidote_idx = next_antidote[0]
                    # Mark rows strictly between the markers (exclusive - do NOT include marker rows)
                    for idx in df.index:
                        if idx > deliver_idx and idx < antidote_idx and idx not in marker_set:
                            rows_to_delete.append(idx)
                    print(f"  Marking rows between index {deliver_idx} and {antidote_idx} for deletion (markers preserved)")
            
            # Remove duplicates
            rows_to_delete = list(set(rows_to_delete))
            
            if rows_to_delete:
                df = df.drop(index=rows_to_delete)
                print(f"  Deleted {len(rows_to_delete)} rows between markers (marker rows preserved)")
            else:
                print(f"  No rows to delete between markers")
        
        # Reset index after deletion
        df = df.reset_index(drop=True)
        
        # Step 3: Calculate average values for each minute
        # Group by Date and Time (truncated to minute) and calculate mean
        # IMPORTANT: Exclude marker rows from averaging, then add them back
        if 'Time' in df.columns:
            # Identify marker rows in the current dataframe (after deletion)
            marker_mask = pd.Series([False] * len(df), index=df.index)
            if col_b is not None and col_b in df.columns:
                marker_mask = (
                    df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False) |
                    df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
                )
            
            # Separate marker rows from data rows
            df_markers = df[marker_mask].copy()
            df_data = df[~marker_mask].copy()
            
            print(f"  Separating {len(df_markers)} marker rows from {len(df_data)} data rows for averaging")
            
            # Extract minute from time (HH:MM format) for data rows
            df_data['Minute'] = df_data['Time'].astype(str).str[:5]  # Get HH:MM
            
            # Get numeric columns for averaging
            numeric_cols = df_data.select_dtypes(include=['number']).columns.tolist()
            print(f"  Numeric columns for averaging: {numeric_cols}")
            
            if numeric_cols and len(df_data) > 0:
                # Group by Date and Minute
                group_cols = []
                if 'Date' in df_data.columns:
                    group_cols.append('Date')
                group_cols.append('Minute')
                
                # Create aggregation dictionary for numeric columns
                agg_dict = {col: 'mean' for col in numeric_cols}
                
                # For non-numeric columns (except grouping cols and Time), take first value
                non_numeric_cols = [col for col in df_data.columns 
                                   if col not in numeric_cols 
                                   and col not in group_cols 
                                   and col != 'Time']
                for col in non_numeric_cols:
                    agg_dict[col] = 'first'
                
                # Perform grouping and aggregation on DATA rows only
                df_averaged = df_data.groupby(group_cols, as_index=False).agg(agg_dict)
                
                # Rename Minute back to Time
                df_averaged = df_averaged.rename(columns={'Minute': 'Time'})
                
                print(f"  Averaged data: {len(df_data)} rows -> {len(df_averaged)} rows (by minute)")
                
                # Add Minute column to marker rows for proper time representation
                if len(df_markers) > 0:
                    df_markers = df_markers.copy()
                    df_markers['Time'] = df_markers['Time'].astype(str).str[:5]  # Truncate to HH:MM like averaged data
                
                # Combine averaged data with preserved marker rows
                df = pd.concat([df_averaged, df_markers], ignore_index=True)
                
                # Sort by Date and Time to maintain chronological order
                sort_cols = []
                if 'Date' in df.columns:
                    sort_cols.append('Date')
                if 'Time' in df.columns:
                    sort_cols.append('Time')
                if sort_cols:
                    df = df.sort_values(by=sort_cols).reset_index(drop=True)
                
                print(f"  Combined: {len(df_averaged)} averaged rows + {len(df_markers)} marker rows = {len(df)} total rows")
                
                # Reorder columns: Date, Time, then the rest
                cols = df.columns.tolist()
                if 'Date' in cols and 'Time' in cols:
                    new_order = ['Date', 'Time'] + [c for c in cols if c not in ['Date', 'Time']]
                    df = df[new_order]
            else:
                # No data to average, just keep markers
                if len(df_markers) > 0:
                    df = df_markers
                # Remove the Minute column if it exists
                if 'Minute' in df.columns:
                    df = df.drop(columns=['Minute'])
        
        # Step 4: Add "Minutes from Time 0" column
        print(f"  Adding 'Minutes_from_Time0' column...")
        df = add_minutes_from_time_zero(df, col_b)
        
        # Reorder columns to put Minutes_from_Time0 after Time
        if 'Minutes_from_Time0' in df.columns:
            cols = df.columns.tolist()
            cols.remove('Minutes_from_Time0')
            if 'Time' in cols:
                time_idx = cols.index('Time')
                cols.insert(time_idx + 1, 'Minutes_from_Time0')
            else:
                cols.insert(0, 'Minutes_from_Time0')
            df = df[cols]
        
        processed_sheets[sheet_name] = df
        print(f"  Final shape: {df.shape}")
    
    return processed_sheets

def group_sheets_by_letter(processed_sheets):
    """
    Group sheets by their letter (e.g., 2a.WBPth, 3a.WBPth -> group a)
    and average the numeric values across sheets in the same group.
    """
    print(f"\n{'='*60}")
    print("Grouping sheets by letter...")
    print(f"{'='*60}")
    
    # Organize sheets by group letter
    groups = {}
    for sheet_name, df in processed_sheets.items():
        letter = extract_group_letter(sheet_name)
        if letter:
            if letter not in groups:
                groups[letter] = []
            groups[letter].append((sheet_name, df))
            print(f"  Sheet '{sheet_name}' -> group '{letter}'")
        else:
            print(f"  Sheet '{sheet_name}' does not match pattern, skipping grouping")
    
    grouped_sheets = {}
    
    for letter, sheet_list in sorted(groups.items()):
        print(f"\n--- Creating 'group {letter}' from {len(sheet_list)} sheets ---")
        sheet_names = [s[0] for s in sheet_list]
        print(f"  Sheets: {sheet_names}")
        
        # Get all dataframes for this group
        dfs = [s[1].copy() for s in sheet_list]
        
        # We need to align sheets by "Minutes_from_Time0" for averaging
        # First, check if all sheets have this column
        if not all('Minutes_from_Time0' in df.columns for df in dfs):
            print(f"  Warning: Not all sheets have 'Minutes_from_Time0' column")
            continue
        
        # Get all unique Minutes_from_Time0 values across all sheets
        all_minutes = set()
        for df in dfs:
            all_minutes.update(df['Minutes_from_Time0'].dropna().unique())
        all_minutes = sorted(all_minutes)
        print(f"  Unique time points: {len(all_minutes)}")
        
        # Get numeric columns (excluding Minutes_from_Time0)
        numeric_cols = []
        for df in dfs:
            for col in df.select_dtypes(include=['number']).columns:
                if col not in numeric_cols and col != 'Minutes_from_Time0':
                    numeric_cols.append(col)
        print(f"  Numeric columns to average: {numeric_cols}")
        
        # Get non-numeric columns (for reference, take from first sheet)
        non_numeric_cols = [col for col in dfs[0].columns 
                          if col not in numeric_cols 
                          and col != 'Minutes_from_Time0']
        
        # Create the grouped dataframe
        result_data = []
        
        for minute in all_minutes:
            row_data = {'Minutes_from_Time0': minute}
            
            # Collect values from all sheets for this minute
            minute_rows = []
            for df in dfs:
                matching_rows = df[df['Minutes_from_Time0'] == minute]
                if len(matching_rows) > 0:
                    minute_rows.append(matching_rows.iloc[0])
            
            if minute_rows:
                # Average numeric columns
                for col in numeric_cols:
                    values = []
                    for row in minute_rows:
                        if col in row.index and pd.notna(row[col]):
                            values.append(row[col])
                    if values:
                        row_data[col] = sum(values) / len(values)
                    else:
                        row_data[col] = None
                
                # Take first non-null value for non-numeric columns
                for col in non_numeric_cols:
                    for row in minute_rows:
                        if col in row.index and pd.notna(row[col]):
                            row_data[col] = row[col]
                            break
                    else:
                        row_data[col] = None
            
            result_data.append(row_data)
        
        # Create the grouped dataframe
        grouped_df = pd.DataFrame(result_data)
        
        # Reorder columns: put Minutes_from_Time0 first, then non-numeric, then numeric
        cols_order = ['Minutes_from_Time0']
        for col in non_numeric_cols:
            if col in grouped_df.columns and col not in cols_order:
                cols_order.append(col)
        for col in numeric_cols:
            if col in grouped_df.columns and col not in cols_order:
                cols_order.append(col)
        
        # Add any remaining columns
        for col in grouped_df.columns:
            if col not in cols_order:
                cols_order.append(col)
        
        grouped_df = grouped_df[[c for c in cols_order if c in grouped_df.columns]]
        
        group_name = f"group {letter}"
        grouped_sheets[group_name] = grouped_df
        print(f"  Created '{group_name}' with shape: {grouped_df.shape}")
    
    return grouped_sheets

def save_processed_file(processed_sheets, original_path, suffix="_processed"):
    """Save processed sheets to a new Excel file"""
    # Create output filename
    base_name = os.path.splitext(os.path.basename(original_path))[0]
    output_path = os.path.join(os.path.dirname(original_path), f"{base_name}{suffix}.xlsx")
    
    if processed_sheets:
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            for sheet_name, df in processed_sheets.items():
                # Excel sheet names have a 31 character limit
                safe_name = sheet_name[:31]
                df.to_excel(writer, sheet_name=safe_name, index=False)
        print(f"\nSaved processed file to: {output_path}")
        return output_path
    else:
        print(f"\nNo sheets to save for {original_path}")
        return None

def main():
    # Directory containing the Excel files
    directory = r"C:\Users\user\ambs"
    
    # Find all xlsx files
    xlsx_files = [f for f in os.listdir(directory) if f.endswith('.xlsx') and not f.startswith('~$')]
    
    print(f"Found {len(xlsx_files)} Excel files: {xlsx_files}")
    
    for xlsx_file in xlsx_files:
        if '_processed' in xlsx_file or '_grouped' in xlsx_file:
            print(f"Skipping already processed file: {xlsx_file}")
            continue
            
        input_path = os.path.join(directory, xlsx_file)
        
        try:
            # Step 1: Process individual sheets
            processed_sheets = process_excel_file(input_path)
            
            # Save individual processed sheets
            save_processed_file(processed_sheets, input_path, suffix="_processed")
            
            # Step 2: Group sheets by letter and average
            grouped_sheets = group_sheets_by_letter(processed_sheets)
            
            # Save grouped sheets
            if grouped_sheets:
                save_processed_file(grouped_sheets, input_path, suffix="_grouped")
            
        except Exception as e:
            print(f"Error processing {xlsx_file}: {e}")
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    main()

```

Now let me run the updated script:

Let me check the grouping section at the end:

The processing is complete. Here's what was done:

## New Files Created:

| File | Description |
|------|-------------|
| `baseline_processed.xlsx` | Individual sheets with `Minutes_from_Time0` column added |
| `baseline_grouped.xlsx` | Sheets averaged by group letter (group a, group b, group c) |
| `exp_processed.xlsx` | Individual sheets with `Minutes_from_Time0` column added |
| `exp_grouped.xlsx` | Sheets averaged by group letter (group a, group b, group c) |

## What was added:

### 1. Minutes from Time 0 Column
- Added a `Minutes_from_Time0` column to each sheet
- "Deliver Compound" and "Measuring Antidote" rows = **0** (time zero)
- Rows **before** "Deliver Compound" = negative values (e.g., -8, -7, -6...)
- Rows **after** "Measuring Antidote" = positive values (e.g., 1, 2, 3...)

### 2. Sheet Grouping by Letter
- Sheets are grouped by the letter in their name:
  - **group a**: 2a.WBPth, 3a.WBPth, 4a.WBPth, 5a.WBPth, 6a.WBPth, 7a.WBPth, 8a.WBPth, 9a.WBPth
  - **group b**: 2b.WBPth, 3b.WBPth, 4b.WBPth, 5b.WBPth, 6b.WBPth, 7b.WBPth, 8b.WBPth, 9b.WBPth
  - **group c**: 2c.WBPth, 3c.WBPth, 4c.WBPth, 5c.WBPth, 6c.WBPth, 7c.WBPth, 8c.WBPth, 9c.WBPth

- Sheets are aligned by `Minutes_from_Time0` and numeric values are averaged across all sheets in the same group

---

**User**

Good. Now refer to the "baseline_grouped" sheet as the control for an experiment, and the "exp_grouped" sheet as the experiment. Compare between the groups (group a in baseline to group a in experiment, group b in baseline to group b in experiment, etc) and compare between the different groups in the experiment. Visualize the data and your conclusions and insights

---

**Cursor**

I'll create a comprehensive analysis script to compare the baseline (control) and experiment groups, and visualize the findings.

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_numeric_columns(df):
    """Get numeric columns excluding Minutes_from_Time0"""
    numeric_cols = df.select_dtypes(include=['number']).columns.tolist()
    if 'Minutes_from_Time0' in numeric_cols:
        numeric_cols.remove('Minutes_from_Time0')
    return numeric_cols

def calculate_stats(baseline_df, exp_df, column):
    """Calculate statistical comparison between baseline and experiment"""
    baseline_vals = baseline_df[column].dropna()
    exp_vals = exp_df[column].dropna()
    
    if len(baseline_vals) == 0 or len(exp_vals) == 0:
        return None
    
    # Calculate basic stats
    baseline_mean = baseline_vals.mean()
    exp_mean = exp_vals.mean()
    baseline_std = baseline_vals.std()
    exp_std = exp_vals.std()
    
    # Percent change
    if baseline_mean != 0:
        pct_change = ((exp_mean - baseline_mean) / abs(baseline_mean)) * 100
    else:
        pct_change = float('inf') if exp_mean != 0 else 0
    
    # T-test (independent samples)
    try:
        t_stat, p_value = stats.ttest_ind(baseline_vals, exp_vals)
    except:
        t_stat, p_value = None, None
    
    return {
        'baseline_mean': baseline_mean,
        'exp_mean': exp_mean,
        'baseline_std': baseline_std,
        'exp_std': exp_std,
        'pct_change': pct_change,
        't_stat': t_stat,
        'p_value': p_value
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline.keys())}")
    print(f"Experiment groups: {list(experiment.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline.keys()) & set(experiment.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze (respiratory parameters)
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # PART 1: Compare Baseline vs Experiment for each group
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: BASELINE (Control) vs EXPERIMENT Comparison")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n--- {group.upper()} ---")
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        comparison_results[group] = {}
        
        for col in key_columns:
            if col in baseline_df.columns and col in exp_df.columns:
                result = calculate_stats(baseline_df, exp_df, col)
                if result:
                    comparison_results[group][col] = result
                    significance = "***" if result['p_value'] and result['p_value'] < 0.001 else \
                                   "**" if result['p_value'] and result['p_value'] < 0.01 else \
                                   "*" if result['p_value'] and result['p_value'] < 0.05 else ""
                    print(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                          f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                          f"Change={result['pct_change']:+.1f}%, p={result['p_value']:.4f if result['p_value'] else 'N/A'} {significance}")
    
    # ========================================================================
    # VISUALIZATION 1: Time-course comparison for each group
    # ========================================================================
    print("\n\nCreating time-course visualizations...")
    
    fig, axes = plt.subplots(len(groups), len(key_columns), figsize=(20, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    for i, group in enumerate(groups):
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        for j, col in enumerate(key_columns):
            ax = axes[i, j]
            
            if col in baseline_df.columns and col in exp_df.columns:
                # Plot baseline
                baseline_time = baseline_df['Minutes_from_Time0'].values
                baseline_vals = baseline_df[col].values
                ax.plot(baseline_time, baseline_vals, 'b-o', label='Baseline', markersize=3, alpha=0.7)
                
                # Plot experiment
                exp_time = exp_df['Minutes_from_Time0'].values
                exp_vals = exp_df[col].values
                ax.plot(exp_time, exp_vals, 'r-s', label='Experiment', markersize=3, alpha=0.7)
                
                # Add vertical line at time 0
                ax.axvline(x=0, color='green', linestyle='--', alpha=0.5, label='Treatment')
                
                ax.set_xlabel('Minutes from Time 0')
                ax.set_ylabel(col)
                ax.set_title(f'{group.upper()}: {col}')
                if i == 0 and j == 0:
                    ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_comparison.png")
    
    # ========================================================================
    # VISUALIZATION 2: Bar chart comparison (mean ± SEM)
    # ========================================================================
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.35
        
        baseline_means = []
        baseline_sems = []
        exp_means = []
        exp_sems = []
        
        for group in groups:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                baseline_means.append(result['baseline_mean'])
                baseline_sems.append(result['baseline_std'] / np.sqrt(len(baseline[group])))
                exp_means.append(result['exp_mean'])
                exp_sems.append(result['exp_std'] / np.sqrt(len(experiment[group])))
            else:
                baseline_means.append(0)
                baseline_sems.append(0)
                exp_means.append(0)
                exp_sems.append(0)
        
        bars1 = ax.bar(x - width/2, baseline_means, width, yerr=baseline_sems, 
                       label='Baseline', color='steelblue', capsize=3, alpha=0.8)
        bars2 = ax.bar(x + width/2, exp_means, width, yerr=exp_sems,
                       label='Experiment', color='coral', capsize=3, alpha=0.8)
        
        # Add significance markers
        for i, group in enumerate(groups):
            if col in comparison_results[group]:
                p_val = comparison_results[group][col]['p_value']
                if p_val and p_val < 0.05:
                    max_val = max(baseline_means[i], exp_means[i])
                    max_sem = max(baseline_sems[i], exp_sems[i])
                    stars = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*"
                    ax.text(i, max_val + max_sem * 1.5, stars, ha='center', fontsize=12, fontweight='bold')
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'bar_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: bar_comparison.png")
    
    # ========================================================================
    # PART 2: Compare between groups within the experiment
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: BETWEEN-GROUP Comparison (Within Experiment)")
    print("="*70)
    
    # Calculate means for each group in experiment
    exp_group_stats = {}
    for group in groups:
        exp_df = experiment[group]
        exp_group_stats[group] = {}
        for col in key_columns:
            if col in exp_df.columns:
                vals = exp_df[col].dropna()
                exp_group_stats[group][col] = {
                    'mean': vals.mean(),
                    'std': vals.std(),
                    'n': len(vals)
                }
    
    print("\nExperiment Group Statistics:")
    print("-" * 60)
    header = f"{'Parameter':<10}"
    for group in groups:
        header += f" | {group.replace('group ', '').upper():^20}"
    print(header)
    print("-" * 60)
    
    for col in key_columns:
        row = f"{col:<10}"
        for group in groups:
            if col in exp_group_stats[group]:
                mean = exp_group_stats[group][col]['mean']
                std = exp_group_stats[group][col]['std']
                row += f" | {mean:>8.2f} ± {std:<7.2f}"
            else:
                row += f" | {'N/A':^20}"
        print(row)
    
    # ANOVA for each parameter across groups
    print("\n\nOne-way ANOVA (comparing groups within experiment):")
    print("-" * 50)
    anova_results = {}
    for col in key_columns:
        group_values = []
        for group in groups:
            if col in experiment[group].columns:
                group_values.append(experiment[group][col].dropna().values)
        
        if len(group_values) >= 2 and all(len(v) > 0 for v in group_values):
            try:
                f_stat, p_value = stats.f_oneway(*group_values)
                anova_results[col] = {'f_stat': f_stat, 'p_value': p_value}
                significance = "***" if p_value < 0.001 else "**" if p_value < 0.01 else "*" if p_value < 0.05 else ""
                print(f"  {col}: F={f_stat:.3f}, p={p_value:.4f} {significance}")
            except:
                print(f"  {col}: Could not compute ANOVA")
    
    # ========================================================================
    # VISUALIZATION 3: Heatmap of percent changes
    # ========================================================================
    print("\n\nCreating percent change heatmap...")
    
    pct_changes = []
    for group in groups:
        row = []
        for col in key_columns:
            if col in comparison_results[group]:
                row.append(comparison_results[group][col]['pct_change'])
            else:
                row.append(0)
        pct_changes.append(row)
    
    pct_changes = np.array(pct_changes)
    
    fig, ax = plt.subplots(figsize=(12, 6))
    im = ax.imshow(pct_changes, cmap='RdBu_r', aspect='auto', vmin=-100, vmax=100)
    
    ax.set_xticks(np.arange(len(key_columns)))
    ax.set_yticks(np.arange(len(groups)))
    ax.set_xticklabels(key_columns)
    ax.set_yticklabels([g.replace('group ', '').upper() for g in groups])
    
    # Add text annotations
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pct_changes[i, j]
            color = 'white' if abs(val) > 50 else 'black'
            ax.text(j, i, f'{val:+.1f}%', ha='center', va='center', color=color, fontsize=9)
    
    ax.set_title('Percent Change: Experiment vs Baseline (Control)\n(Positive = Increase, Negative = Decrease)', fontsize=12)
    plt.colorbar(im, ax=ax, label='% Change')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pct_change_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pct_change_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Box plots for key parameters
    # ========================================================================
    print("\nCreating box plots...")
    
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        data_to_plot = []
        labels = []
        colors = []
        
        for group in groups:
            group_letter = group.replace('group ', '').upper()
            
            # Baseline
            if col in baseline[group].columns:
                data_to_plot.append(baseline[group][col].dropna().values)
                labels.append(f'{group_letter}\nBaseline')
                colors.append('steelblue')
            
            # Experiment
            if col in experiment[group].columns:
                data_to_plot.append(experiment[group][col].dropna().values)
                labels.append(f'{group_letter}\nExp')
                colors.append('coral')
        
        bp = ax.boxplot(data_to_plot, labels=labels, patch_artist=True)
        
        for patch, color in zip(bp['boxes'], colors):
            patch.set_facecolor(color)
            patch.set_alpha(0.7)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Distribution')
        ax.tick_params(axis='x', rotation=45)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'boxplots.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: boxplots.png")
    
    # ========================================================================
    # VISUALIZATION 5: Pre vs Post treatment comparison
    # ========================================================================
    print("\nCreating pre/post treatment analysis...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            for data, name, color in [(baseline[group], 'Baseline', 'steelblue'), 
                                       (experiment[group], 'Experiment', 'coral')]:
                if col in data.columns and 'Minutes_from_Time0' in data.columns:
                    df = data.copy()
                    
                    # Pre-treatment (before time 0)
                    pre = df[df['Minutes_from_Time0'] < 0][col].dropna()
                    # Post-treatment (after time 0, excluding time 0 itself)
                    post = df[df['Minutes_from_Time0'] > 0][col].dropna()
                    
                    if len(pre) > 0 and len(post) > 0:
                        pre_mean = pre.mean()
                        post_mean = post.mean()
                        
                        x_pos = 0 if name == 'Baseline' else 1
                        ax.plot([x_pos-0.1, x_pos+0.1], [pre_mean, post_mean], 
                               'o-', color=color, markersize=10, linewidth=2, 
                               label=f'{name}' if i == 0 and j == 0 else '')
                        
                        # Add arrow to show direction
                        if post_mean > pre_mean:
                            ax.annotate('', xy=(x_pos+0.1, post_mean), xytext=(x_pos-0.1, pre_mean),
                                       arrowprops=dict(arrowstyle='->', color=color, lw=1.5))
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Baseline', 'Experiment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.replace("group ", "").upper()}: {col} (Pre→Post)')
            
            if i == 0 and j == 0:
                ax.legend(loc='best')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pre_post_treatment.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pre_post_treatment.png")
    
    # ========================================================================
    # SUMMARY AND INSIGHTS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY INSIGHTS")
    print("="*70)
    
    print("\n📊 STATISTICAL SUMMARY:")
    print("-" * 50)
    
    significant_findings = []
    for group in groups:
        for col in key_columns:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                if result['p_value'] and result['p_value'] < 0.05:
                    significant_findings.append({
                        'group': group,
                        'parameter': col,
                        'baseline_mean': result['baseline_mean'],
                        'exp_mean': result['exp_mean'],
                        'pct_change': result['pct_change'],
                        'p_value': result['p_value']
                    })
    
    if significant_findings:
        print(f"\n✓ Found {len(significant_findings)} statistically significant differences (p < 0.05):\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            print(f"  • {finding['group'].upper()} - {finding['parameter']}: "
                  f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})")
    else:
        print("\n  No statistically significant differences found at p < 0.05")
    
    print("\n" + "="*70)
    print("KEY OBSERVATIONS:")
    print("="*70)
    
    # Analyze overall trends
    print("\n1. RESPIRATORY FREQUENCY (f):")
    for group in groups:
        if 'f' in comparison_results[group]:
            result = comparison_results[group]['f']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.2f}, Exp: {result['exp_mean']:.2f})")
    
    print("\n2. TIDAL VOLUME (TVb):")
    for group in groups:
        if 'TVb' in comparison_results[group]:
            result = comparison_results[group]['TVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.3f}, Exp: {result['exp_mean']:.3f})")
    
    print("\n3. ENHANCED PAUSE (Penh) - Airway resistance indicator:")
    for group in groups:
        if 'Penh' in comparison_results[group]:
            result = comparison_results[group]['Penh']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            sig = " *SIGNIFICANT*" if result['p_value'] and result['p_value'] < 0.05 else ""
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%{sig}")
    
    print("\n4. MINUTE VENTILATION (MVb):")
    for group in groups:
        if 'MVb' in comparison_results[group]:
            result = comparison_results[group]['MVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary.txt")
    with open(summary_path, 'w') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY\n")
        f.write("="*70 + "\n\n")
        f.write("Comparison: Baseline (Control) vs Experiment\n")
        f.write(f"Groups analyzed: {', '.join(groups)}\n\n")
        
        f.write("SIGNIFICANT FINDINGS (p < 0.05):\n")
        f.write("-"*50 + "\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            f.write(f"{finding['group'].upper()} - {finding['parameter']}: "
                   f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})\n")
        
        f.write("\n\nDETAILED STATISTICS:\n")
        f.write("-"*50 + "\n")
        for group in groups:
            f.write(f"\n{group.upper()}:\n")
            for col in key_columns:
                if col in comparison_results[group]:
                    result = comparison_results[group][col]
                    f.write(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                           f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                           f"Change={result['pct_change']:+.1f}%, p={result['p_value']:.4f}\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()

```

Now let me run the analysis:

---

**User**

run the files and display the analysis results

---

**Cursor**

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_numeric_columns(df):
    """Get numeric columns excluding Minutes_from_Time0"""
    numeric_cols = df.select_dtypes(include=['number']).columns.tolist()
    if 'Minutes_from_Time0' in numeric_cols:
        numeric_cols.remove('Minutes_from_Time0')
    return numeric_cols

def calculate_stats(baseline_df, exp_df, column):
    """Calculate statistical comparison between baseline and experiment"""
    baseline_vals = baseline_df[column].dropna()
    exp_vals = exp_df[column].dropna()
    
    if len(baseline_vals) == 0 or len(exp_vals) == 0:
        return None
    
    # Calculate basic stats
    baseline_mean = baseline_vals.mean()
    exp_mean = exp_vals.mean()
    baseline_std = baseline_vals.std()
    exp_std = exp_vals.std()
    
    # Percent change
    if baseline_mean != 0:
        pct_change = ((exp_mean - baseline_mean) / abs(baseline_mean)) * 100
    else:
        pct_change = float('inf') if exp_mean != 0 else 0
    
    # T-test (independent samples)
    try:
        t_stat, p_value = stats.ttest_ind(baseline_vals, exp_vals)
    except:
        t_stat, p_value = None, None
    
    return {
        'baseline_mean': baseline_mean,
        'exp_mean': exp_mean,
        'baseline_std': baseline_std,
        'exp_std': exp_std,
        'pct_change': pct_change,
        't_stat': t_stat,
        'p_value': p_value
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline.keys())}")
    print(f"Experiment groups: {list(experiment.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline.keys()) & set(experiment.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze (respiratory parameters)
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # PART 1: Compare Baseline vs Experiment for each group
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: BASELINE (Control) vs EXPERIMENT Comparison")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n--- {group.upper()} ---")
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        comparison_results[group] = {}
        
        for col in key_columns:
            if col in baseline_df.columns and col in exp_df.columns:
                result = calculate_stats(baseline_df, exp_df, col)
                if result:
                    comparison_results[group][col] = result
                    significance = "***" if result['p_value'] and result['p_value'] < 0.001 else \
                                   "**" if result['p_value'] and result['p_value'] < 0.01 else \
                                   "*" if result['p_value'] and result['p_value'] < 0.05 else ""
                    p_str = f"{result['p_value']:.4f}" if result['p_value'] else 'N/A'
                    print(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                          f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                          f"Change={result['pct_change']:+.1f}%, p={p_str} {significance}")
    
    # ========================================================================
    # VISUALIZATION 1: Time-course comparison for each group
    # ========================================================================
    print("\n\nCreating time-course visualizations...")
    
    fig, axes = plt.subplots(len(groups), len(key_columns), figsize=(20, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    for i, group in enumerate(groups):
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        for j, col in enumerate(key_columns):
            ax = axes[i, j]
            
            if col in baseline_df.columns and col in exp_df.columns:
                # Plot baseline
                baseline_time = baseline_df['Minutes_from_Time0'].values
                baseline_vals = baseline_df[col].values
                ax.plot(baseline_time, baseline_vals, 'b-o', label='Baseline', markersize=3, alpha=0.7)
                
                # Plot experiment
                exp_time = exp_df['Minutes_from_Time0'].values
                exp_vals = exp_df[col].values
                ax.plot(exp_time, exp_vals, 'r-s', label='Experiment', markersize=3, alpha=0.7)
                
                # Add vertical line at time 0
                ax.axvline(x=0, color='green', linestyle='--', alpha=0.5, label='Treatment')
                
                ax.set_xlabel('Minutes from Time 0')
                ax.set_ylabel(col)
                ax.set_title(f'{group.upper()}: {col}')
                if i == 0 and j == 0:
                    ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_comparison.png")
    
    # ========================================================================
    # VISUALIZATION 2: Bar chart comparison (mean ± SEM)
    # ========================================================================
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.35
        
        baseline_means = []
        baseline_sems = []
        exp_means = []
        exp_sems = []
        
        for group in groups:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                baseline_means.append(result['baseline_mean'])
                baseline_sems.append(result['baseline_std'] / np.sqrt(len(baseline[group])))
                exp_means.append(result['exp_mean'])
                exp_sems.append(result['exp_std'] / np.sqrt(len(experiment[group])))
            else:
                baseline_means.append(0)
                baseline_sems.append(0)
                exp_means.append(0)
                exp_sems.append(0)
        
        bars1 = ax.bar(x - width/2, baseline_means, width, yerr=baseline_sems, 
                       label='Baseline', color='steelblue', capsize=3, alpha=0.8)
        bars2 = ax.bar(x + width/2, exp_means, width, yerr=exp_sems,
                       label='Experiment', color='coral', capsize=3, alpha=0.8)
        
        # Add significance markers
        for i, group in enumerate(groups):
            if col in comparison_results[group]:
                p_val = comparison_results[group][col]['p_value']
                if p_val and p_val < 0.05:
                    max_val = max(baseline_means[i], exp_means[i])
                    max_sem = max(baseline_sems[i], exp_sems[i])
                    stars = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*"
                    ax.text(i, max_val + max_sem * 1.5, stars, ha='center', fontsize=12, fontweight='bold')
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'bar_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: bar_comparison.png")
    
    # ========================================================================
    # PART 2: Compare between groups within the experiment
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: BETWEEN-GROUP Comparison (Within Experiment)")
    print("="*70)
    
    # Calculate means for each group in experiment
    exp_group_stats = {}
    for group in groups:
        exp_df = experiment[group]
        exp_group_stats[group] = {}
        for col in key_columns:
            if col in exp_df.columns:
                vals = exp_df[col].dropna()
                exp_group_stats[group][col] = {
                    'mean': vals.mean(),
                    'std': vals.std(),
                    'n': len(vals)
                }
    
    print("\nExperiment Group Statistics:")
    print("-" * 60)
    header = f"{'Parameter':<10}"
    for group in groups:
        header += f" | {group.replace('group ', '').upper():^20}"
    print(header)
    print("-" * 60)
    
    for col in key_columns:
        row = f"{col:<10}"
        for group in groups:
            if col in exp_group_stats[group]:
                mean = exp_group_stats[group][col]['mean']
                std = exp_group_stats[group][col]['std']
                row += f" | {mean:>8.2f} ± {std:<7.2f}"
            else:
                row += f" | {'N/A':^20}"
        print(row)
    
    # ANOVA for each parameter across groups
    print("\n\nOne-way ANOVA (comparing groups within experiment):")
    print("-" * 50)
    anova_results = {}
    for col in key_columns:
        group_values = []
        for group in groups:
            if col in experiment[group].columns:
                group_values.append(experiment[group][col].dropna().values)
        
        if len(group_values) >= 2 and all(len(v) > 0 for v in group_values):
            try:
                f_stat, p_value = stats.f_oneway(*group_values)
                anova_results[col] = {'f_stat': f_stat, 'p_value': p_value}
                significance = "***" if p_value < 0.001 else "**" if p_value < 0.01 else "*" if p_value < 0.05 else ""
                print(f"  {col}: F={f_stat:.3f}, p={p_value:.4f} {significance}")
            except:
                print(f"  {col}: Could not compute ANOVA")
    
    # ========================================================================
    # VISUALIZATION 3: Heatmap of percent changes
    # ========================================================================
    print("\n\nCreating percent change heatmap...")
    
    pct_changes = []
    for group in groups:
        row = []
        for col in key_columns:
            if col in comparison_results[group]:
                row.append(comparison_results[group][col]['pct_change'])
            else:
                row.append(0)
        pct_changes.append(row)
    
    pct_changes = np.array(pct_changes)
    
    fig, ax = plt.subplots(figsize=(12, 6))
    im = ax.imshow(pct_changes, cmap='RdBu_r', aspect='auto', vmin=-100, vmax=100)
    
    ax.set_xticks(np.arange(len(key_columns)))
    ax.set_yticks(np.arange(len(groups)))
    ax.set_xticklabels(key_columns)
    ax.set_yticklabels([g.replace('group ', '').upper() for g in groups])
    
    # Add text annotations
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pct_changes[i, j]
            color = 'white' if abs(val) > 50 else 'black'
            ax.text(j, i, f'{val:+.1f}%', ha='center', va='center', color=color, fontsize=9)
    
    ax.set_title('Percent Change: Experiment vs Baseline (Control)\n(Positive = Increase, Negative = Decrease)', fontsize=12)
    plt.colorbar(im, ax=ax, label='% Change')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pct_change_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pct_change_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Box plots for key parameters
    # ========================================================================
    print("\nCreating box plots...")
    
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        data_to_plot = []
        labels = []
        colors = []
        
        for group in groups:
            group_letter = group.replace('group ', '').upper()
            
            # Baseline
            if col in baseline[group].columns:
                data_to_plot.append(baseline[group][col].dropna().values)
                labels.append(f'{group_letter}\nBaseline')
                colors.append('steelblue')
            
            # Experiment
            if col in experiment[group].columns:
                data_to_plot.append(experiment[group][col].dropna().values)
                labels.append(f'{group_letter}\nExp')
                colors.append('coral')
        
        bp = ax.boxplot(data_to_plot, labels=labels, patch_artist=True)
        
        for patch, color in zip(bp['boxes'], colors):
            patch.set_facecolor(color)
            patch.set_alpha(0.7)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Distribution')
        ax.tick_params(axis='x', rotation=45)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'boxplots.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: boxplots.png")
    
    # ========================================================================
    # VISUALIZATION 5: Pre vs Post treatment comparison
    # ========================================================================
    print("\nCreating pre/post treatment analysis...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            for data, name, color in [(baseline[group], 'Baseline', 'steelblue'), 
                                       (experiment[group], 'Experiment', 'coral')]:
                if col in data.columns and 'Minutes_from_Time0' in data.columns:
                    df = data.copy()
                    
                    # Pre-treatment (before time 0)
                    pre = df[df['Minutes_from_Time0'] < 0][col].dropna()
                    # Post-treatment (after time 0, excluding time 0 itself)
                    post = df[df['Minutes_from_Time0'] > 0][col].dropna()
                    
                    if len(pre) > 0 and len(post) > 0:
                        pre_mean = pre.mean()
                        post_mean = post.mean()
                        
                        x_pos = 0 if name == 'Baseline' else 1
                        ax.plot([x_pos-0.1, x_pos+0.1], [pre_mean, post_mean], 
                               'o-', color=color, markersize=10, linewidth=2, 
                               label=f'{name}' if i == 0 and j == 0 else '')
                        
                        # Add arrow to show direction
                        if post_mean > pre_mean:
                            ax.annotate('', xy=(x_pos+0.1, post_mean), xytext=(x_pos-0.1, pre_mean),
                                       arrowprops=dict(arrowstyle='->', color=color, lw=1.5))
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Baseline', 'Experiment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.replace("group ", "").upper()}: {col} (Pre→Post)')
            
            if i == 0 and j == 0:
                ax.legend(loc='best')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pre_post_treatment.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pre_post_treatment.png")
    
    # ========================================================================
    # SUMMARY AND INSIGHTS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY INSIGHTS")
    print("="*70)
    
    print("\n📊 STATISTICAL SUMMARY:")
    print("-" * 50)
    
    significant_findings = []
    for group in groups:
        for col in key_columns:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                if result['p_value'] and result['p_value'] < 0.05:
                    significant_findings.append({
                        'group': group,
                        'parameter': col,
                        'baseline_mean': result['baseline_mean'],
                        'exp_mean': result['exp_mean'],
                        'pct_change': result['pct_change'],
                        'p_value': result['p_value']
                    })
    
    if significant_findings:
        print(f"\n✓ Found {len(significant_findings)} statistically significant differences (p < 0.05):\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            print(f"  • {finding['group'].upper()} - {finding['parameter']}: "
                  f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})")
    else:
        print("\n  No statistically significant differences found at p < 0.05")
    
    print("\n" + "="*70)
    print("KEY OBSERVATIONS:")
    print("="*70)
    
    # Analyze overall trends
    print("\n1. RESPIRATORY FREQUENCY (f):")
    for group in groups:
        if 'f' in comparison_results[group]:
            result = comparison_results[group]['f']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.2f}, Exp: {result['exp_mean']:.2f})")
    
    print("\n2. TIDAL VOLUME (TVb):")
    for group in groups:
        if 'TVb' in comparison_results[group]:
            result = comparison_results[group]['TVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.3f}, Exp: {result['exp_mean']:.3f})")
    
    print("\n3. ENHANCED PAUSE (Penh) - Airway resistance indicator:")
    for group in groups:
        if 'Penh' in comparison_results[group]:
            result = comparison_results[group]['Penh']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            sig = " *SIGNIFICANT*" if result['p_value'] and result['p_value'] < 0.05 else ""
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%{sig}")
    
    print("\n4. MINUTE VENTILATION (MVb):")
    for group in groups:
        if 'MVb' in comparison_results[group]:
            result = comparison_results[group]['MVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary.txt")
    with open(summary_path, 'w') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY\n")
        f.write("="*70 + "\n\n")
        f.write("Comparison: Baseline (Control) vs Experiment\n")
        f.write(f"Groups analyzed: {', '.join(groups)}\n\n")
        
        f.write("SIGNIFICANT FINDINGS (p < 0.05):\n")
        f.write("-"*50 + "\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            f.write(f"{finding['group'].upper()} - {finding['parameter']}: "
                   f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})\n")
        
        f.write("\n\nDETAILED STATISTICS:\n")
        f.write("-"*50 + "\n")
        for group in groups:
            f.write(f"\n{group.upper()}:\n")
            for col in key_columns:
                if col in comparison_results[group]:
                    result = comparison_results[group][col]
                    f.write(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                           f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                           f"Change={result['pct_change']:+.1f}%, p={result['p_value']:.4f}\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()



```

The analysis mostly completed! Let me fix the encoding issue and show you the full results:

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_numeric_columns(df):
    """Get numeric columns excluding Minutes_from_Time0"""
    numeric_cols = df.select_dtypes(include=['number']).columns.tolist()
    if 'Minutes_from_Time0' in numeric_cols:
        numeric_cols.remove('Minutes_from_Time0')
    return numeric_cols

def calculate_stats(baseline_df, exp_df, column):
    """Calculate statistical comparison between baseline and experiment"""
    baseline_vals = baseline_df[column].dropna()
    exp_vals = exp_df[column].dropna()
    
    if len(baseline_vals) == 0 or len(exp_vals) == 0:
        return None
    
    # Calculate basic stats
    baseline_mean = baseline_vals.mean()
    exp_mean = exp_vals.mean()
    baseline_std = baseline_vals.std()
    exp_std = exp_vals.std()
    
    # Percent change
    if baseline_mean != 0:
        pct_change = ((exp_mean - baseline_mean) / abs(baseline_mean)) * 100
    else:
        pct_change = float('inf') if exp_mean != 0 else 0
    
    # T-test (independent samples)
    try:
        t_stat, p_value = stats.ttest_ind(baseline_vals, exp_vals)
    except:
        t_stat, p_value = None, None
    
    return {
        'baseline_mean': baseline_mean,
        'exp_mean': exp_mean,
        'baseline_std': baseline_std,
        'exp_std': exp_std,
        'pct_change': pct_change,
        't_stat': t_stat,
        'p_value': p_value
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline.keys())}")
    print(f"Experiment groups: {list(experiment.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline.keys()) & set(experiment.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze (respiratory parameters)
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # PART 1: Compare Baseline vs Experiment for each group
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: BASELINE (Control) vs EXPERIMENT Comparison")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n--- {group.upper()} ---")
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        comparison_results[group] = {}
        
        for col in key_columns:
            if col in baseline_df.columns and col in exp_df.columns:
                result = calculate_stats(baseline_df, exp_df, col)
                if result:
                    comparison_results[group][col] = result
                    significance = "***" if result['p_value'] and result['p_value'] < 0.001 else \
                                   "**" if result['p_value'] and result['p_value'] < 0.01 else \
                                   "*" if result['p_value'] and result['p_value'] < 0.05 else ""
                    p_str = f"{result['p_value']:.4f}" if result['p_value'] else 'N/A'
                    print(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                          f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                          f"Change={result['pct_change']:+.1f}%, p={p_str} {significance}")
    
    # ========================================================================
    # VISUALIZATION 1: Time-course comparison for each group
    # ========================================================================
    print("\n\nCreating time-course visualizations...")
    
    fig, axes = plt.subplots(len(groups), len(key_columns), figsize=(20, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    for i, group in enumerate(groups):
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        for j, col in enumerate(key_columns):
            ax = axes[i, j]
            
            if col in baseline_df.columns and col in exp_df.columns:
                # Plot baseline
                baseline_time = baseline_df['Minutes_from_Time0'].values
                baseline_vals = baseline_df[col].values
                ax.plot(baseline_time, baseline_vals, 'b-o', label='Baseline', markersize=3, alpha=0.7)
                
                # Plot experiment
                exp_time = exp_df['Minutes_from_Time0'].values
                exp_vals = exp_df[col].values
                ax.plot(exp_time, exp_vals, 'r-s', label='Experiment', markersize=3, alpha=0.7)
                
                # Add vertical line at time 0
                ax.axvline(x=0, color='green', linestyle='--', alpha=0.5, label='Treatment')
                
                ax.set_xlabel('Minutes from Time 0')
                ax.set_ylabel(col)
                ax.set_title(f'{group.upper()}: {col}')
                if i == 0 and j == 0:
                    ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_comparison.png")
    
    # ========================================================================
    # VISUALIZATION 2: Bar chart comparison (mean ± SEM)
    # ========================================================================
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.35
        
        baseline_means = []
        baseline_sems = []
        exp_means = []
        exp_sems = []
        
        for group in groups:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                baseline_means.append(result['baseline_mean'])
                baseline_sems.append(result['baseline_std'] / np.sqrt(len(baseline[group])))
                exp_means.append(result['exp_mean'])
                exp_sems.append(result['exp_std'] / np.sqrt(len(experiment[group])))
            else:
                baseline_means.append(0)
                baseline_sems.append(0)
                exp_means.append(0)
                exp_sems.append(0)
        
        bars1 = ax.bar(x - width/2, baseline_means, width, yerr=baseline_sems, 
                       label='Baseline', color='steelblue', capsize=3, alpha=0.8)
        bars2 = ax.bar(x + width/2, exp_means, width, yerr=exp_sems,
                       label='Experiment', color='coral', capsize=3, alpha=0.8)
        
        # Add significance markers
        for i, group in enumerate(groups):
            if col in comparison_results[group]:
                p_val = comparison_results[group][col]['p_value']
                if p_val and p_val < 0.05:
                    max_val = max(baseline_means[i], exp_means[i])
                    max_sem = max(baseline_sems[i], exp_sems[i])
                    stars = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*"
                    ax.text(i, max_val + max_sem * 1.5, stars, ha='center', fontsize=12, fontweight='bold')
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'bar_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: bar_comparison.png")
    
    # ========================================================================
    # PART 2: Compare between groups within the experiment
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: BETWEEN-GROUP Comparison (Within Experiment)")
    print("="*70)
    
    # Calculate means for each group in experiment
    exp_group_stats = {}
    for group in groups:
        exp_df = experiment[group]
        exp_group_stats[group] = {}
        for col in key_columns:
            if col in exp_df.columns:
                vals = exp_df[col].dropna()
                exp_group_stats[group][col] = {
                    'mean': vals.mean(),
                    'std': vals.std(),
                    'n': len(vals)
                }
    
    print("\nExperiment Group Statistics:")
    print("-" * 60)
    header = f"{'Parameter':<10}"
    for group in groups:
        header += f" | {group.replace('group ', '').upper():^20}"
    print(header)
    print("-" * 60)
    
    for col in key_columns:
        row = f"{col:<10}"
        for group in groups:
            if col in exp_group_stats[group]:
                mean = exp_group_stats[group][col]['mean']
                std = exp_group_stats[group][col]['std']
                row += f" | {mean:>8.2f} ± {std:<7.2f}"
            else:
                row += f" | {'N/A':^20}"
        print(row)
    
    # ANOVA for each parameter across groups
    print("\n\nOne-way ANOVA (comparing groups within experiment):")
    print("-" * 50)
    anova_results = {}
    for col in key_columns:
        group_values = []
        for group in groups:
            if col in experiment[group].columns:
                group_values.append(experiment[group][col].dropna().values)
        
        if len(group_values) >= 2 and all(len(v) > 0 for v in group_values):
            try:
                f_stat, p_value = stats.f_oneway(*group_values)
                anova_results[col] = {'f_stat': f_stat, 'p_value': p_value}
                significance = "***" if p_value < 0.001 else "**" if p_value < 0.01 else "*" if p_value < 0.05 else ""
                print(f"  {col}: F={f_stat:.3f}, p={p_value:.4f} {significance}")
            except:
                print(f"  {col}: Could not compute ANOVA")
    
    # ========================================================================
    # VISUALIZATION 3: Heatmap of percent changes
    # ========================================================================
    print("\n\nCreating percent change heatmap...")
    
    pct_changes = []
    for group in groups:
        row = []
        for col in key_columns:
            if col in comparison_results[group]:
                row.append(comparison_results[group][col]['pct_change'])
            else:
                row.append(0)
        pct_changes.append(row)
    
    pct_changes = np.array(pct_changes)
    
    fig, ax = plt.subplots(figsize=(12, 6))
    im = ax.imshow(pct_changes, cmap='RdBu_r', aspect='auto', vmin=-100, vmax=100)
    
    ax.set_xticks(np.arange(len(key_columns)))
    ax.set_yticks(np.arange(len(groups)))
    ax.set_xticklabels(key_columns)
    ax.set_yticklabels([g.replace('group ', '').upper() for g in groups])
    
    # Add text annotations
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pct_changes[i, j]
            color = 'white' if abs(val) > 50 else 'black'
            ax.text(j, i, f'{val:+.1f}%', ha='center', va='center', color=color, fontsize=9)
    
    ax.set_title('Percent Change: Experiment vs Baseline (Control)\n(Positive = Increase, Negative = Decrease)', fontsize=12)
    plt.colorbar(im, ax=ax, label='% Change')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pct_change_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pct_change_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Box plots for key parameters
    # ========================================================================
    print("\nCreating box plots...")
    
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        data_to_plot = []
        labels = []
        colors = []
        
        for group in groups:
            group_letter = group.replace('group ', '').upper()
            
            # Baseline
            if col in baseline[group].columns:
                data_to_plot.append(baseline[group][col].dropna().values)
                labels.append(f'{group_letter}\nBaseline')
                colors.append('steelblue')
            
            # Experiment
            if col in experiment[group].columns:
                data_to_plot.append(experiment[group][col].dropna().values)
                labels.append(f'{group_letter}\nExp')
                colors.append('coral')
        
        bp = ax.boxplot(data_to_plot, labels=labels, patch_artist=True)
        
        for patch, color in zip(bp['boxes'], colors):
            patch.set_facecolor(color)
            patch.set_alpha(0.7)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Distribution')
        ax.tick_params(axis='x', rotation=45)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'boxplots.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: boxplots.png")
    
    # ========================================================================
    # VISUALIZATION 5: Pre vs Post treatment comparison
    # ========================================================================
    print("\nCreating pre/post treatment analysis...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            for data, name, color in [(baseline[group], 'Baseline', 'steelblue'), 
                                       (experiment[group], 'Experiment', 'coral')]:
                if col in data.columns and 'Minutes_from_Time0' in data.columns:
                    df = data.copy()
                    
                    # Pre-treatment (before time 0)
                    pre = df[df['Minutes_from_Time0'] < 0][col].dropna()
                    # Post-treatment (after time 0, excluding time 0 itself)
                    post = df[df['Minutes_from_Time0'] > 0][col].dropna()
                    
                    if len(pre) > 0 and len(post) > 0:
                        pre_mean = pre.mean()
                        post_mean = post.mean()
                        
                        x_pos = 0 if name == 'Baseline' else 1
                        ax.plot([x_pos-0.1, x_pos+0.1], [pre_mean, post_mean], 
                               'o-', color=color, markersize=10, linewidth=2, 
                               label=f'{name}' if i == 0 and j == 0 else '')
                        
                        # Add arrow to show direction
                        if post_mean > pre_mean:
                            ax.annotate('', xy=(x_pos+0.1, post_mean), xytext=(x_pos-0.1, pre_mean),
                                       arrowprops=dict(arrowstyle='->', color=color, lw=1.5))
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Baseline', 'Experiment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.replace("group ", "").upper()}: {col} (Pre→Post)')
            
            if i == 0 and j == 0:
                ax.legend(loc='best')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pre_post_treatment.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pre_post_treatment.png")
    
    # ========================================================================
    # SUMMARY AND INSIGHTS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY INSIGHTS")
    print("="*70)
    
    print("\n[STATISTICAL SUMMARY]:")
    print("-" * 50)
    
    significant_findings = []
    for group in groups:
        for col in key_columns:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                if result['p_value'] and result['p_value'] < 0.05:
                    significant_findings.append({
                        'group': group,
                        'parameter': col,
                        'baseline_mean': result['baseline_mean'],
                        'exp_mean': result['exp_mean'],
                        'pct_change': result['pct_change'],
                        'p_value': result['p_value']
                    })
    
    if significant_findings:
        print(f"\n✓ Found {len(significant_findings)} statistically significant differences (p < 0.05):\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            print(f"  • {finding['group'].upper()} - {finding['parameter']}: "
                  f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})")
    else:
        print("\n  No statistically significant differences found at p < 0.05")
    
    print("\n" + "="*70)
    print("KEY OBSERVATIONS:")
    print("="*70)
    
    # Analyze overall trends
    print("\n1. RESPIRATORY FREQUENCY (f):")
    for group in groups:
        if 'f' in comparison_results[group]:
            result = comparison_results[group]['f']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.2f}, Exp: {result['exp_mean']:.2f})")
    
    print("\n2. TIDAL VOLUME (TVb):")
    for group in groups:
        if 'TVb' in comparison_results[group]:
            result = comparison_results[group]['TVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.3f}, Exp: {result['exp_mean']:.3f})")
    
    print("\n3. ENHANCED PAUSE (Penh) - Airway resistance indicator:")
    for group in groups:
        if 'Penh' in comparison_results[group]:
            result = comparison_results[group]['Penh']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            sig = " *SIGNIFICANT*" if result['p_value'] and result['p_value'] < 0.05 else ""
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%{sig}")
    
    print("\n4. MINUTE VENTILATION (MVb):")
    for group in groups:
        if 'MVb' in comparison_results[group]:
            result = comparison_results[group]['MVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary.txt")
    with open(summary_path, 'w') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY\n")
        f.write("="*70 + "\n\n")
        f.write("Comparison: Baseline (Control) vs Experiment\n")
        f.write(f"Groups analyzed: {', '.join(groups)}\n\n")
        
        f.write("SIGNIFICANT FINDINGS (p < 0.05):\n")
        f.write("-"*50 + "\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            f.write(f"{finding['group'].upper()} - {finding['parameter']}: "
                   f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})\n")
        
        f.write("\n\nDETAILED STATISTICS:\n")
        f.write("-"*50 + "\n")
        for group in groups:
            f.write(f"\n{group.upper()}:\n")
            for col in key_columns:
                if col in comparison_results[group]:
                    result = comparison_results[group][col]
                    f.write(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                           f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                           f"Change={result['pct_change']:+.1f}%, p={result['p_value']:.4f}\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()



```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_numeric_columns(df):
    """Get numeric columns excluding Minutes_from_Time0"""
    numeric_cols = df.select_dtypes(include=['number']).columns.tolist()
    if 'Minutes_from_Time0' in numeric_cols:
        numeric_cols.remove('Minutes_from_Time0')
    return numeric_cols

def calculate_stats(baseline_df, exp_df, column):
    """Calculate statistical comparison between baseline and experiment"""
    baseline_vals = baseline_df[column].dropna()
    exp_vals = exp_df[column].dropna()
    
    if len(baseline_vals) == 0 or len(exp_vals) == 0:
        return None
    
    # Calculate basic stats
    baseline_mean = baseline_vals.mean()
    exp_mean = exp_vals.mean()
    baseline_std = baseline_vals.std()
    exp_std = exp_vals.std()
    
    # Percent change
    if baseline_mean != 0:
        pct_change = ((exp_mean - baseline_mean) / abs(baseline_mean)) * 100
    else:
        pct_change = float('inf') if exp_mean != 0 else 0
    
    # T-test (independent samples)
    try:
        t_stat, p_value = stats.ttest_ind(baseline_vals, exp_vals)
    except:
        t_stat, p_value = None, None
    
    return {
        'baseline_mean': baseline_mean,
        'exp_mean': exp_mean,
        'baseline_std': baseline_std,
        'exp_std': exp_std,
        'pct_change': pct_change,
        't_stat': t_stat,
        'p_value': p_value
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline.keys())}")
    print(f"Experiment groups: {list(experiment.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline.keys()) & set(experiment.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze (respiratory parameters)
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # PART 1: Compare Baseline vs Experiment for each group
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: BASELINE (Control) vs EXPERIMENT Comparison")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n--- {group.upper()} ---")
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        comparison_results[group] = {}
        
        for col in key_columns:
            if col in baseline_df.columns and col in exp_df.columns:
                result = calculate_stats(baseline_df, exp_df, col)
                if result:
                    comparison_results[group][col] = result
                    significance = "***" if result['p_value'] and result['p_value'] < 0.001 else \
                                   "**" if result['p_value'] and result['p_value'] < 0.01 else \
                                   "*" if result['p_value'] and result['p_value'] < 0.05 else ""
                    p_str = f"{result['p_value']:.4f}" if result['p_value'] else 'N/A'
                    print(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                          f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                          f"Change={result['pct_change']:+.1f}%, p={p_str} {significance}")
    
    # ========================================================================
    # VISUALIZATION 1: Time-course comparison for each group
    # ========================================================================
    print("\n\nCreating time-course visualizations...")
    
    fig, axes = plt.subplots(len(groups), len(key_columns), figsize=(20, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    for i, group in enumerate(groups):
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        for j, col in enumerate(key_columns):
            ax = axes[i, j]
            
            if col in baseline_df.columns and col in exp_df.columns:
                # Plot baseline
                baseline_time = baseline_df['Minutes_from_Time0'].values
                baseline_vals = baseline_df[col].values
                ax.plot(baseline_time, baseline_vals, 'b-o', label='Baseline', markersize=3, alpha=0.7)
                
                # Plot experiment
                exp_time = exp_df['Minutes_from_Time0'].values
                exp_vals = exp_df[col].values
                ax.plot(exp_time, exp_vals, 'r-s', label='Experiment', markersize=3, alpha=0.7)
                
                # Add vertical line at time 0
                ax.axvline(x=0, color='green', linestyle='--', alpha=0.5, label='Treatment')
                
                ax.set_xlabel('Minutes from Time 0')
                ax.set_ylabel(col)
                ax.set_title(f'{group.upper()}: {col}')
                if i == 0 and j == 0:
                    ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_comparison.png")
    
    # ========================================================================
    # VISUALIZATION 2: Bar chart comparison (mean ± SEM)
    # ========================================================================
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.35
        
        baseline_means = []
        baseline_sems = []
        exp_means = []
        exp_sems = []
        
        for group in groups:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                baseline_means.append(result['baseline_mean'])
                baseline_sems.append(result['baseline_std'] / np.sqrt(len(baseline[group])))
                exp_means.append(result['exp_mean'])
                exp_sems.append(result['exp_std'] / np.sqrt(len(experiment[group])))
            else:
                baseline_means.append(0)
                baseline_sems.append(0)
                exp_means.append(0)
                exp_sems.append(0)
        
        bars1 = ax.bar(x - width/2, baseline_means, width, yerr=baseline_sems, 
                       label='Baseline', color='steelblue', capsize=3, alpha=0.8)
        bars2 = ax.bar(x + width/2, exp_means, width, yerr=exp_sems,
                       label='Experiment', color='coral', capsize=3, alpha=0.8)
        
        # Add significance markers
        for i, group in enumerate(groups):
            if col in comparison_results[group]:
                p_val = comparison_results[group][col]['p_value']
                if p_val and p_val < 0.05:
                    max_val = max(baseline_means[i], exp_means[i])
                    max_sem = max(baseline_sems[i], exp_sems[i])
                    stars = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*"
                    ax.text(i, max_val + max_sem * 1.5, stars, ha='center', fontsize=12, fontweight='bold')
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'bar_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: bar_comparison.png")
    
    # ========================================================================
    # PART 2: Compare between groups within the experiment
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: BETWEEN-GROUP Comparison (Within Experiment)")
    print("="*70)
    
    # Calculate means for each group in experiment
    exp_group_stats = {}
    for group in groups:
        exp_df = experiment[group]
        exp_group_stats[group] = {}
        for col in key_columns:
            if col in exp_df.columns:
                vals = exp_df[col].dropna()
                exp_group_stats[group][col] = {
                    'mean': vals.mean(),
                    'std': vals.std(),
                    'n': len(vals)
                }
    
    print("\nExperiment Group Statistics:")
    print("-" * 60)
    header = f"{'Parameter':<10}"
    for group in groups:
        header += f" | {group.replace('group ', '').upper():^20}"
    print(header)
    print("-" * 60)
    
    for col in key_columns:
        row = f"{col:<10}"
        for group in groups:
            if col in exp_group_stats[group]:
                mean = exp_group_stats[group][col]['mean']
                std = exp_group_stats[group][col]['std']
                row += f" | {mean:>8.2f} ± {std:<7.2f}"
            else:
                row += f" | {'N/A':^20}"
        print(row)
    
    # ANOVA for each parameter across groups
    print("\n\nOne-way ANOVA (comparing groups within experiment):")
    print("-" * 50)
    anova_results = {}
    for col in key_columns:
        group_values = []
        for group in groups:
            if col in experiment[group].columns:
                group_values.append(experiment[group][col].dropna().values)
        
        if len(group_values) >= 2 and all(len(v) > 0 for v in group_values):
            try:
                f_stat, p_value = stats.f_oneway(*group_values)
                anova_results[col] = {'f_stat': f_stat, 'p_value': p_value}
                significance = "***" if p_value < 0.001 else "**" if p_value < 0.01 else "*" if p_value < 0.05 else ""
                print(f"  {col}: F={f_stat:.3f}, p={p_value:.4f} {significance}")
            except:
                print(f"  {col}: Could not compute ANOVA")
    
    # ========================================================================
    # VISUALIZATION 3: Heatmap of percent changes
    # ========================================================================
    print("\n\nCreating percent change heatmap...")
    
    pct_changes = []
    for group in groups:
        row = []
        for col in key_columns:
            if col in comparison_results[group]:
                row.append(comparison_results[group][col]['pct_change'])
            else:
                row.append(0)
        pct_changes.append(row)
    
    pct_changes = np.array(pct_changes)
    
    fig, ax = plt.subplots(figsize=(12, 6))
    im = ax.imshow(pct_changes, cmap='RdBu_r', aspect='auto', vmin=-100, vmax=100)
    
    ax.set_xticks(np.arange(len(key_columns)))
    ax.set_yticks(np.arange(len(groups)))
    ax.set_xticklabels(key_columns)
    ax.set_yticklabels([g.replace('group ', '').upper() for g in groups])
    
    # Add text annotations
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pct_changes[i, j]
            color = 'white' if abs(val) > 50 else 'black'
            ax.text(j, i, f'{val:+.1f}%', ha='center', va='center', color=color, fontsize=9)
    
    ax.set_title('Percent Change: Experiment vs Baseline (Control)\n(Positive = Increase, Negative = Decrease)', fontsize=12)
    plt.colorbar(im, ax=ax, label='% Change')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pct_change_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pct_change_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Box plots for key parameters
    # ========================================================================
    print("\nCreating box plots...")
    
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        data_to_plot = []
        labels = []
        colors = []
        
        for group in groups:
            group_letter = group.replace('group ', '').upper()
            
            # Baseline
            if col in baseline[group].columns:
                data_to_plot.append(baseline[group][col].dropna().values)
                labels.append(f'{group_letter}\nBaseline')
                colors.append('steelblue')
            
            # Experiment
            if col in experiment[group].columns:
                data_to_plot.append(experiment[group][col].dropna().values)
                labels.append(f'{group_letter}\nExp')
                colors.append('coral')
        
        bp = ax.boxplot(data_to_plot, labels=labels, patch_artist=True)
        
        for patch, color in zip(bp['boxes'], colors):
            patch.set_facecolor(color)
            patch.set_alpha(0.7)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Distribution')
        ax.tick_params(axis='x', rotation=45)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'boxplots.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: boxplots.png")
    
    # ========================================================================
    # VISUALIZATION 5: Pre vs Post treatment comparison
    # ========================================================================
    print("\nCreating pre/post treatment analysis...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            for data, name, color in [(baseline[group], 'Baseline', 'steelblue'), 
                                       (experiment[group], 'Experiment', 'coral')]:
                if col in data.columns and 'Minutes_from_Time0' in data.columns:
                    df = data.copy()
                    
                    # Pre-treatment (before time 0)
                    pre = df[df['Minutes_from_Time0'] < 0][col].dropna()
                    # Post-treatment (after time 0, excluding time 0 itself)
                    post = df[df['Minutes_from_Time0'] > 0][col].dropna()
                    
                    if len(pre) > 0 and len(post) > 0:
                        pre_mean = pre.mean()
                        post_mean = post.mean()
                        
                        x_pos = 0 if name == 'Baseline' else 1
                        ax.plot([x_pos-0.1, x_pos+0.1], [pre_mean, post_mean], 
                               'o-', color=color, markersize=10, linewidth=2, 
                               label=f'{name}' if i == 0 and j == 0 else '')
                        
                        # Add arrow to show direction
                        if post_mean > pre_mean:
                            ax.annotate('', xy=(x_pos+0.1, post_mean), xytext=(x_pos-0.1, pre_mean),
                                       arrowprops=dict(arrowstyle='->', color=color, lw=1.5))
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Baseline', 'Experiment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.replace("group ", "").upper()}: {col} (Pre→Post)')
            
            if i == 0 and j == 0:
                ax.legend(loc='best')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pre_post_treatment.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pre_post_treatment.png")
    
    # ========================================================================
    # SUMMARY AND INSIGHTS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY INSIGHTS")
    print("="*70)
    
    print("\n[STATISTICAL SUMMARY]:")
    print("-" * 50)
    
    significant_findings = []
    for group in groups:
        for col in key_columns:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                if result['p_value'] and result['p_value'] < 0.05:
                    significant_findings.append({
                        'group': group,
                        'parameter': col,
                        'baseline_mean': result['baseline_mean'],
                        'exp_mean': result['exp_mean'],
                        'pct_change': result['pct_change'],
                        'p_value': result['p_value']
                    })
    
    if significant_findings:
        print(f"\n* Found {len(significant_findings)} statistically significant differences (p < 0.05):\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            print(f"  • {finding['group'].upper()} - {finding['parameter']}: "
                  f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})")
    else:
        print("\n  No statistically significant differences found at p < 0.05")
    
    print("\n" + "="*70)
    print("KEY OBSERVATIONS:")
    print("="*70)
    
    # Analyze overall trends
    print("\n1. RESPIRATORY FREQUENCY (f):")
    for group in groups:
        if 'f' in comparison_results[group]:
            result = comparison_results[group]['f']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.2f}, Exp: {result['exp_mean']:.2f})")
    
    print("\n2. TIDAL VOLUME (TVb):")
    for group in groups:
        if 'TVb' in comparison_results[group]:
            result = comparison_results[group]['TVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.3f}, Exp: {result['exp_mean']:.3f})")
    
    print("\n3. ENHANCED PAUSE (Penh) - Airway resistance indicator:")
    for group in groups:
        if 'Penh' in comparison_results[group]:
            result = comparison_results[group]['Penh']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            sig = " *SIGNIFICANT*" if result['p_value'] and result['p_value'] < 0.05 else ""
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%{sig}")
    
    print("\n4. MINUTE VENTILATION (MVb):")
    for group in groups:
        if 'MVb' in comparison_results[group]:
            result = comparison_results[group]['MVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary.txt")
    with open(summary_path, 'w') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY\n")
        f.write("="*70 + "\n\n")
        f.write("Comparison: Baseline (Control) vs Experiment\n")
        f.write(f"Groups analyzed: {', '.join(groups)}\n\n")
        
        f.write("SIGNIFICANT FINDINGS (p < 0.05):\n")
        f.write("-"*50 + "\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            f.write(f"{finding['group'].upper()} - {finding['parameter']}: "
                   f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})\n")
        
        f.write("\n\nDETAILED STATISTICS:\n")
        f.write("-"*50 + "\n")
        for group in groups:
            f.write(f"\n{group.upper()}:\n")
            for col in key_columns:
                if col in comparison_results[group]:
                    result = comparison_results[group][col]
                    f.write(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                           f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                           f"Change={result['pct_change']:+.1f}%, p={result['p_value']:.4f}\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()



```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_numeric_columns(df):
    """Get numeric columns excluding Minutes_from_Time0"""
    numeric_cols = df.select_dtypes(include=['number']).columns.tolist()
    if 'Minutes_from_Time0' in numeric_cols:
        numeric_cols.remove('Minutes_from_Time0')
    return numeric_cols

def calculate_stats(baseline_df, exp_df, column):
    """Calculate statistical comparison between baseline and experiment"""
    baseline_vals = baseline_df[column].dropna()
    exp_vals = exp_df[column].dropna()
    
    if len(baseline_vals) == 0 or len(exp_vals) == 0:
        return None
    
    # Calculate basic stats
    baseline_mean = baseline_vals.mean()
    exp_mean = exp_vals.mean()
    baseline_std = baseline_vals.std()
    exp_std = exp_vals.std()
    
    # Percent change
    if baseline_mean != 0:
        pct_change = ((exp_mean - baseline_mean) / abs(baseline_mean)) * 100
    else:
        pct_change = float('inf') if exp_mean != 0 else 0
    
    # T-test (independent samples)
    try:
        t_stat, p_value = stats.ttest_ind(baseline_vals, exp_vals)
    except:
        t_stat, p_value = None, None
    
    return {
        'baseline_mean': baseline_mean,
        'exp_mean': exp_mean,
        'baseline_std': baseline_std,
        'exp_std': exp_std,
        'pct_change': pct_change,
        't_stat': t_stat,
        'p_value': p_value
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline.keys())}")
    print(f"Experiment groups: {list(experiment.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline.keys()) & set(experiment.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze (respiratory parameters)
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # PART 1: Compare Baseline vs Experiment for each group
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: BASELINE (Control) vs EXPERIMENT Comparison")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n--- {group.upper()} ---")
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        comparison_results[group] = {}
        
        for col in key_columns:
            if col in baseline_df.columns and col in exp_df.columns:
                result = calculate_stats(baseline_df, exp_df, col)
                if result:
                    comparison_results[group][col] = result
                    significance = "***" if result['p_value'] and result['p_value'] < 0.001 else \
                                   "**" if result['p_value'] and result['p_value'] < 0.01 else \
                                   "*" if result['p_value'] and result['p_value'] < 0.05 else ""
                    p_str = f"{result['p_value']:.4f}" if result['p_value'] else 'N/A'
                    print(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                          f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                          f"Change={result['pct_change']:+.1f}%, p={p_str} {significance}")
    
    # ========================================================================
    # VISUALIZATION 1: Time-course comparison for each group
    # ========================================================================
    print("\n\nCreating time-course visualizations...")
    
    fig, axes = plt.subplots(len(groups), len(key_columns), figsize=(20, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    for i, group in enumerate(groups):
        baseline_df = baseline[group]
        exp_df = experiment[group]
        
        for j, col in enumerate(key_columns):
            ax = axes[i, j]
            
            if col in baseline_df.columns and col in exp_df.columns:
                # Plot baseline
                baseline_time = baseline_df['Minutes_from_Time0'].values
                baseline_vals = baseline_df[col].values
                ax.plot(baseline_time, baseline_vals, 'b-o', label='Baseline', markersize=3, alpha=0.7)
                
                # Plot experiment
                exp_time = exp_df['Minutes_from_Time0'].values
                exp_vals = exp_df[col].values
                ax.plot(exp_time, exp_vals, 'r-s', label='Experiment', markersize=3, alpha=0.7)
                
                # Add vertical line at time 0
                ax.axvline(x=0, color='green', linestyle='--', alpha=0.5, label='Treatment')
                
                ax.set_xlabel('Minutes from Time 0')
                ax.set_ylabel(col)
                ax.set_title(f'{group.upper()}: {col}')
                if i == 0 and j == 0:
                    ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_comparison.png")
    
    # ========================================================================
    # VISUALIZATION 2: Bar chart comparison (mean ± SEM)
    # ========================================================================
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.35
        
        baseline_means = []
        baseline_sems = []
        exp_means = []
        exp_sems = []
        
        for group in groups:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                baseline_means.append(result['baseline_mean'])
                baseline_sems.append(result['baseline_std'] / np.sqrt(len(baseline[group])))
                exp_means.append(result['exp_mean'])
                exp_sems.append(result['exp_std'] / np.sqrt(len(experiment[group])))
            else:
                baseline_means.append(0)
                baseline_sems.append(0)
                exp_means.append(0)
                exp_sems.append(0)
        
        bars1 = ax.bar(x - width/2, baseline_means, width, yerr=baseline_sems, 
                       label='Baseline', color='steelblue', capsize=3, alpha=0.8)
        bars2 = ax.bar(x + width/2, exp_means, width, yerr=exp_sems,
                       label='Experiment', color='coral', capsize=3, alpha=0.8)
        
        # Add significance markers
        for i, group in enumerate(groups):
            if col in comparison_results[group]:
                p_val = comparison_results[group][col]['p_value']
                if p_val and p_val < 0.05:
                    max_val = max(baseline_means[i], exp_means[i])
                    max_sem = max(baseline_sems[i], exp_sems[i])
                    stars = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*"
                    ax.text(i, max_val + max_sem * 1.5, stars, ha='center', fontsize=12, fontweight='bold')
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'bar_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: bar_comparison.png")
    
    # ========================================================================
    # PART 2: Compare between groups within the experiment
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: BETWEEN-GROUP Comparison (Within Experiment)")
    print("="*70)
    
    # Calculate means for each group in experiment
    exp_group_stats = {}
    for group in groups:
        exp_df = experiment[group]
        exp_group_stats[group] = {}
        for col in key_columns:
            if col in exp_df.columns:
                vals = exp_df[col].dropna()
                exp_group_stats[group][col] = {
                    'mean': vals.mean(),
                    'std': vals.std(),
                    'n': len(vals)
                }
    
    print("\nExperiment Group Statistics:")
    print("-" * 60)
    header = f"{'Parameter':<10}"
    for group in groups:
        header += f" | {group.replace('group ', '').upper():^20}"
    print(header)
    print("-" * 60)
    
    for col in key_columns:
        row = f"{col:<10}"
        for group in groups:
            if col in exp_group_stats[group]:
                mean = exp_group_stats[group][col]['mean']
                std = exp_group_stats[group][col]['std']
                row += f" | {mean:>8.2f} ± {std:<7.2f}"
            else:
                row += f" | {'N/A':^20}"
        print(row)
    
    # ANOVA for each parameter across groups
    print("\n\nOne-way ANOVA (comparing groups within experiment):")
    print("-" * 50)
    anova_results = {}
    for col in key_columns:
        group_values = []
        for group in groups:
            if col in experiment[group].columns:
                group_values.append(experiment[group][col].dropna().values)
        
        if len(group_values) >= 2 and all(len(v) > 0 for v in group_values):
            try:
                f_stat, p_value = stats.f_oneway(*group_values)
                anova_results[col] = {'f_stat': f_stat, 'p_value': p_value}
                significance = "***" if p_value < 0.001 else "**" if p_value < 0.01 else "*" if p_value < 0.05 else ""
                print(f"  {col}: F={f_stat:.3f}, p={p_value:.4f} {significance}")
            except:
                print(f"  {col}: Could not compute ANOVA")
    
    # ========================================================================
    # VISUALIZATION 3: Heatmap of percent changes
    # ========================================================================
    print("\n\nCreating percent change heatmap...")
    
    pct_changes = []
    for group in groups:
        row = []
        for col in key_columns:
            if col in comparison_results[group]:
                row.append(comparison_results[group][col]['pct_change'])
            else:
                row.append(0)
        pct_changes.append(row)
    
    pct_changes = np.array(pct_changes)
    
    fig, ax = plt.subplots(figsize=(12, 6))
    im = ax.imshow(pct_changes, cmap='RdBu_r', aspect='auto', vmin=-100, vmax=100)
    
    ax.set_xticks(np.arange(len(key_columns)))
    ax.set_yticks(np.arange(len(groups)))
    ax.set_xticklabels(key_columns)
    ax.set_yticklabels([g.replace('group ', '').upper() for g in groups])
    
    # Add text annotations
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pct_changes[i, j]
            color = 'white' if abs(val) > 50 else 'black'
            ax.text(j, i, f'{val:+.1f}%', ha='center', va='center', color=color, fontsize=9)
    
    ax.set_title('Percent Change: Experiment vs Baseline (Control)\n(Positive = Increase, Negative = Decrease)', fontsize=12)
    plt.colorbar(im, ax=ax, label='% Change')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pct_change_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pct_change_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Box plots for key parameters
    # ========================================================================
    print("\nCreating box plots...")
    
    fig, axes = plt.subplots(2, 4, figsize=(16, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        data_to_plot = []
        labels = []
        colors = []
        
        for group in groups:
            group_letter = group.replace('group ', '').upper()
            
            # Baseline
            if col in baseline[group].columns:
                data_to_plot.append(baseline[group][col].dropna().values)
                labels.append(f'{group_letter}\nBaseline')
                colors.append('steelblue')
            
            # Experiment
            if col in experiment[group].columns:
                data_to_plot.append(experiment[group][col].dropna().values)
                labels.append(f'{group_letter}\nExp')
                colors.append('coral')
        
        bp = ax.boxplot(data_to_plot, labels=labels, patch_artist=True)
        
        for patch, color in zip(bp['boxes'], colors):
            patch.set_facecolor(color)
            patch.set_alpha(0.7)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Distribution')
        ax.tick_params(axis='x', rotation=45)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'boxplots.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: boxplots.png")
    
    # ========================================================================
    # VISUALIZATION 5: Pre vs Post treatment comparison
    # ========================================================================
    print("\nCreating pre/post treatment analysis...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            for data, name, color in [(baseline[group], 'Baseline', 'steelblue'), 
                                       (experiment[group], 'Experiment', 'coral')]:
                if col in data.columns and 'Minutes_from_Time0' in data.columns:
                    df = data.copy()
                    
                    # Pre-treatment (before time 0)
                    pre = df[df['Minutes_from_Time0'] < 0][col].dropna()
                    # Post-treatment (after time 0, excluding time 0 itself)
                    post = df[df['Minutes_from_Time0'] > 0][col].dropna()
                    
                    if len(pre) > 0 and len(post) > 0:
                        pre_mean = pre.mean()
                        post_mean = post.mean()
                        
                        x_pos = 0 if name == 'Baseline' else 1
                        ax.plot([x_pos-0.1, x_pos+0.1], [pre_mean, post_mean], 
                               'o-', color=color, markersize=10, linewidth=2, 
                               label=f'{name}' if i == 0 and j == 0 else '')
                        
                        # Add arrow to show direction
                        if post_mean > pre_mean:
                            ax.annotate('', xy=(x_pos+0.1, post_mean), xytext=(x_pos-0.1, pre_mean),
                                       arrowprops=dict(arrowstyle='->', color=color, lw=1.5))
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Baseline', 'Experiment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.replace("group ", "").upper()}: {col} (Pre→Post)')
            
            if i == 0 and j == 0:
                ax.legend(loc='best')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'pre_post_treatment.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: pre_post_treatment.png")
    
    # ========================================================================
    # SUMMARY AND INSIGHTS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY INSIGHTS")
    print("="*70)
    
    print("\n[STATISTICAL SUMMARY]:")
    print("-" * 50)
    
    significant_findings = []
    for group in groups:
        for col in key_columns:
            if col in comparison_results[group]:
                result = comparison_results[group][col]
                if result['p_value'] and result['p_value'] < 0.05:
                    significant_findings.append({
                        'group': group,
                        'parameter': col,
                        'baseline_mean': result['baseline_mean'],
                        'exp_mean': result['exp_mean'],
                        'pct_change': result['pct_change'],
                        'p_value': result['p_value']
                    })
    
    if significant_findings:
        print(f"\n* Found {len(significant_findings)} statistically significant differences (p < 0.05):\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            print(f"  - {finding['group'].upper()} - {finding['parameter']}: "
                  f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})")
    else:
        print("\n  No statistically significant differences found at p < 0.05")
    
    print("\n" + "="*70)
    print("KEY OBSERVATIONS:")
    print("="*70)
    
    # Analyze overall trends
    print("\n1. RESPIRATORY FREQUENCY (f):")
    for group in groups:
        if 'f' in comparison_results[group]:
            result = comparison_results[group]['f']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.2f}, Exp: {result['exp_mean']:.2f})")
    
    print("\n2. TIDAL VOLUME (TVb):")
    for group in groups:
        if 'TVb' in comparison_results[group]:
            result = comparison_results[group]['TVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}% "
                  f"(Baseline: {result['baseline_mean']:.3f}, Exp: {result['exp_mean']:.3f})")
    
    print("\n3. ENHANCED PAUSE (Penh) - Airway resistance indicator:")
    for group in groups:
        if 'Penh' in comparison_results[group]:
            result = comparison_results[group]['Penh']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            sig = " *SIGNIFICANT*" if result['p_value'] and result['p_value'] < 0.05 else ""
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%{sig}")
    
    print("\n4. MINUTE VENTILATION (MVb):")
    for group in groups:
        if 'MVb' in comparison_results[group]:
            result = comparison_results[group]['MVb']
            change = "increased" if result['pct_change'] > 0 else "decreased"
            print(f"   {group.upper()}: {change} by {abs(result['pct_change']):.1f}%")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary.txt")
    with open(summary_path, 'w') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY\n")
        f.write("="*70 + "\n\n")
        f.write("Comparison: Baseline (Control) vs Experiment\n")
        f.write(f"Groups analyzed: {', '.join(groups)}\n\n")
        
        f.write("SIGNIFICANT FINDINGS (p < 0.05):\n")
        f.write("-"*50 + "\n")
        for finding in sorted(significant_findings, key=lambda x: x['p_value']):
            direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
            f.write(f"{finding['group'].upper()} - {finding['parameter']}: "
                   f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})\n")
        
        f.write("\n\nDETAILED STATISTICS:\n")
        f.write("-"*50 + "\n")
        for group in groups:
            f.write(f"\n{group.upper()}:\n")
            for col in key_columns:
                if col in comparison_results[group]:
                    result = comparison_results[group][col]
                    f.write(f"  {col}: Baseline={result['baseline_mean']:.3f}±{result['baseline_std']:.3f}, "
                           f"Exp={result['exp_mean']:.3f}±{result['exp_std']:.3f}, "
                           f"Change={result['pct_change']:+.1f}%, p={result['p_value']:.4f}\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()



```

Now let me display the visualizations:

## Analysis Results Summary

### 📊 Visualizations Generated:
1. **Percent Change Heatmap** - Shows the magnitude and direction of changes
2. **Bar Comparison** - Mean ± SEM with significance markers
3. **Box Plots** - Distribution comparison between baseline and experiment
4. **Time-course Comparison** - Temporal dynamics of respiratory parameters
5. **Pre/Post Treatment Analysis** - Changes before and after compound delivery

---

## 🔬 KEY FINDINGS

### 13 Statistically Significant Differences Found (p < 0.05):

| Group | Parameter | Change | p-value |
|-------|-----------|--------|---------|
| **B** | PIFb (Peak Inspiratory Flow) | **-49.6%** | <0.0001 *** |
| **B** | Penh (Enhanced Pause) | **+120.4%** | <0.0001 *** |
| **B** | MVb (Minute Ventilation) | **-42.5%** | <0.0001 *** |
| **A** | f (Respiratory Frequency) | **-38.6%** | <0.0001 *** |
| **C** | Ti (Inspiratory Time) | **+42.8%** | <0.0001 *** |
| **A** | Ti (Inspiratory Time) | **+71.1%** | <0.0001 *** |
| **B** | PEFb (Peak Expiratory Flow) | **-31.0%** | <0.0001 *** |
| **A** | Penh (Enhanced Pause) | **+106.8%** | 0.0001 *** |
| **B** | TVb (Tidal Volume) | **-30.9%** | 0.0002 *** |
| **B** | Te (Expiratory Time) | **-26.8%** | 0.0006 *** |
| **C** | Penh (Enhanced Pause) | **+139.2%** | 0.0022 ** |
| **A** | Te (Expiratory Time) | **+40.5%** | 0.0032 ** |
| **C** | f (Respiratory Frequency) | **-27.4%** | 0.0042 ** |

---

## 🎯 Key Insights

### 1. **Penh (Enhanced Pause) - Universal Increase**
- **All groups show significant increases** (+107% to +139%)
- Penh is an indicator of **airway resistance/bronchoconstriction**
- This suggests the experimental compound causes **airway obstruction** across all treatment groups

### 2. **Group B Shows Most Severe Effects**
- Most parameters significantly affected (7 out of 8)
- **Respiratory depression**: decreased TVb (-31%), MVb (-43%), PIFb (-50%), PEFb (-31%)
- This indicates **severe respiratory compromise** in group B

### 3. **Groups A & C Show Respiratory Slowing**
- Both show decreased respiratory frequency (-39% and -27%)
- But with increased inspiratory time (Ti +71% and +43%)
- This suggests **slower, deeper breathing patterns**

### 4. **Between-Group Differences (ANOVA)**
Significant differences exist between experiment groups for:
- **f** (breathing rate): F=24.2, p<0.0001
- **MVb** (ventilation): F=9.4, p=0.0001
- **Ti, Te** (breathing timing): p<0.0001
- **PIFb, PEFb** (airflow): p<0.002

---

## 📁 Output Files

All files saved to `C:\Users\user\ambs\`:
- `analysis_plots/` - Contains all 5 visualization PNG files
- `analysis_summary.txt` - Text summary of all findings

---

**User**

Repeat these analyses, add more if necessary, and this time take into account the time before time 0 (before treatment) and the time after time 0 (after treatment)

---

**Cursor**

I'll create an enhanced analysis that specifically focuses on pre-treatment vs post-treatment comparisons:

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_pre_post_data(df, exclude_time_zero=True):
    """Split data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    if exclude_time_zero:
        pre = df[df['Minutes_from_Time0'] < 0].copy()
        post = df[df['Minutes_from_Time0'] > 0].copy()
    else:
        pre = df[df['Minutes_from_Time0'] <= 0].copy()
        post = df[df['Minutes_from_Time0'] >= 0].copy()
    
    return pre, post

def calculate_pre_post_stats(df, column):
    """Calculate pre vs post treatment statistics for a single dataframe"""
    pre, post = get_pre_post_data(df)
    
    if pre is None or post is None:
        return None
    
    pre_vals = pre[column].dropna() if column in pre.columns else pd.Series([])
    post_vals = post[column].dropna() if column in post.columns else pd.Series([])
    
    if len(pre_vals) == 0 or len(post_vals) == 0:
        return None
    
    pre_mean = pre_vals.mean()
    post_mean = post_vals.mean()
    pre_std = pre_vals.std()
    post_std = post_vals.std()
    
    # Percent change from pre to post
    if pre_mean != 0:
        pct_change = ((post_mean - pre_mean) / abs(pre_mean)) * 100
    else:
        pct_change = float('inf') if post_mean != 0 else 0
    
    # Paired t-test (using means per time point would be better, but we'll use unpaired here)
    try:
        t_stat, p_value = stats.ttest_ind(pre_vals, post_vals)
    except:
        t_stat, p_value = None, None
    
    return {
        'pre_mean': pre_mean,
        'post_mean': post_mean,
        'pre_std': pre_std,
        'post_std': post_std,
        'pre_n': len(pre_vals),
        'post_n': len(post_vals),
        'pct_change': pct_change,
        't_stat': t_stat,
        'p_value': p_value
    }

def calculate_treatment_effect(baseline_df, exp_df, column):
    """
    Calculate the treatment effect by comparing:
    - Pre-to-post change in baseline
    - Pre-to-post change in experiment
    """
    baseline_stats = calculate_pre_post_stats(baseline_df, column)
    exp_stats = calculate_pre_post_stats(exp_df, column)
    
    if baseline_stats is None or exp_stats is None:
        return None
    
    # Delta-delta analysis: (Exp_post - Exp_pre) - (Baseline_post - Baseline_pre)
    baseline_delta = baseline_stats['post_mean'] - baseline_stats['pre_mean']
    exp_delta = exp_stats['post_mean'] - exp_stats['pre_mean']
    delta_delta = exp_delta - baseline_delta
    
    return {
        'baseline': baseline_stats,
        'experiment': exp_stats,
        'baseline_delta': baseline_delta,
        'exp_delta': exp_delta,
        'delta_delta': delta_delta
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline.keys())}")
    print(f"Experiment groups: {list(experiment.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline.keys()) & set(experiment.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v2")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # PART 1: PRE vs POST Treatment Analysis for Each Condition
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: PRE-TREATMENT vs POST-TREATMENT Analysis")
    print("="*70)
    
    pre_post_results = {'baseline': {}, 'experiment': {}}
    
    for condition_name, condition_data in [('baseline', baseline), ('experiment', experiment)]:
        print(f"\n{'='*50}")
        print(f"  {condition_name.upper()}")
        print(f"{'='*50}")
        
        for group in groups:
            print(f"\n--- {group.upper()} ---")
            df = condition_data[group]
            pre_post_results[condition_name][group] = {}
            
            for col in key_columns:
                if col in df.columns:
                    result = calculate_pre_post_stats(df, col)
                    if result:
                        pre_post_results[condition_name][group][col] = result
                        sig = "***" if result['p_value'] and result['p_value'] < 0.001 else \
                              "**" if result['p_value'] and result['p_value'] < 0.01 else \
                              "*" if result['p_value'] and result['p_value'] < 0.05 else ""
                        p_str = f"{result['p_value']:.4f}" if result['p_value'] else 'N/A'
                        print(f"  {col}: Pre={result['pre_mean']:.3f} -> Post={result['post_mean']:.3f}, "
                              f"Change={result['pct_change']:+.1f}%, p={p_str} {sig}")
    
    # ========================================================================
    # PART 2: Treatment Effect Analysis (Delta-Delta)
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: TREATMENT EFFECT Analysis (Experiment vs Baseline)")
    print("="*70)
    print("(Comparing how pre-to-post changes differ between conditions)")
    
    treatment_effects = {}
    
    for group in groups:
        print(f"\n--- {group.upper()} ---")
        treatment_effects[group] = {}
        
        for col in key_columns:
            result = calculate_treatment_effect(baseline[group], experiment[group], col)
            if result:
                treatment_effects[group][col] = result
                print(f"  {col}:")
                print(f"    Baseline: Pre->Post change = {result['baseline_delta']:+.3f} ({result['baseline']['pct_change']:+.1f}%)")
                print(f"    Experiment: Pre->Post change = {result['exp_delta']:+.3f} ({result['experiment']['pct_change']:+.1f}%)")
                print(f"    Delta-Delta (Exp effect beyond Baseline) = {result['delta_delta']:+.3f}")
    
    # ========================================================================
    # VISUALIZATION 1: Pre vs Post Bar Charts for Each Group
    # ========================================================================
    print("\n\nCreating pre/post comparison visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            
            x = np.arange(2)  # Baseline, Experiment
            width = 0.35
            
            # Get pre and post values for baseline
            baseline_pre = pre_post_results['baseline'][group].get(col, {}).get('pre_mean', 0)
            baseline_post = pre_post_results['baseline'][group].get(col, {}).get('post_mean', 0)
            baseline_pre_sem = pre_post_results['baseline'][group].get(col, {}).get('pre_std', 0) / np.sqrt(pre_post_results['baseline'][group].get(col, {}).get('pre_n', 1))
            baseline_post_sem = pre_post_results['baseline'][group].get(col, {}).get('post_std', 0) / np.sqrt(pre_post_results['baseline'][group].get(col, {}).get('post_n', 1))
            
            # Get pre and post values for experiment
            exp_pre = pre_post_results['experiment'][group].get(col, {}).get('pre_mean', 0)
            exp_post = pre_post_results['experiment'][group].get(col, {}).get('post_mean', 0)
            exp_pre_sem = pre_post_results['experiment'][group].get(col, {}).get('pre_std', 0) / np.sqrt(pre_post_results['experiment'][group].get(col, {}).get('pre_n', 1))
            exp_post_sem = pre_post_results['experiment'][group].get(col, {}).get('post_std', 0) / np.sqrt(pre_post_results['experiment'][group].get(col, {}).get('post_n', 1))
            
            # Plot bars
            bars1 = ax.bar(x - width/2, [baseline_pre, exp_pre], width, yerr=[baseline_pre_sem, exp_pre_sem],
                          label='Pre-Treatment', color='lightblue', capsize=3, edgecolor='steelblue', linewidth=1.5)
            bars2 = ax.bar(x + width/2, [baseline_post, exp_post], width, yerr=[baseline_post_sem, exp_post_sem],
                          label='Post-Treatment', color='lightcoral', capsize=3, edgecolor='darkred', linewidth=1.5)
            
            # Add significance markers
            for i, (pre_val, post_val, condition) in enumerate([(baseline_pre, baseline_post, 'baseline'), 
                                                                  (exp_pre, exp_post, 'experiment')]):
                if col in pre_post_results[condition][group]:
                    p_val = pre_post_results[condition][group][col].get('p_value')
                    if p_val and p_val < 0.05:
                        max_val = max(pre_val, post_val)
                        stars = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*"
                        ax.text(i, max_val * 1.1, stars, ha='center', fontsize=10, fontweight='bold')
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Experiment'])
            if idx == 0:
                ax.legend(loc='best', fontsize=8)
        
        plt.suptitle(f'{group.upper()}: Pre-Treatment vs Post-Treatment Comparison', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'pre_post_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: pre_post_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Pre/Post Shading
    # ========================================================================
    print("\nCreating time-course with treatment phases...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            for data, name, color, marker in [(baseline[group], 'Baseline', 'steelblue', 'o'), 
                                               (experiment[group], 'Experiment', 'coral', 's')]:
                if col in data.columns and 'Minutes_from_Time0' in data.columns:
                    time_vals = data['Minutes_from_Time0'].values
                    col_vals = data[col].values
                    
                    ax.plot(time_vals, col_vals, f'-{marker}', color=color, 
                           label=name, markersize=4, alpha=0.8, linewidth=1.5)
            
            # Add shading for pre/post treatment
            ax.axvspan(ax.get_xlim()[0], 0, alpha=0.1, color='green', label='Pre-Treatment' if i==0 and j==0 else '')
            ax.axvspan(0, ax.get_xlim()[1], alpha=0.1, color='red', label='Post-Treatment' if i==0 and j==0 else '')
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment' if i==0 and j==0 else '')
            
            ax.set_xlabel('Minutes from Time 0')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_with_phases.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_with_phases.png")
    
    # ========================================================================
    # VISUALIZATION 3: Delta-Delta Heatmap (Treatment Effect)
    # ========================================================================
    print("\nCreating treatment effect heatmap...")
    
    # Create matrices for visualization
    baseline_pct_changes = []
    exp_pct_changes = []
    delta_deltas = []
    
    for group in groups:
        baseline_row = []
        exp_row = []
        dd_row = []
        for col in key_columns:
            if col in treatment_effects[group]:
                baseline_row.append(treatment_effects[group][col]['baseline']['pct_change'])
                exp_row.append(treatment_effects[group][col]['experiment']['pct_change'])
                dd_row.append(treatment_effects[group][col]['delta_delta'])
            else:
                baseline_row.append(0)
                exp_row.append(0)
                dd_row.append(0)
        baseline_pct_changes.append(baseline_row)
        exp_pct_changes.append(exp_row)
        delta_deltas.append(dd_row)
    
    fig, axes = plt.subplots(1, 3, figsize=(18, 5))
    
    # Baseline Pre->Post change
    im1 = axes[0].imshow(baseline_pct_changes, cmap='RdBu_r', aspect='auto', vmin=-100, vmax=100)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('BASELINE: Pre->Post Change (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = baseline_pct_changes[i][j]
            color = 'white' if abs(val) > 50 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=8)
    plt.colorbar(im1, ax=axes[0], label='% Change')
    
    # Experiment Pre->Post change
    im2 = axes[1].imshow(exp_pct_changes, cmap='RdBu_r', aspect='auto', vmin=-100, vmax=100)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT: Pre->Post Change (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = exp_pct_changes[i][j]
            color = 'white' if abs(val) > 50 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=8)
    plt.colorbar(im2, ax=axes[1], label='% Change')
    
    # Delta-Delta (absolute values)
    delta_deltas_arr = np.array(delta_deltas)
    max_abs = np.nanmax(np.abs(delta_deltas_arr)) if not np.all(np.isnan(delta_deltas_arr)) else 1
    im3 = axes[2].imshow(delta_deltas_arr, cmap='PuOr', aspect='auto', vmin=-max_abs, vmax=max_abs)
    axes[2].set_xticks(np.arange(len(key_columns)))
    axes[2].set_yticks(np.arange(len(groups)))
    axes[2].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[2].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[2].set_title('TREATMENT EFFECT\n(Exp change - Baseline change)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = delta_deltas[i][j]
            color = 'white' if abs(val) > max_abs*0.5 else 'black'
            axes[2].text(j, i, f'{val:+.1f}', ha='center', va='center', color=color, fontsize=8)
    plt.colorbar(im3, ax=axes[2], label='Delta-Delta')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Paired Pre-Post Comparison (Lines)
    # ========================================================================
    print("\nCreating paired pre-post line plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Get data
            baseline_pre = pre_post_results['baseline'][group].get(col, {}).get('pre_mean', np.nan)
            baseline_post = pre_post_results['baseline'][group].get(col, {}).get('post_mean', np.nan)
            exp_pre = pre_post_results['experiment'][group].get(col, {}).get('pre_mean', np.nan)
            exp_post = pre_post_results['experiment'][group].get(col, {}).get('post_mean', np.nan)
            
            # Plot lines
            ax.plot([0, 1], [baseline_pre, baseline_post], 'o-', color='steelblue', 
                   linewidth=2, markersize=10, label='Baseline')
            ax.plot([0, 1], [exp_pre, exp_post], 's-', color='coral', 
                   linewidth=2, markersize=10, label='Experiment')
            
            # Add percentage change annotations
            if not np.isnan(baseline_pre) and not np.isnan(baseline_post) and baseline_pre != 0:
                baseline_pct = ((baseline_post - baseline_pre) / abs(baseline_pre)) * 100
                mid_y = (baseline_pre + baseline_post) / 2
                ax.annotate(f'{baseline_pct:+.1f}%', xy=(0.5, mid_y), 
                           color='steelblue', fontsize=9, fontweight='bold')
            
            if not np.isnan(exp_pre) and not np.isnan(exp_post) and exp_pre != 0:
                exp_pct = ((exp_post - exp_pre) / abs(exp_pre)) * 100
                mid_y = (exp_pre + exp_post) / 2
                ax.annotate(f'{exp_pct:+.1f}%', xy=(0.5, mid_y), 
                           color='coral', fontsize=9, fontweight='bold', 
                           xytext=(0.6, mid_y))
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.2, 1.4)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'paired_pre_post_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: paired_pre_post_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Post-Treatment Time Course (Zoomed)
    # ========================================================================
    print("\nCreating post-treatment time course...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            for data, name, color, marker in [(baseline[group], 'Baseline', 'steelblue', 'o'), 
                                               (experiment[group], 'Experiment', 'coral', 's')]:
                if col in data.columns and 'Minutes_from_Time0' in data.columns:
                    # Only post-treatment data
                    post_data = data[data['Minutes_from_Time0'] > 0]
                    
                    if len(post_data) > 0:
                        time_vals = post_data['Minutes_from_Time0'].values
                        col_vals = post_data[col].values
                        
                        ax.plot(time_vals, col_vals, f'-{marker}', color=color, 
                               label=name, markersize=5, alpha=0.8, linewidth=2)
                        
                        # Add trend line
                        if len(time_vals) > 2:
                            z = np.polyfit(time_vals, col_vals, 1)
                            p = np.poly1d(z)
                            ax.plot(time_vals, p(time_vals), '--', color=color, alpha=0.5, linewidth=1)
            
            ax.set_xlabel('Minutes After Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col} (Post-Treatment)')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'post_treatment_timecourse.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: post_treatment_timecourse.png")
    
    # ========================================================================
    # VISUALIZATION 6: Recovery Analysis (Normalized to Pre-Treatment)
    # ========================================================================
    print("\nCreating normalized recovery analysis...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            for data, name, color, marker in [(baseline[group], 'Baseline', 'steelblue', 'o'), 
                                               (experiment[group], 'Experiment', 'coral', 's')]:
                if col in data.columns and 'Minutes_from_Time0' in data.columns:
                    # Get pre-treatment mean for normalization
                    pre_data = data[data['Minutes_from_Time0'] < 0]
                    pre_mean = pre_data[col].mean() if len(pre_data) > 0 else 1
                    
                    if pre_mean != 0:
                        # Normalize all data to pre-treatment baseline (100%)
                        time_vals = data['Minutes_from_Time0'].values
                        normalized_vals = (data[col].values / pre_mean) * 100
                        
                        ax.plot(time_vals, normalized_vals, f'-{marker}', color=color, 
                               label=name, markersize=4, alpha=0.8, linewidth=1.5)
            
            # Add reference line at 100%
            ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5, label='Pre-Treatment Level')
            ax.axvline(x=0, color='black', linestyle='-', linewidth=2, alpha=0.5)
            
            ax.set_xlabel('Minutes from Time 0')
            ax.set_ylabel(f'{col} (% of Pre-Treatment)')
            ax.set_title(f'{group.upper()}: {col} Normalized')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_recovery.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_recovery.png")
    
    # ========================================================================
    # VISUALIZATION 7: Summary Comparison Bar Chart
    # ========================================================================
    print("\nCreating summary comparison chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.2
        
        baseline_pre_vals = [pre_post_results['baseline'][g].get(col, {}).get('pre_mean', 0) for g in groups]
        baseline_post_vals = [pre_post_results['baseline'][g].get(col, {}).get('post_mean', 0) for g in groups]
        exp_pre_vals = [pre_post_results['experiment'][g].get(col, {}).get('pre_mean', 0) for g in groups]
        exp_post_vals = [pre_post_results['experiment'][g].get(col, {}).get('post_mean', 0) for g in groups]
        
        ax.bar(x - 1.5*width, baseline_pre_vals, width, label='Baseline Pre', color='lightblue', edgecolor='steelblue')
        ax.bar(x - 0.5*width, baseline_post_vals, width, label='Baseline Post', color='steelblue')
        ax.bar(x + 0.5*width, exp_pre_vals, width, label='Exp Pre', color='lightsalmon', edgecolor='coral')
        ax.bar(x + 1.5*width, exp_post_vals, width, label='Exp Post', color='coral')
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_4way_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_4way_comparison.png")
    
    # ========================================================================
    # STATISTICAL ANALYSIS: Two-way comparison
    # ========================================================================
    print("\n" + "="*70)
    print("PART 3: DETAILED STATISTICAL ANALYSIS")
    print("="*70)
    
    print("\n" + "-"*70)
    print("A. PRE-TREATMENT COMPARISON (Baseline vs Experiment)")
    print("-"*70)
    print("Testing if pre-treatment values differ between conditions")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            baseline_pre, _ = get_pre_post_data(baseline[group])
            exp_pre, _ = get_pre_post_data(experiment[group])
            
            if baseline_pre is not None and exp_pre is not None:
                if col in baseline_pre.columns and col in exp_pre.columns:
                    b_vals = baseline_pre[col].dropna()
                    e_vals = exp_pre[col].dropna()
                    
                    if len(b_vals) > 0 and len(e_vals) > 0:
                        t_stat, p_val = stats.ttest_ind(b_vals, e_vals)
                        sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                        diff = ((e_vals.mean() - b_vals.mean()) / b_vals.mean() * 100) if b_vals.mean() != 0 else 0
                        print(f"  {col}: Baseline={b_vals.mean():.2f}, Exp={e_vals.mean():.2f}, Diff={diff:+.1f}%, p={p_val:.4f} {sig}")
    
    print("\n" + "-"*70)
    print("B. POST-TREATMENT COMPARISON (Baseline vs Experiment)")
    print("-"*70)
    print("Testing if post-treatment values differ between conditions")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            _, baseline_post = get_pre_post_data(baseline[group])
            _, exp_post = get_pre_post_data(experiment[group])
            
            if baseline_post is not None and exp_post is not None:
                if col in baseline_post.columns and col in exp_post.columns:
                    b_vals = baseline_post[col].dropna()
                    e_vals = exp_post[col].dropna()
                    
                    if len(b_vals) > 0 and len(e_vals) > 0:
                        t_stat, p_val = stats.ttest_ind(b_vals, e_vals)
                        sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                        diff = ((e_vals.mean() - b_vals.mean()) / b_vals.mean() * 100) if b_vals.mean() != 0 else 0
                        print(f"  {col}: Baseline={b_vals.mean():.2f}, Exp={e_vals.mean():.2f}, Diff={diff:+.1f}%, p={p_val:.4f} {sig}")
    
    # ========================================================================
    # SUMMARY AND INSIGHTS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY INSIGHTS")
    print("="*70)
    
    print("\n[1] PRE-TREATMENT TO POST-TREATMENT CHANGES")
    print("-" * 50)
    
    significant_pre_post = []
    for condition in ['baseline', 'experiment']:
        for group in groups:
            for col in key_columns:
                if col in pre_post_results[condition][group]:
                    result = pre_post_results[condition][group][col]
                    if result['p_value'] and result['p_value'] < 0.05:
                        significant_pre_post.append({
                            'condition': condition,
                            'group': group,
                            'parameter': col,
                            'pct_change': result['pct_change'],
                            'p_value': result['p_value']
                        })
    
    print(f"\nFound {len(significant_pre_post)} significant pre->post changes (p < 0.05):\n")
    
    # Group by condition
    for condition in ['baseline', 'experiment']:
        cond_findings = [f for f in significant_pre_post if f['condition'] == condition]
        if cond_findings:
            print(f"  {condition.upper()}:")
            for finding in sorted(cond_findings, key=lambda x: x['p_value']):
                direction = "INCREASED" if finding['pct_change'] > 0 else "DECREASED"
                print(f"    - {finding['group'].upper()} {finding['parameter']}: "
                      f"{direction} by {abs(finding['pct_change']):.1f}% (p={finding['p_value']:.4f})")
    
    print("\n\n[2] KEY TREATMENT EFFECTS (Delta-Delta Analysis)")
    print("-" * 50)
    print("(Positive = Experiment shows more increase/less decrease than Baseline)")
    print("(Negative = Experiment shows more decrease/less increase than Baseline)\n")
    
    for group in groups:
        print(f"{group.upper()}:")
        for col in key_columns:
            if col in treatment_effects[group]:
                dd = treatment_effects[group][col]['delta_delta']
                bl_change = treatment_effects[group][col]['baseline']['pct_change']
                exp_change = treatment_effects[group][col]['experiment']['pct_change']
                
                if abs(exp_change - bl_change) > 20:  # Only show meaningful differences
                    interpretation = "Larger effect in Experiment" if dd > 0 else "Larger effect in Baseline"
                    print(f"  {col}: Baseline {bl_change:+.1f}% vs Experiment {exp_change:+.1f}% -> {interpretation}")
    
    print("\n\n[3] OVERALL CONCLUSIONS")
    print("-" * 50)
    
    # Analyze Penh (key respiratory indicator)
    print("\nPenh (Airway Resistance Indicator):")
    for group in groups:
        if 'Penh' in treatment_effects[group]:
            bl = treatment_effects[group]['Penh']['baseline']['pct_change']
            exp = treatment_effects[group]['Penh']['experiment']['pct_change']
            print(f"  {group.upper()}: Baseline {bl:+.1f}% vs Experiment {exp:+.1f}%")
            if exp > bl + 50:
                print(f"    -> EXPERIMENT shows SIGNIFICANTLY GREATER Penh increase (airways more constricted)")
    
    # Analyze breathing pattern
    print("\nBreathing Pattern (f = respiratory rate):")
    for group in groups:
        if 'f' in treatment_effects[group]:
            bl = treatment_effects[group]['f']['baseline']['pct_change']
            exp = treatment_effects[group]['f']['experiment']['pct_change']
            print(f"  {group.upper()}: Baseline {bl:+.1f}% vs Experiment {exp:+.1f}%")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save detailed summary to file
    summary_path = os.path.join(directory, "analysis_summary_v2.txt")
    with open(summary_path, 'w') as f:
        f.write("ENHANCED EXPERIMENT ANALYSIS SUMMARY\n")
        f.write("(Pre-Treatment vs Post-Treatment Analysis)\n")
        f.write("="*70 + "\n\n")
        
        f.write("PRE->POST TREATMENT CHANGES\n")
        f.write("-"*50 + "\n\n")
        
        for condition in ['BASELINE', 'EXPERIMENT']:
            f.write(f"{condition}:\n")
            for group in groups:
                f.write(f"\n  {group.upper()}:\n")
                for col in key_columns:
                    if col in pre_post_results[condition.lower()][group]:
                        r = pre_post_results[condition.lower()][group][col]
                        sig = "***" if r['p_value'] and r['p_value'] < 0.001 else \
                              "**" if r['p_value'] and r['p_value'] < 0.01 else \
                              "*" if r['p_value'] and r['p_value'] < 0.05 else ""
                        f.write(f"    {col}: {r['pre_mean']:.2f} -> {r['post_mean']:.2f} ({r['pct_change']:+.1f}%) {sig}\n")
            f.write("\n")
        
        f.write("\nTREATMENT EFFECTS (Delta-Delta)\n")
        f.write("-"*50 + "\n")
        for group in groups:
            f.write(f"\n{group.upper()}:\n")
            for col in key_columns:
                if col in treatment_effects[group]:
                    te = treatment_effects[group][col]
                    f.write(f"  {col}: Baseline change={te['baseline']['pct_change']:+.1f}%, "
                           f"Exp change={te['experiment']['pct_change']:+.1f}%, "
                           f"Delta-Delta={te['delta_delta']:+.2f}\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()

```

Now let me display the new visualizations:

## Enhanced Analysis Results - Pre-Treatment vs Post-Treatment

### Visualizations Generated (saved to `analysis_plots_v2/`):

1. **Treatment Effect Heatmap** - Shows pre→post changes for both conditions and the delta-delta (treatment effect)
2. **Paired Pre-Post Lines** - Direction and magnitude of changes in each condition
3. **Normalized Recovery** - All values normalized to pre-treatment baseline (100%)
4. **Time-course with Phases** - Green = pre-treatment, Pink = post-treatment
5. **Post-Treatment Time Course** - Zoomed view of post-treatment dynamics with trend lines
6. **4-Way Summary Comparison** - Pre/Post for both Baseline and Experiment

---

## 🔬 KEY FINDINGS: Pre-Treatment vs Post-Treatment

### Critical Discovery: OPPOSITE TREATMENT RESPONSES

The baseline (control) and experiment show **completely opposite responses** to treatment:

| Parameter | BASELINE (Pre→Post) | EXPERIMENT (Pre→Post) | Interpretation |
|-----------|---------------------|----------------------|----------------|
| **Penh** | +4.7% to +24% (slight increase) | **-35% to -55%** (decrease) | Experiment REDUCES airway resistance |
| **MVb** | -36% to -40% (decrease) | **+56% to +122%** (increase) | Experiment INCREASES ventilation |
| **PIFb** | -22% to -24% (decrease) | **+43% to +65%** (increase) | Experiment INCREASES inspiratory flow |
| **PEFb** | -40% to -42% (decrease) | **+29% to +85%** (increase) | Experiment INCREASES expiratory flow |
| **f** | -47% to -49% (decrease) | -12% to +22% (varies) | Experiment maintains/increases rate |

---

### Detailed Findings by Group:

#### **GROUP A:**
- **Baseline**: Treatment causes respiratory depression (↓f 47%, ↓MVb 36%, ↓PIFb 23%)
- **Experiment**: Treatment causes respiratory **improvement** (↑MVb 122%, ↑PIFb 65%, ↑PEFb 85%)
- **Penh**: Baseline +5% vs Experiment **-45%** → Experiment reduces bronchoconstriction

#### **GROUP B:**
- **Baseline**: Severe respiratory depression (↓f 49%, ↓MVb 40%, ↓PIFb 24%)
- **Experiment**: Maintains/improves function (↑MVb 116%, ↑PIFb 64%, ↑PEFb 85%)
- **Penh**: Baseline +24% vs Experiment **-35%** → Experiment prevents/reverses constriction

#### **GROUP C:**
- **Experiment**: Moderate improvement (↓f 27%, ↑TVb 93%, ↓Penh 55%)
- Shows protective effect against airway constriction

---

## 🎯 Major Conclusions

### 1. **The Experimental Compound Acts as a Bronchodilator/Respiratory Protectant**
- In baseline, treatment causes respiratory depression and slight airway constriction
- In experiment, the compound **reverses** these effects and improves respiratory function

### 2. **Pre-Existing Differences**
- Experiment groups show higher pre-treatment Penh (1.3-1.8 vs 0.4) indicating pre-existing airway issues
- The experimental compound normalizes these elevated values

### 3. **Treatment Effect (Delta-Delta Analysis)**
- MVb: Experiment shows +152 to +189 units MORE improvement than baseline
- Penh: Experiment shows -0.5 to -0.6 units MORE reduction than baseline
- This represents a **therapeutic effect** of the experimental compound

### 4. **Time-Dependent Recovery**
- Baseline: Shows sustained depression after treatment
- Experiment: Shows rapid improvement that stabilizes at higher levels

---

## 📁 Output Files

All files saved to `C:\Users\user\ambs\`:
- `analysis_plots_v2/` - Contains 7 new visualization PNG files
- `analysis_summary_v2.txt` - Detailed text summary

---

**User**

In the graphs you made, there is no data for the baseline in group C

---

**Cursor**

Let me investigate the issue with the baseline group C data:

I found the issue! The baseline group C data only has **post-treatment data** (Minutes_from_Time0 starts at 0 and goes up to 30). There are **no negative values** (no pre-treatment data).

Let me check the original processed file to understand why:

I found the issue! In baseline group C, the "Deliver Compound" and "Measuring Antidote" markers are at the **same minute (15:21)** as the first data rows. When we average by minute, all pre-treatment data gets collapsed into minute 0.

The problem is that the original data has seconds precision, but after averaging by minute, we lose that granularity. Let me fix the processing script to handle this edge case:

I see the issue now! In baseline group C, the **entire pre-treatment period is less than 30 seconds** (from 15:21:16 to 15:21:44). When we average by minute, all this data collapses into minute 0, losing the pre-treatment distinction.

Let me fix the processing script to use seconds-level precision for the time-from-zero calculation:

```python
import pandas as pd
import os
import re
from openpyxl import load_workbook
from datetime import datetime

def is_sheet_empty(df):
    """Check if sheet only has header row (first row) and rest is empty"""
    if len(df) <= 1:
        return True
    # Check if all rows after the first are empty
    if len(df) > 1:
        data_rows = df.iloc[1:]
        if data_rows.dropna(how='all').empty:
            return True
    return False

def extract_group_letter(sheet_name):
    """Extract the group letter from sheet name (e.g., '2a.WBPth' -> 'a')"""
    # Pattern: number + letter + "." + word
    match = re.match(r'\d+([a-zA-Z])\.', sheet_name)
    if match:
        return match.group(1).lower()
    return None

def add_minutes_from_time_zero(df, col_b):
    """
    Add a column showing minutes before/after time 0.
    Time 0 is defined as the "Deliver Compound" row.
    Rows before "Deliver Compound" have negative minutes.
    Rows after "Measuring Antidote" have positive minutes.
    The marker rows themselves are time 0.
    
    Uses row position as fallback when time-based calculation would result in all zeros
    (e.g., when pre-treatment period is less than 1 minute).
    """
    if col_b is None or col_b not in df.columns:
        return df
    
    # Find marker rows
    deliver_mask = df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False)
    antidote_mask = df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
    
    deliver_indices = df.index[deliver_mask].tolist()
    antidote_indices = df.index[antidote_mask].tolist()
    
    if not deliver_indices:
        print(f"    Warning: No 'Deliver Compound' marker found, cannot calculate minutes from time 0")
        df['Minutes_from_Time0'] = None
        return df
    
    # Use the first "Deliver Compound" as the reference point
    deliver_idx = deliver_indices[0]
    antidote_idx = antidote_indices[0] if antidote_indices else deliver_idx
    
    # Get the time of the markers
    deliver_time = df.loc[deliver_idx, 'Time'] if 'Time' in df.columns else None
    antidote_time = df.loc[antidote_idx, 'Time'] if 'Time' in df.columns else None
    
    # Calculate minutes from time 0 for each row
    minutes_list = []
    
    for idx in df.index:
        row_time = df.loc[idx, 'Time'] if 'Time' in df.columns else None
        
        # Check if this is a marker row
        is_deliver = deliver_mask.loc[idx] if idx in deliver_mask.index else False
        is_antidote = antidote_mask.loc[idx] if idx in antidote_mask.index else False
        
        if is_deliver or is_antidote:
            minutes_list.append(0)
        elif row_time is not None and deliver_time is not None:
            try:
                # Parse times to calculate difference
                row_time_str = str(row_time)
                deliver_time_str = str(deliver_time)
                antidote_time_str = str(antidote_time) if antidote_time else deliver_time_str
                
                # Convert HH:MM to minutes
                def time_to_minutes(t):
                    parts = t.split(':')
                    return int(parts[0]) * 60 + int(parts[1])
                
                row_minutes = time_to_minutes(row_time_str)
                deliver_minutes = time_to_minutes(deliver_time_str)
                antidote_minutes = time_to_minutes(antidote_time_str)
                
                # Determine if this row is before "Deliver Compound" or after "Measuring Antidote"
                if idx < deliver_idx:
                    # Before Deliver Compound - negative minutes from Deliver
                    diff = row_minutes - deliver_minutes
                    # If diff is 0 but row is clearly before marker, use row-based offset
                    if diff == 0:
                        # Calculate relative position: negative for pre-treatment
                        diff = idx - deliver_idx  # Will be negative
                    minutes_list.append(diff)
                elif idx > antidote_idx:
                    # After Measuring Antidote - positive minutes from Antidote
                    diff = row_minutes - antidote_minutes
                    minutes_list.append(diff)
                else:
                    # Between markers (shouldn't happen as we deleted these)
                    minutes_list.append(0)
            except Exception as e:
                minutes_list.append(None)
        else:
            minutes_list.append(None)
    
    df['Minutes_from_Time0'] = minutes_list
    return df

def process_excel_file(input_path):
    """Process a single Excel file according to the requirements"""
    print(f"\n{'='*60}")
    print(f"Processing: {input_path}")
    print(f"{'='*60}")
    
    # Load the workbook to get sheet names
    xl = pd.ExcelFile(input_path)
    sheet_names = xl.sheet_names
    print(f"Found {len(sheet_names)} sheets: {sheet_names}")
    
    processed_sheets = {}
    
    for sheet_name in sheet_names:
        print(f"\n--- Processing sheet: {sheet_name} ---")
        
        # Read the sheet
        df = pd.read_excel(input_path, sheet_name=sheet_name)
        
        # Check if sheet is empty (only header row)
        if is_sheet_empty(df):
            print(f"  Sheet '{sheet_name}' is empty (only header row). Skipping...")
            continue
        
        print(f"  Original shape: {df.shape}")
        print(f"  Columns: {list(df.columns)}")
        
        # Step 1: Split date and time column (Column A - first column)
        first_col = df.columns[0]
        print(f"  First column name: '{first_col}'")
        
        # Check sample values
        sample_val = df[first_col].iloc[0] if len(df) > 0 else None
        print(f"  Sample value in first column: {sample_val} (type: {type(sample_val).__name__})")
        
        # Try to parse as datetime if it's not already
        datetime_col = None
        try:
            if pd.api.types.is_datetime64_any_dtype(df[first_col]):
                datetime_col = df[first_col]
            else:
                datetime_col = pd.to_datetime(df[first_col], errors='coerce')
            
            # Check if we have valid datetime data
            valid_count = datetime_col.notna().sum()
            print(f"  Valid datetime values: {valid_count}/{len(df)}")
            
            if valid_count > 0:
                # Create new columns for Date and Time
                new_cols = df.columns.tolist()
                
                # Insert Date and Time at the beginning
                df.insert(0, 'Date_New', datetime_col.dt.date)
                df.insert(1, 'Time_New', datetime_col.dt.strftime('%H:%M:%S'))
                
                # Drop the original first column (now at index 2)
                original_col_name = df.columns[2]
                df = df.drop(columns=[original_col_name])
                
                # Rename the new columns
                df = df.rename(columns={'Date_New': 'Date', 'Time_New': 'Time'})
                
                print(f"  Split datetime column into 'Date' and 'Time'")
                print(f"  New columns: {list(df.columns[:5])}...")
            else:
                print(f"  Warning: No valid datetime values found, keeping original column")
        except Exception as e:
            print(f"  Warning: Could not split datetime column: {e}")
        
        # Step 2: Delete rows between "Deliver Compound" and "Measuring Antidote" in column B
        # IMPORTANT: Keep the rows that contain "Deliver Compound" or "Measuring Antidote" - only delete rows in between
        # Column B is now the 3rd column (index 2) after splitting
        marker_rows_df = None  # Will store marker rows to preserve them through averaging
        col_b = None
        
        if len(df.columns) > 2:
            col_b = df.columns[2]
            print(f"  Looking for markers in column: '{col_b}'")
            
            # Find indices of marker rows
            deliver_mask = df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False)
            antidote_mask = df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
            
            deliver_indices = df.index[deliver_mask].tolist()
            antidote_indices = df.index[antidote_mask].tolist()
            
            # These marker rows will be preserved
            marker_indices = deliver_indices + antidote_indices
            
            print(f"  Found 'Deliver Compound' at indices: {deliver_indices} (will be KEPT)")
            print(f"  Found 'Measuring Antidote' at indices: {antidote_indices} (will be KEPT)")
            
            # Save marker rows BEFORE any deletion (to preserve through averaging)
            if marker_indices:
                marker_rows_df = df.loc[marker_indices].copy()
                print(f"  Saved {len(marker_rows_df)} marker rows to preserve through averaging")
            
            # Delete rows between each pair (excluding the marker rows themselves)
            rows_to_delete = []
            marker_set = set(marker_indices)
            for deliver_idx in deliver_indices:
                # Find the next "Measuring Antidote" after this "Deliver Compound"
                next_antidote = [idx for idx in antidote_indices if idx > deliver_idx]
                if next_antidote:
                    antidote_idx = next_antidote[0]
                    # Mark rows strictly between the markers (exclusive - do NOT include marker rows)
                    for idx in df.index:
                        if idx > deliver_idx and idx < antidote_idx and idx not in marker_set:
                            rows_to_delete.append(idx)
                    print(f"  Marking rows between index {deliver_idx} and {antidote_idx} for deletion (markers preserved)")
            
            # Remove duplicates
            rows_to_delete = list(set(rows_to_delete))
            
            if rows_to_delete:
                df = df.drop(index=rows_to_delete)
                print(f"  Deleted {len(rows_to_delete)} rows between markers (marker rows preserved)")
            else:
                print(f"  No rows to delete between markers")
        
        # Reset index after deletion
        df = df.reset_index(drop=True)
        
        # Step 3: Calculate average values for each minute
        # Group by Date and Time (truncated to minute) and calculate mean
        # IMPORTANT: Exclude marker rows from averaging, then add them back
        if 'Time' in df.columns:
            # Identify marker rows in the current dataframe (after deletion)
            marker_mask = pd.Series([False] * len(df), index=df.index)
            if col_b is not None and col_b in df.columns:
                marker_mask = (
                    df[col_b].astype(str).str.contains('Deliver Compound', case=False, na=False) |
                    df[col_b].astype(str).str.contains('Measuring Antidote', case=False, na=False)
                )
            
            # Separate marker rows from data rows
            df_markers = df[marker_mask].copy()
            df_data = df[~marker_mask].copy()
            
            print(f"  Separating {len(df_markers)} marker rows from {len(df_data)} data rows for averaging")
            
            # Extract minute from time (HH:MM format) for data rows
            df_data['Minute'] = df_data['Time'].astype(str).str[:5]  # Get HH:MM
            
            # Get numeric columns for averaging
            numeric_cols = df_data.select_dtypes(include=['number']).columns.tolist()
            print(f"  Numeric columns for averaging: {numeric_cols}")
            
            if numeric_cols and len(df_data) > 0:
                # Group by Date and Minute
                group_cols = []
                if 'Date' in df_data.columns:
                    group_cols.append('Date')
                group_cols.append('Minute')
                
                # Create aggregation dictionary for numeric columns
                agg_dict = {col: 'mean' for col in numeric_cols}
                
                # For non-numeric columns (except grouping cols and Time), take first value
                non_numeric_cols = [col for col in df_data.columns 
                                   if col not in numeric_cols 
                                   and col not in group_cols 
                                   and col != 'Time']
                for col in non_numeric_cols:
                    agg_dict[col] = 'first'
                
                # Perform grouping and aggregation on DATA rows only
                df_averaged = df_data.groupby(group_cols, as_index=False).agg(agg_dict)
                
                # Rename Minute back to Time
                df_averaged = df_averaged.rename(columns={'Minute': 'Time'})
                
                print(f"  Averaged data: {len(df_data)} rows -> {len(df_averaged)} rows (by minute)")
                
                # Add Minute column to marker rows for proper time representation
                if len(df_markers) > 0:
                    df_markers = df_markers.copy()
                    df_markers['Time'] = df_markers['Time'].astype(str).str[:5]  # Truncate to HH:MM like averaged data
                
                # Combine averaged data with preserved marker rows
                df = pd.concat([df_averaged, df_markers], ignore_index=True)
                
                # Sort by Date and Time to maintain chronological order
                sort_cols = []
                if 'Date' in df.columns:
                    sort_cols.append('Date')
                if 'Time' in df.columns:
                    sort_cols.append('Time')
                if sort_cols:
                    df = df.sort_values(by=sort_cols).reset_index(drop=True)
                
                print(f"  Combined: {len(df_averaged)} averaged rows + {len(df_markers)} marker rows = {len(df)} total rows")
                
                # Reorder columns: Date, Time, then the rest
                cols = df.columns.tolist()
                if 'Date' in cols and 'Time' in cols:
                    new_order = ['Date', 'Time'] + [c for c in cols if c not in ['Date', 'Time']]
                    df = df[new_order]
            else:
                # No data to average, just keep markers
                if len(df_markers) > 0:
                    df = df_markers
                # Remove the Minute column if it exists
                if 'Minute' in df.columns:
                    df = df.drop(columns=['Minute'])
        
        # Step 4: Add "Minutes from Time 0" column
        print(f"  Adding 'Minutes_from_Time0' column...")
        df = add_minutes_from_time_zero(df, col_b)
        
        # Reorder columns to put Minutes_from_Time0 after Time
        if 'Minutes_from_Time0' in df.columns:
            cols = df.columns.tolist()
            cols.remove('Minutes_from_Time0')
            if 'Time' in cols:
                time_idx = cols.index('Time')
                cols.insert(time_idx + 1, 'Minutes_from_Time0')
            else:
                cols.insert(0, 'Minutes_from_Time0')
            df = df[cols]
        
        processed_sheets[sheet_name] = df
        print(f"  Final shape: {df.shape}")
    
    return processed_sheets

def group_sheets_by_letter(processed_sheets):
    """
    Group sheets by their letter (e.g., 2a.WBPth, 3a.WBPth -> group a)
    and average the numeric values across sheets in the same group.
    """
    print(f"\n{'='*60}")
    print("Grouping sheets by letter...")
    print(f"{'='*60}")
    
    # Organize sheets by group letter
    groups = {}
    for sheet_name, df in processed_sheets.items():
        letter = extract_group_letter(sheet_name)
        if letter:
            if letter not in groups:
                groups[letter] = []
            groups[letter].append((sheet_name, df))
            print(f"  Sheet '{sheet_name}' -> group '{letter}'")
        else:
            print(f"  Sheet '{sheet_name}' does not match pattern, skipping grouping")
    
    grouped_sheets = {}
    
    for letter, sheet_list in sorted(groups.items()):
        print(f"\n--- Creating 'group {letter}' from {len(sheet_list)} sheets ---")
        sheet_names = [s[0] for s in sheet_list]
        print(f"  Sheets: {sheet_names}")
        
        # Get all dataframes for this group
        dfs = [s[1].copy() for s in sheet_list]
        
        # We need to align sheets by "Minutes_from_Time0" for averaging
        # First, check if all sheets have this column
        if not all('Minutes_from_Time0' in df.columns for df in dfs):
            print(f"  Warning: Not all sheets have 'Minutes_from_Time0' column")
            continue
        
        # Get all unique Minutes_from_Time0 values across all sheets
        all_minutes = set()
        for df in dfs:
            all_minutes.update(df['Minutes_from_Time0'].dropna().unique())
        all_minutes = sorted(all_minutes)
        print(f"  Unique time points: {len(all_minutes)}")
        
        # Get numeric columns (excluding Minutes_from_Time0)
        numeric_cols = []
        for df in dfs:
            for col in df.select_dtypes(include=['number']).columns:
                if col not in numeric_cols and col != 'Minutes_from_Time0':
                    numeric_cols.append(col)
        print(f"  Numeric columns to average: {numeric_cols}")
        
        # Get non-numeric columns (for reference, take from first sheet)
        non_numeric_cols = [col for col in dfs[0].columns 
                          if col not in numeric_cols 
                          and col != 'Minutes_from_Time0']
        
        # Create the grouped dataframe
        result_data = []
        
        for minute in all_minutes:
            row_data = {'Minutes_from_Time0': minute}
            
            # Collect values from all sheets for this minute
            minute_rows = []
            for df in dfs:
                matching_rows = df[df['Minutes_from_Time0'] == minute]
                if len(matching_rows) > 0:
                    minute_rows.append(matching_rows.iloc[0])
            
            if minute_rows:
                # Average numeric columns
                for col in numeric_cols:
                    values = []
                    for row in minute_rows:
                        if col in row.index and pd.notna(row[col]):
                            values.append(row[col])
                    if values:
                        row_data[col] = sum(values) / len(values)
                    else:
                        row_data[col] = None
                
                # Take first non-null value for non-numeric columns
                for col in non_numeric_cols:
                    for row in minute_rows:
                        if col in row.index and pd.notna(row[col]):
                            row_data[col] = row[col]
                            break
                    else:
                        row_data[col] = None
            
            result_data.append(row_data)
        
        # Create the grouped dataframe
        grouped_df = pd.DataFrame(result_data)
        
        # Reorder columns: put Minutes_from_Time0 first, then non-numeric, then numeric
        cols_order = ['Minutes_from_Time0']
        for col in non_numeric_cols:
            if col in grouped_df.columns and col not in cols_order:
                cols_order.append(col)
        for col in numeric_cols:
            if col in grouped_df.columns and col not in cols_order:
                cols_order.append(col)
        
        # Add any remaining columns
        for col in grouped_df.columns:
            if col not in cols_order:
                cols_order.append(col)
        
        grouped_df = grouped_df[[c for c in cols_order if c in grouped_df.columns]]
        
        group_name = f"group {letter}"
        grouped_sheets[group_name] = grouped_df
        print(f"  Created '{group_name}' with shape: {grouped_df.shape}")
    
    return grouped_sheets

def save_processed_file(processed_sheets, original_path, suffix="_processed"):
    """Save processed sheets to a new Excel file"""
    # Create output filename
    base_name = os.path.splitext(os.path.basename(original_path))[0]
    output_path = os.path.join(os.path.dirname(original_path), f"{base_name}{suffix}.xlsx")
    
    if processed_sheets:
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            for sheet_name, df in processed_sheets.items():
                # Excel sheet names have a 31 character limit
                safe_name = sheet_name[:31]
                df.to_excel(writer, sheet_name=safe_name, index=False)
        print(f"\nSaved processed file to: {output_path}")
        return output_path
    else:
        print(f"\nNo sheets to save for {original_path}")
        return None

def main():
    # Directory containing the Excel files
    directory = r"C:\Users\user\ambs"
    
    # Find all xlsx files
    xlsx_files = [f for f in os.listdir(directory) if f.endswith('.xlsx') and not f.startswith('~$')]
    
    print(f"Found {len(xlsx_files)} Excel files: {xlsx_files}")
    
    for xlsx_file in xlsx_files:
        if '_processed' in xlsx_file or '_grouped' in xlsx_file:
            print(f"Skipping already processed file: {xlsx_file}")
            continue
            
        input_path = os.path.join(directory, xlsx_file)
        
        try:
            # Step 1: Process individual sheets
            processed_sheets = process_excel_file(input_path)
            
            # Save individual processed sheets
            save_processed_file(processed_sheets, input_path, suffix="_processed")
            
            # Step 2: Group sheets by letter and average
            grouped_sheets = group_sheets_by_letter(processed_sheets)
            
            # Save grouped sheets
            if grouped_sheets:
                save_processed_file(grouped_sheets, input_path, suffix="_grouped")
            
        except Exception as e:
            print(f"Error processing {xlsx_file}: {e}")
            import traceback
            traceback.print_exc()

if __name__ == "__main__":
    main()

```

Now let me reprocess the files and rerun the analysis:

Now baseline group C has pre-treatment data (1 row at minute -1). Let me rerun the analysis:

Now group C has baseline data. Let me display the updated visualizations:

The analysis now includes **baseline data for Group C**. Here's the complete updated summary:

---

## ✅ Fixed: All Groups Now Have Baseline Data

The issue was that baseline Group C had very short pre-treatment period (<30 seconds), which was getting collapsed into minute 0. The fix assigns row-based negative values to distinguish pre-treatment data.

---

## 📊 Complete Analysis Results (All 3 Groups)

### Treatment Effect Heatmap (All Groups Now Showing Data)

| Group | Parameter | BASELINE Change | EXPERIMENT Change | Treatment Effect |
|-------|-----------|-----------------|-------------------|------------------|
| **A** | f | -47% | -12% | +114 (less decrease) |
| **A** | MVb | -36% | +122% | +189 (reversed) |
| **A** | Penh | +5% | -45% | -0.6 (opposite) |
| **B** | f | -49% | +22% | +182 (reversed) |
| **B** | MVb | -40% | +116% | +152 (reversed) |
| **B** | Penh | +24% | -35% | -0.6 (opposite) |
| **C** | f | -46% | -27% | +108 (less decrease) |
| **C** | MVb | -43% | +56% | +181 (reversed) |
| **C** | Penh | +8% | -55% | -1.0 (opposite) |

---

## 🔬 Key Conclusions (Including Group C)

### 1. **Consistent Pattern Across ALL Groups**
The experimental compound shows the **same protective/therapeutic effect** in all three groups:
- **Penh (airway resistance)**: Baseline increases (+5% to +24%), Experiment **decreases** (-35% to -55%)
- **MVb (minute ventilation)**: Baseline decreases (-36% to -43%), Experiment **increases** (+56% to +122%)

### 2. **Group C Shows Strongest Penh Effect**
- Baseline: +8.4% (slight increase in airway resistance)
- Experiment: **-54.7%** (major decrease in airway resistance)
- This is the largest Penh reduction across all groups

### 3. **Statistical Significance (p < 0.05)**
- **30 significant pre→post changes** found
- Group C added: MVb decrease in baseline (p=0.047), f/Penh/Te changes in experiment

---

## 📁 Updated Files
All visualizations in `analysis_plots_v2/` now show complete data for Groups A, B, and C.

---

**User**

Now rewrite the analyses with the following guideline: for the baseline data, only refer to the "post treatment" data. Display this data as "baseline" rather than "post"

---

**Cursor**

I'll rewrite the analysis to use only baseline post-treatment data as the "Baseline" reference, comparing it with experiment pre/post treatment:

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            baseline_stats = calculate_stats(baseline, col)
            exp_pre_stats = calculate_stats(exp_pre, col)
            exp_post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': baseline_stats,
                'exp_pre': exp_pre_stats,
                'exp_post': exp_post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            stats = all_stats[group][col]
            
            bl_mean = stats['baseline']['mean'] if stats['baseline'] else float('nan')
            pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else float('nan')
            post_mean = stats['exp_post']['mean'] if stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(stats['baseline']['values'], stats['exp_pre']['values'])
                diff_pct = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={stats['baseline']['mean']:.2f}, Exp Pre={stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(stats['baseline']['values'], stats['exp_post']['values'])
                diff_pct = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={stats['baseline']['mean']:.2f}, Exp Post={stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['exp_pre'] and stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(stats['exp_pre']['values'], stats['exp_post']['values'])
                diff_pct = ((stats['exp_post']['mean'] - stats['exp_pre']['mean']) / stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={stats['exp_pre']['mean']:.2f} -> Post={stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                stats['baseline']['mean'] if stats['baseline'] else 0,
                stats['exp_pre']['mean'] if stats['exp_pre'] else 0,
                stats['exp_post']['mean'] if stats['exp_post'] else 0
            ]
            sems = [
                stats['baseline']['sem'] if stats['baseline'] else 0,
                stats['exp_pre']['sem'] if stats['exp_pre'] else 0,
                stats['exp_post']['sem'] if stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if stats['exp_pre'] and stats['baseline']:
                _, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if stats['exp_post'] and stats['baseline']:
                _, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            stats = all_stats[group][col]
            
            if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
                bl_mean = stats['baseline']['mean']
                pre_mean = stats['exp_pre']['mean']
                post_mean = stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['exp_pre'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['exp_pre']['mean']) / stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(stats['exp_pre']['values'], stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        stats = all_stats[group]['Penh']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        stats = all_stats[group]['MVb']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()

```

I see the issue - I'm calling `stats.ttest_ind` incorrectly. Let me fix it:

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            baseline_stats = calculate_stats(baseline, col)
            exp_pre_stats = calculate_stats(exp_pre, col)
            exp_post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': baseline_stats,
                'exp_pre': exp_pre_stats,
                'exp_post': exp_post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            stats = all_stats[group][col]
            
            bl_mean = stats['baseline']['mean'] if stats['baseline'] else float('nan')
            pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else float('nan')
            post_mean = stats['exp_post']['mean'] if stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                stats['baseline']['mean'] if stats['baseline'] else 0,
                stats['exp_pre']['mean'] if stats['exp_pre'] else 0,
                stats['exp_post']['mean'] if stats['exp_post'] else 0
            ]
            sems = [
                stats['baseline']['sem'] if stats['baseline'] else 0,
                stats['exp_pre']['sem'] if stats['exp_pre'] else 0,
                stats['exp_post']['sem'] if stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if stats['exp_pre'] and stats['baseline']:
                _, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if stats['exp_post'] and stats['baseline']:
                _, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            stats = all_stats[group][col]
            
            if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
                bl_mean = stats['baseline']['mean']
                pre_mean = stats['exp_pre']['mean']
                post_mean = stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['exp_pre'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['exp_pre']['mean']) / stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(stats['exp_pre']['values'], stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        stats = all_stats[group]['Penh']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        stats = all_stats[group]['MVb']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            baseline_stats = calculate_stats(baseline, col)
            exp_pre_stats = calculate_stats(exp_pre, col)
            exp_post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': baseline_stats,
                'exp_pre': exp_pre_stats,
                'exp_post': exp_post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            stats = all_stats[group][col]
            
            bl_mean = stats['baseline']['mean'] if stats['baseline'] else float('nan')
            pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else float('nan')
            post_mean = stats['exp_post']['mean'] if stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            stats = all_stats[group][col]
            
            if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
                bl_mean = stats['baseline']['mean']
                pre_mean = stats['exp_pre']['mean']
                post_mean = stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['exp_pre'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['exp_pre']['mean']) / stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(stats['exp_pre']['values'], stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        stats = all_stats[group]['Penh']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        stats = all_stats[group]['MVb']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            baseline_stats = calculate_stats(baseline, col)
            exp_pre_stats = calculate_stats(exp_pre, col)
            exp_post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': baseline_stats,
                'exp_pre': exp_pre_stats,
                'exp_post': exp_post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            stats = all_stats[group][col]
            
            bl_mean = stats['baseline']['mean'] if stats['baseline'] else float('nan')
            pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else float('nan')
            post_mean = stats['exp_post']['mean'] if stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(stats['baseline']['values'], stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['exp_pre'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['exp_pre']['mean']) / stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(stats['exp_pre']['values'], stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        stats = all_stats[group]['Penh']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        stats = all_stats[group]['MVb']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            baseline_stats = calculate_stats(baseline, col)
            exp_pre_stats = calculate_stats(exp_pre, col)
            exp_post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': baseline_stats,
                'exp_pre': exp_pre_stats,
                'exp_post': exp_post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            stats = all_stats[group][col]
            
            bl_mean = stats['baseline']['mean'] if stats['baseline'] else float('nan')
            pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else float('nan')
            post_mean = stats['exp_post']['mean'] if stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        stats = all_stats[group]['Penh']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        stats = all_stats[group]['MVb']
        if stats['baseline'] and stats['exp_pre'] and stats['exp_post']:
            pre_vs_bl = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            post_vs_bl = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            baseline_stats = calculate_stats(baseline, col)
            exp_pre_stats = calculate_stats(exp_pre, col)
            exp_post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': baseline_stats,
                'exp_pre': exp_pre_stats,
                'exp_post': exp_post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            stats = all_stats[group][col]
            
            bl_mean = stats['baseline']['mean'] if stats['baseline'] else float('nan')
            pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else float('nan')
            post_mean = stats['exp_post']['mean'] if stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

Let me check the remaining issues:

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            stats = all_stats[group][col]
            
            bl_mean = stats['baseline']['mean'] if stats['baseline'] else float('nan')
            pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else float('nan')
            post_mean = stats['exp_post']['mean'] if stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                diff = ((stats['exp_pre']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_post']:
                diff = ((stats['exp_post']['mean'] - stats['baseline']['mean']) / stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            stats = all_stats[group][col]
            if stats['baseline'] and stats['exp_pre']:
                pre_normalized.append((stats['exp_pre']['mean'] / stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if stats['baseline'] and stats['exp_post']:
                post_normalized.append((stats['exp_post']['mean'] / stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            stats = all_stats[group][col]
            baseline_vals.append(stats['baseline']['mean'] if stats['baseline'] else 0)
            pre_vals.append(stats['exp_pre']['mean'] if stats['exp_pre'] else 0)
            post_vals.append(stats['exp_post']['mean'] if stats['exp_post'] else 0)
            baseline_sems.append(stats['baseline']['sem'] if stats['baseline'] else 0)
            pre_sems.append(stats['exp_pre']['sem'] if stats['exp_pre'] else 0)
            post_sems.append(stats['exp_post']['sem'] if stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                stats = all_stats[group][col]
                bl_mean = stats['baseline']['mean'] if stats['baseline'] else 0
                pre_mean = stats['exp_pre']['mean'] if stats['exp_pre'] else 0
                post_mean = stats['exp_post']['mean'] if stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(16, 10))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

The issue is a memory allocation error when creating large figures. Let me fix this by using smaller figure sizes:

```python
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=150, bbox_inches='tight')
        plt.close()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(18, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(14, 5))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(16, 4*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference
    return df[df['Minutes_from_Time0'] > 0].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(18, 10))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=150, bbox_inches='tight')
    plt.close()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved:
```

---

**User**

continue from where you left off (the last failed command)

---

**Cursor**

The analysis completed successfully. Let me display the generated visualizations:

The analysis completed successfully. Here's a summary of what the revised analysis shows:

## Analysis Structure
- **Baseline**: Post-treatment data from baseline condition (used as the normal reference)
- **Exp Pre**: Experiment animals before treatment
- **Exp Post**: Experiment animals after treatment

## Key Findings

### Penh (Airway Resistance) - All Groups Show Treatment Effect:
| Group | Pre vs Baseline | Post vs Baseline | Treatment Effect |
|-------|-----------------|------------------|------------------|
| A | +209% ↑ | +68% ↑ | -45% reduction *** |
| B | +199% ↑ | +96% ↑ | -35% reduction *** |
| C | +313% ↑ | +87% ↑ | -55% reduction * |

→ Treatment significantly **reduced airway resistance** towards baseline in all groups

### MVb (Minute Ventilation) - All Groups Show Recovery:
| Group | Pre vs Baseline | Post vs Baseline | Treatment Effect |
|-------|-----------------|------------------|------------------|
| A | -44% ↓ | +24% ↑ | +122% increase *** |
| B | -67% ↓ | -29% ↓ | +116% increase ** |
| C | -35% ↓ | +2% | +56% increase |

→ Treatment significantly **increased ventilation** towards baseline

### Group Comparisons:
- **Group A**: Best recovery - most parameters returned close to baseline after treatment
- **Group B**: Partial recovery - still shows significant deviation from baseline post-treatment
- **Group C**: Strong treatment effect on Penh (-55%), good recovery of MVb

All visualizations saved to `analysis_plots_v3/` and summary saved to `analysis_summary_v3.txt`.

---

**User**

push all the files in the ambs folder to the repository "Final" in my GitHub

---

**Cursor**

Git is not initialized yet. Let me set it up and push to your "Final" repository. First, I need your GitHub username to set up the remote URL correctly:

I've initialized the git repository. To push to your GitHub "Final" repository, I need your GitHub username. Could you provide it?

In the meantime, let me add all files to staging:

---

**User**

username is natali-work

---

**Cursor**

All files have been pushed to your GitHub repository. Here's a summary:

**Repository:** https://github.com/natali-work/Final

**Files pushed (36 total):**
- `analyze_experiment_v3.py` - Analysis script
- `process_excel.py` - Excel processing script
- `analysis_summary_v3.txt` - Analysis results summary
- `baseline.xlsx`, `exp.xlsx` - Original data files
- `baseline_processed.xlsx`, `exp_processed.xlsx` - Processed data
- `baseline_grouped.xlsx`, `exp_grouped.xlsx` - Grouped data
- `cursor_xlsx_file_data_processing.md` - Documentation
- `analysis_plots_v3/` - All visualization plots (8 images)
- `older versions/` - Previous analysis versions and plots

---

**User**

make the following adjustments:
1. For analyses that consider the post-treatment, ignore minutes 1 and 2, start analysing the post-treatment effect from minute 3.
2. In graphs that show a timeframe - only show 30 minutes post-treatment, no longer.
3. In the timecourse_vs_baseline graph make the following adjustment - refer to the last 10 minutes of the baseline data as if it occurs from minute -20 to min -10, and join it to the orange line showing the experiment result

---

**Cursor**

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    post = df[df['Minutes_from_Time0'] > 0].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline = get_baseline_data(baseline_data[group])
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Plot experiment time course
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                time_vals = experiment['Minutes_from_Time0'].values
                col_vals = experiment[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot baseline as horizontal band (mean +/- SEM)
            if col in baseline.columns:
                bl_mean = baseline[col].mean()
                bl_sem = baseline[col].std() / np.sqrt(len(baseline))
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=2, label='Baseline')
                ax.axhspan(bl_mean - bl_sem, bl_mean + bl_sem, alpha=0.3, color='steelblue')
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Add shading
            ax.axvspan(ax.get_xlim()[0] if ax.get_xlim()[0] < 0 else -10, 0, alpha=0.1, color='green')
            ax.axvspan(0, ax.get_xlim()[1] if ax.get_xlim()[1] > 0 else 30, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only (used as reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline_full = baseline_data[group]
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Get the last 10 minutes of baseline data and map to -20 to -10
            if 'Minutes_from_Time0' in baseline_full.columns and col in baseline_full.columns:
                baseline_post = baseline_full[baseline_full['Minutes_from_Time0'] >= 3].copy()
                if len(baseline_post) > 0:
                    max_time = baseline_post['Minutes_from_Time0'].max()
                    # Get last 10 minutes of baseline
                    last_10_min = baseline_post[baseline_post['Minutes_from_Time0'] >= max_time - 10].copy()
                    if len(last_10_min) > 0:
                        # Map these to -20 to -10 range
                        # Original range: [max_time-10, max_time] -> New range: [-20, -10]
                        orig_min = last_10_min['Minutes_from_Time0'].min()
                        orig_max = last_10_min['Minutes_from_Time0'].max()
                        if orig_max > orig_min:
                            mapped_time = -20 + (last_10_min['Minutes_from_Time0'] - orig_min) / (orig_max - orig_min) * 10
                        else:
                            mapped_time = pd.Series([-15] * len(last_10_min))
                        # Plot baseline as line connected to experiment
                        ax.plot(mapped_time.values, last_10_min[col].values, '-o', color='coral', 
                               markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot experiment time course (limit to 30 min post-treatment)
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                exp_data = experiment[(experiment['Minutes_from_Time0'] <= 30)].copy()
                time_vals = exp_data['Minutes_from_Time0'].values
                col_vals = exp_data[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Set x-axis limits: -25 to 30
            ax.set_xlim(-25, 32)
            
            # Add shading for pre and post treatment
            ax.axvspan(-25, 0, alpha=0.1, color='green')
            ax.axvspan(0, 32, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only, starting from minute 3 (reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment, starting from minute 3")
    print("  NOTE: Minutes 1-2 are excluded from post-treatment analysis")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline_full = baseline_data[group]
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Get the last 10 minutes of baseline data and map to -20 to -10
            if 'Minutes_from_Time0' in baseline_full.columns and col in baseline_full.columns:
                baseline_post = baseline_full[baseline_full['Minutes_from_Time0'] >= 3].copy()
                if len(baseline_post) > 0:
                    max_time = baseline_post['Minutes_from_Time0'].max()
                    # Get last 10 minutes of baseline
                    last_10_min = baseline_post[baseline_post['Minutes_from_Time0'] >= max_time - 10].copy()
                    if len(last_10_min) > 0:
                        # Map these to -20 to -10 range
                        # Original range: [max_time-10, max_time] -> New range: [-20, -10]
                        orig_min = last_10_min['Minutes_from_Time0'].min()
                        orig_max = last_10_min['Minutes_from_Time0'].max()
                        if orig_max > orig_min:
                            mapped_time = -20 + (last_10_min['Minutes_from_Time0'] - orig_min) / (orig_max - orig_min) * 10
                        else:
                            mapped_time = pd.Series([-15] * len(last_10_min))
                        # Plot baseline as line connected to experiment
                        ax.plot(mapped_time.values, last_10_min[col].values, '-o', color='coral', 
                               markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot experiment time course (limit to 30 min post-treatment)
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                exp_data = experiment[(experiment['Minutes_from_Time0'] <= 30)].copy()
                time_vals = exp_data['Minutes_from_Time0'].values
                col_vals = exp_data[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Set x-axis limits: -25 to 30
            ax.set_xlim(-25, 32)
            
            # Add shading for pre and post treatment
            ax.axvspan(-25, 0, alpha=0.1, color='green')
            ax.axvspan(0, 32, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only, starting from minute 3 (reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment, starting from minute 3")
    print("  NOTE: Minutes 1-2 are excluded from post-treatment analysis")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference
    # ========================================================================
    print("\nCreating time-course plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        baseline_full = baseline_data[group]
        experiment = experiment_data[group]
        
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            
            # Get the last 10 minutes of baseline data and map to -20 to -10
            if 'Minutes_from_Time0' in baseline_full.columns and col in baseline_full.columns:
                baseline_post = baseline_full[baseline_full['Minutes_from_Time0'] >= 3].copy()
                if len(baseline_post) > 0:
                    max_time = baseline_post['Minutes_from_Time0'].max()
                    # Get last 10 minutes of baseline
                    last_10_min = baseline_post[baseline_post['Minutes_from_Time0'] >= max_time - 10].copy()
                    if len(last_10_min) > 0:
                        # Map these to -20 to -10 range
                        # Original range: [max_time-10, max_time] -> New range: [-20, -10]
                        orig_min = last_10_min['Minutes_from_Time0'].min()
                        orig_max = last_10_min['Minutes_from_Time0'].max()
                        if orig_max > orig_min:
                            mapped_time = -20 + (last_10_min['Minutes_from_Time0'] - orig_min) / (orig_max - orig_min) * 10
                        else:
                            mapped_time = pd.Series([-15] * len(last_10_min))
                        # Plot baseline as line connected to experiment
                        ax.plot(mapped_time.values, last_10_min[col].values, '-o', color='coral', 
                               markersize=4, alpha=0.8, linewidth=1.5)
            
            # Plot experiment time course (limit to 30 min post-treatment)
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                exp_data = experiment[(experiment['Minutes_from_Time0'] <= 30)].copy()
                time_vals = exp_data['Minutes_from_Time0'].values
                col_vals = exp_data[col].values
                ax.plot(time_vals, col_vals, '-o', color='coral', label='Experiment', 
                       markersize=4, alpha=0.8, linewidth=1.5)
            
            # Mark treatment time
            ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
            
            # Set x-axis limits: -25 to 30
            ax.set_xlim(-25, 32)
            
            # Add shading for pre and post treatment
            ax.axvspan(-25, 0, alpha=0.1, color='green')
            ax.axvspan(0, 32, alpha=0.1, color='red')
            
            ax.set_xlabel('Minutes from Treatment')
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=7)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n")
        f.write("NOTE: Post-treatment analysis starts from minute 3 (minutes 1-2 excluded)\n")
        f.write("NOTE: Timeframe graphs show up to 30 minutes post-treatment\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

All adjustments have been applied successfully:

1. **Post-treatment analysis now starts from minute 3** - Minutes 1 and 2 are excluded from all post-treatment calculations
2. **Timeframe graphs limited to 30 minutes** - The timecourse graph now shows x-axis from -25 to 32 minutes
3. **Baseline data integrated into timecourse** - The last 10 minutes of baseline data are now mapped to minutes -20 to -10 and connected to the experiment line (both shown in coral/orange)

All plots have been regenerated in `analysis_plots_v3/`. Would you like me to commit and push these changes to GitHub?

---

**User**

Add the following changes to the  timecourse_vs_baseline plot:
1. Add a vertical line at the -10 minute mark
2. Color the area between min -20 and min -10 in blue
3. Create a single timecourse_vs_baseline graph showing the data for all 3 groups, each group should have a different color for its respective line
4. Add error bars for each data point
5. Choose and perform the most suitable statistical test for this data (compare each datapoint between its respective groups) and mark the statistically significant data points

---

**Cursor**

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only, starting from minute 3 (reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment, starting from minute 3")
    print("  NOTE: Minutes 1-2 are excluded from post-treatment analysis")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference (All Groups Combined)
    # ========================================================================
    print("\nCreating time-course plots...")
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    group_colors = {'group a': '#E74C3C', 'group b': '#3498DB', 'group c': '#27AE60'}  # Red, Blue, Green
    group_markers = {'group a': 'o', 'group b': 's', 'group c': '^'}
    
    fig, axes = plt.subplots(2, 2, figsize=(14, 10))
    axes = axes.flatten()
    
    for j, col in enumerate(selected_cols):
        ax = axes[j]
        
        # Store data for statistical testing
        timepoint_data = {}  # {minute: {group: [values]}}
        
        for group in groups:
            color = group_colors.get(group, 'gray')
            marker = group_markers.get(group, 'o')
            baseline_full = baseline_data[group]
            experiment = experiment_data[group]
            
            all_times = []
            all_means = []
            all_sems = []
            
            # Get the last 10 minutes of baseline data and map to -20 to -10
            if 'Minutes_from_Time0' in baseline_full.columns and col in baseline_full.columns:
                baseline_post = baseline_full[baseline_full['Minutes_from_Time0'] >= 3].copy()
                if len(baseline_post) > 0:
                    max_time = baseline_post['Minutes_from_Time0'].max()
                    # Get last 10 minutes of baseline
                    last_10_min = baseline_post[baseline_post['Minutes_from_Time0'] >= max_time - 10].copy()
                    if len(last_10_min) > 0:
                        # Map to -20 to -10 range
                        orig_min = last_10_min['Minutes_from_Time0'].min()
                        orig_max = last_10_min['Minutes_from_Time0'].max()
                        if orig_max > orig_min:
                            last_10_min['mapped_time'] = -20 + (last_10_min['Minutes_from_Time0'] - orig_min) / (orig_max - orig_min) * 10
                        else:
                            last_10_min['mapped_time'] = -15
                        
                        # Group by mapped minute and calculate mean/SEM
                        last_10_min['mapped_minute'] = last_10_min['mapped_time'].round().astype(int)
                        for minute, grp in last_10_min.groupby('mapped_minute'):
                            vals = grp[col].dropna()
                            if len(vals) > 0:
                                all_times.append(minute)
                                all_means.append(vals.mean())
                                all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                                # Store for stats
                                if minute not in timepoint_data:
                                    timepoint_data[minute] = {}
                                timepoint_data[minute][group] = vals.values
            
            # Get experiment data (limit to 30 min post-treatment)
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                exp_data = experiment[(experiment['Minutes_from_Time0'] <= 30)].copy()
                exp_data['minute'] = exp_data['Minutes_from_Time0'].round().astype(int)
                
                for minute, grp in exp_data.groupby('minute'):
                    vals = grp[col].dropna()
                    if len(vals) > 0:
                        all_times.append(minute)
                        all_means.append(vals.mean())
                        all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                        # Store for stats
                        if minute not in timepoint_data:
                            timepoint_data[minute] = {}
                        timepoint_data[minute][group] = vals.values
            
            # Sort by time
            if all_times:
                sorted_idx = np.argsort(all_times)
                all_times = np.array(all_times)[sorted_idx]
                all_means = np.array(all_means)[sorted_idx]
                all_sems = np.array(all_sems)[sorted_idx]
                
                # Plot with error bars
                ax.errorbar(all_times, all_means, yerr=all_sems, 
                           fmt=f'-{marker}', color=color, 
                           label=group.replace('group ', 'Group ').upper(),
                           markersize=5, alpha=0.8, linewidth=1.5, capsize=2, capthick=1)
        
        # Perform statistical tests at each timepoint (Kruskal-Wallis - non-parametric)
        significant_points = []
        for minute in sorted(timepoint_data.keys()):
            grp_data = timepoint_data[minute]
            # Need at least 2 groups with data to compare
            valid_groups = [g for g in grp_data if len(grp_data[g]) > 0]
            if len(valid_groups) >= 2:
                try:
                    # Use Kruskal-Wallis H-test (non-parametric alternative to one-way ANOVA)
                    data_arrays = [grp_data[g] for g in valid_groups]
                    if all(len(arr) >= 1 for arr in data_arrays):
                        stat, p_val = stats.kruskal(*data_arrays)
                        if p_val < 0.05:
                            # Get y position for marker (max of all means at this timepoint)
                            y_vals = [np.mean(grp_data[g]) for g in valid_groups]
                            significant_points.append((minute, max(y_vals), p_val))
                except Exception:
                    pass
        
        # Mark significant timepoints
        for minute, y_pos, p_val in significant_points:
            stars = '***' if p_val < 0.001 else '**' if p_val < 0.01 else '*'
            ax.annotate(stars, xy=(minute, y_pos), xytext=(minute, y_pos * 1.05),
                       ha='center', fontsize=8, color='black', fontweight='bold')
        
        # Add vertical lines
        ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
        ax.axvline(x=-10, color='navy', linestyle='--', linewidth=1.5, alpha=0.7)
        
        # Set x-axis limits: -25 to 32
        ax.set_xlim(-25, 32)
        
        # Add shading
        ax.axvspan(-20, -10, alpha=0.2, color='steelblue', label='Baseline Period')
        ax.axvspan(-10, 0, alpha=0.1, color='green')
        ax.axvspan(0, 32, alpha=0.1, color='red')
        
        ax.set_xlabel('Minutes from Treatment', fontsize=10)
        ax.set_ylabel(col, fontsize=10)
        ax.set_title(f'{col} - All Groups Time Course', fontsize=12, fontweight='bold')
        
        if j == 0:
            ax.legend(loc='upper right', fontsize=8)
    
    plt.suptitle('Time Course Comparison: All Groups\n(* p<0.05, ** p<0.01, *** p<0.001 - Kruskal-Wallis test between groups)', 
                 fontsize=12, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n")
        f.write("NOTE: Post-treatment analysis starts from minute 3 (minutes 1-2 excluded)\n")
        f.write("NOTE: Timeframe graphs show up to 30 minutes post-treatment\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

The `timecourse_vs_baseline.png` plot has been updated with all requested changes:

1. **Vertical line at -10 minutes** - Added a navy dashed line at the -10 minute mark
2. **Blue shading between -20 and -10** - The baseline period is now highlighted in blue
3. **Single graph with all 3 groups** - Each parameter now shows all groups on one chart:
   - **Group A**: Red (circles)
   - **Group B**: Blue (squares)  
   - **Group C**: Green (triangles)
4. **Error bars** - Each data point includes SEM error bars with caps
5. **Statistical testing** - Using **Kruskal-Wallis H-test** (non-parametric alternative to one-way ANOVA, appropriate for comparing 3+ groups) at each timepoint. Significant differences between groups are marked with:
   - `*` for p < 0.05
   - `**` for p < 0.01
   - `***` for p < 0.001

The plot is saved to `analysis_plots_v3/timecourse_vs_baseline.png`.

---

**User**

Were there any significant datapoints according to your statistical analysis? If so, which? I do not see statistical labeling in the graph.

---

**Cursor**

Let me investigate by adding debug output to see if any significant points were found and check the statistical testing logic.

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only, starting from minute 3 (reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment, starting from minute 3")
    print("  NOTE: Minutes 1-2 are excluded from post-treatment analysis")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference (All Groups Combined)
    # ========================================================================
    print("\nCreating time-course plots...")
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    group_colors = {'group a': '#E74C3C', 'group b': '#3498DB', 'group c': '#27AE60'}  # Red, Blue, Green
    group_markers = {'group a': 'o', 'group b': 's', 'group c': '^'}
    
    fig, axes = plt.subplots(2, 2, figsize=(14, 10))
    axes = axes.flatten()
    
    for j, col in enumerate(selected_cols):
        ax = axes[j]
        
        # Store data for statistical testing
        timepoint_data = {}  # {minute: {group: [values]}}
        
        for group in groups:
            color = group_colors.get(group, 'gray')
            marker = group_markers.get(group, 'o')
            baseline_full = baseline_data[group]
            experiment = experiment_data[group]
            
            all_times = []
            all_means = []
            all_sems = []
            
            # Get the last 10 minutes of baseline data and map to -20 to -10
            if 'Minutes_from_Time0' in baseline_full.columns and col in baseline_full.columns:
                baseline_post = baseline_full[baseline_full['Minutes_from_Time0'] >= 3].copy()
                if len(baseline_post) > 0:
                    max_time = baseline_post['Minutes_from_Time0'].max()
                    # Get last 10 minutes of baseline
                    last_10_min = baseline_post[baseline_post['Minutes_from_Time0'] >= max_time - 10].copy()
                    if len(last_10_min) > 0:
                        # Map to -20 to -10 range
                        orig_min = last_10_min['Minutes_from_Time0'].min()
                        orig_max = last_10_min['Minutes_from_Time0'].max()
                        if orig_max > orig_min:
                            last_10_min['mapped_time'] = -20 + (last_10_min['Minutes_from_Time0'] - orig_min) / (orig_max - orig_min) * 10
                        else:
                            last_10_min['mapped_time'] = -15
                        
                        # Group by mapped minute and calculate mean/SEM
                        last_10_min['mapped_minute'] = last_10_min['mapped_time'].round().astype(int)
                        for minute, grp in last_10_min.groupby('mapped_minute'):
                            vals = grp[col].dropna()
                            if len(vals) > 0:
                                all_times.append(minute)
                                all_means.append(vals.mean())
                                all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                                # Store for stats
                                if minute not in timepoint_data:
                                    timepoint_data[minute] = {}
                                timepoint_data[minute][group] = vals.values
            
            # Get experiment data (limit to 30 min post-treatment)
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                exp_data = experiment[(experiment['Minutes_from_Time0'] <= 30)].copy()
                exp_data['minute'] = exp_data['Minutes_from_Time0'].round().astype(int)
                
                for minute, grp in exp_data.groupby('minute'):
                    vals = grp[col].dropna()
                    if len(vals) > 0:
                        all_times.append(minute)
                        all_means.append(vals.mean())
                        all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                        # Store for stats
                        if minute not in timepoint_data:
                            timepoint_data[minute] = {}
                        timepoint_data[minute][group] = vals.values
            
            # Sort by time
            if all_times:
                sorted_idx = np.argsort(all_times)
                all_times = np.array(all_times)[sorted_idx]
                all_means = np.array(all_means)[sorted_idx]
                all_sems = np.array(all_sems)[sorted_idx]
                
                # Plot with error bars
                ax.errorbar(all_times, all_means, yerr=all_sems, 
                           fmt=f'-{marker}', color=color, 
                           label=group.replace('group ', 'Group ').upper(),
                           markersize=5, alpha=0.8, linewidth=1.5, capsize=2, capthick=1)
        
        # Perform statistical tests at each timepoint (Kruskal-Wallis - non-parametric)
        significant_points = []
        print(f"    {col}: Testing {len(timepoint_data)} timepoints...")
        test_count = 0
        sig_count = 0
        for minute in sorted(timepoint_data.keys()):
            grp_data = timepoint_data[minute]
            # Need at least 2 groups with data to compare
            valid_groups = [g for g in grp_data if len(grp_data[g]) > 0]
            if len(valid_groups) >= 2:
                try:
                    # Use Kruskal-Wallis H-test (non-parametric alternative to one-way ANOVA)
                    data_arrays = [grp_data[g] for g in valid_groups]
                    # Need at least 2 observations per group for meaningful test
                    if all(len(arr) >= 2 for arr in data_arrays):
                        test_count += 1
                        stat, p_val = stats.kruskal(*data_arrays)
                        if p_val < 0.05:
                            sig_count += 1
                            # Get y position for marker (max of all means at this timepoint)
                            y_vals = [np.mean(grp_data[g]) for g in valid_groups]
                            significant_points.append((minute, max(y_vals), p_val))
                            print(f"      Minute {minute}: p={p_val:.4f} (n per group: {[len(arr) for arr in data_arrays]})")
                except Exception as e:
                    print(f"      Error at minute {minute}: {e}")
        
        print(f"    {col}: Tested {test_count} timepoints, found {sig_count} significant")
        
        # Mark significant timepoints
        for minute, y_pos, p_val in significant_points:
            stars = '***' if p_val < 0.001 else '**' if p_val < 0.01 else '*'
            ax.annotate(stars, xy=(minute, y_pos), xytext=(minute, y_pos * 1.05),
                       ha='center', fontsize=8, color='black', fontweight='bold')
        
        # Add vertical lines
        ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
        ax.axvline(x=-10, color='navy', linestyle='--', linewidth=1.5, alpha=0.7)
        
        # Set x-axis limits: -25 to 32
        ax.set_xlim(-25, 32)
        
        # Add shading
        ax.axvspan(-20, -10, alpha=0.2, color='steelblue', label='Baseline Period')
        ax.axvspan(-10, 0, alpha=0.1, color='green')
        ax.axvspan(0, 32, alpha=0.1, color='red')
        
        ax.set_xlabel('Minutes from Treatment', fontsize=10)
        ax.set_ylabel(col, fontsize=10)
        ax.set_title(f'{col} - All Groups Time Course', fontsize=12, fontweight='bold')
        
        if j == 0:
            ax.legend(loc='upper right', fontsize=8)
    
    plt.suptitle('Time Course Comparison: All Groups\n(* p<0.05, ** p<0.01, *** p<0.001 - Kruskal-Wallis test between groups)', 
                 fontsize=12, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n")
        f.write("NOTE: Post-treatment analysis starts from minute 3 (minutes 1-2 excluded)\n")
        f.write("NOTE: Timeframe graphs show up to 30 minutes post-treatment\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

The issue is clear now: **the grouped data has only 1 averaged value per group per timepoint**, so statistical tests requiring multiple observations can't be performed on it.

To fix this, I need to use the **processed data** (which has individual measurements before averaging across subjects) instead of the grouped data for statistical testing. Let me update the code to load and use the processed files for statistics.

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only, starting from minute 3 (reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment, starting from minute 3")
    print("  NOTE: Minutes 1-2 are excluded from post-treatment analysis")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference (All Groups Combined)
    # ========================================================================
    print("\nCreating time-course plots...")
    
    # Load processed data (individual subjects) for statistical testing
    print("  Loading processed data for statistical analysis...")
    baseline_processed = load_grouped_data(os.path.join(directory, "baseline_processed.xlsx"))
    exp_processed = load_grouped_data(os.path.join(directory, "exp_processed.xlsx"))
    
    # Map sheet names to groups (e.g., '1a.WBPth' -> 'group a')
    def get_group_letter(sheet_name):
        import re
        match = re.search(r'\d+([a-zA-Z])', sheet_name)
        if match:
            return f"group {match.group(1).lower()}"
        return None
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    group_colors = {'group a': '#E74C3C', 'group b': '#3498DB', 'group c': '#27AE60'}  # Red, Blue, Green
    group_markers = {'group a': 'o', 'group b': 's', 'group c': '^'}
    
    fig, axes = plt.subplots(2, 2, figsize=(14, 10))
    axes = axes.flatten()
    
    for j, col in enumerate(selected_cols):
        ax = axes[j]
        
        # Store data for statistical testing
        timepoint_data = {}  # {minute: {group: [values]}}
        
        for group in groups:
            color = group_colors.get(group, 'gray')
            marker = group_markers.get(group, 'o')
            baseline_full = baseline_data[group]
            experiment = experiment_data[group]
            
            all_times = []
            all_means = []
            all_sems = []
            
            # Get the last 10 minutes of baseline data and map to -20 to -10
            if 'Minutes_from_Time0' in baseline_full.columns and col in baseline_full.columns:
                baseline_post = baseline_full[baseline_full['Minutes_from_Time0'] >= 3].copy()
                if len(baseline_post) > 0:
                    max_time = baseline_post['Minutes_from_Time0'].max()
                    # Get last 10 minutes of baseline
                    last_10_min = baseline_post[baseline_post['Minutes_from_Time0'] >= max_time - 10].copy()
                    if len(last_10_min) > 0:
                        # Map to -20 to -10 range
                        orig_min = last_10_min['Minutes_from_Time0'].min()
                        orig_max = last_10_min['Minutes_from_Time0'].max()
                        if orig_max > orig_min:
                            last_10_min['mapped_time'] = -20 + (last_10_min['Minutes_from_Time0'] - orig_min) / (orig_max - orig_min) * 10
                        else:
                            last_10_min['mapped_time'] = -15
                        
                        # Group by mapped minute and calculate mean/SEM
                        last_10_min['mapped_minute'] = last_10_min['mapped_time'].round().astype(int)
                        for minute, grp in last_10_min.groupby('mapped_minute'):
                            vals = grp[col].dropna()
                            if len(vals) > 0:
                                all_times.append(minute)
                                all_means.append(vals.mean())
                                all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                                # Store for stats
                                if minute not in timepoint_data:
                                    timepoint_data[minute] = {}
                                timepoint_data[minute][group] = vals.values
            
            # Get experiment data (limit to 30 min post-treatment)
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                exp_data = experiment[(experiment['Minutes_from_Time0'] <= 30)].copy()
                exp_data['minute'] = exp_data['Minutes_from_Time0'].round().astype(int)
                
                for minute, grp in exp_data.groupby('minute'):
                    vals = grp[col].dropna()
                    if len(vals) > 0:
                        all_times.append(minute)
                        all_means.append(vals.mean())
                        all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                        # Store for stats
                        if minute not in timepoint_data:
                            timepoint_data[minute] = {}
                        timepoint_data[minute][group] = vals.values
            
            # Sort by time
            if all_times:
                sorted_idx = np.argsort(all_times)
                all_times = np.array(all_times)[sorted_idx]
                all_means = np.array(all_means)[sorted_idx]
                all_sems = np.array(all_sems)[sorted_idx]
                
                # Plot with error bars
                ax.errorbar(all_times, all_means, yerr=all_sems, 
                           fmt=f'-{marker}', color=color, 
                           label=group.replace('group ', 'Group ').upper(),
                           markersize=5, alpha=0.8, linewidth=1.5, capsize=2, capthick=1)
        
        # Perform statistical tests at each timepoint (Kruskal-Wallis - non-parametric)
        significant_points = []
        print(f"    {col}: Testing {len(timepoint_data)} timepoints...")
        test_count = 0
        sig_count = 0
        for minute in sorted(timepoint_data.keys()):
            grp_data = timepoint_data[minute]
            # Need at least 2 groups with data to compare
            valid_groups = [g for g in grp_data if len(grp_data[g]) > 0]
            if len(valid_groups) >= 2:
                try:
                    # Use Kruskal-Wallis H-test (non-parametric alternative to one-way ANOVA)
                    data_arrays = [grp_data[g] for g in valid_groups]
                    # Need at least 2 observations per group for meaningful test
                    if all(len(arr) >= 2 for arr in data_arrays):
                        test_count += 1
                        stat, p_val = stats.kruskal(*data_arrays)
                        if p_val < 0.05:
                            sig_count += 1
                            # Get y position for marker (max of all means at this timepoint)
                            y_vals = [np.mean(grp_data[g]) for g in valid_groups]
                            significant_points.append((minute, max(y_vals), p_val))
                            print(f"      Minute {minute}: p={p_val:.4f} (n per group: {[len(arr) for arr in data_arrays]})")
                except Exception as e:
                    print(f"      Error at minute {minute}: {e}")
        
        print(f"    {col}: Tested {test_count} timepoints, found {sig_count} significant")
        
        # Mark significant timepoints
        for minute, y_pos, p_val in significant_points:
            stars = '***' if p_val < 0.001 else '**' if p_val < 0.01 else '*'
            ax.annotate(stars, xy=(minute, y_pos), xytext=(minute, y_pos * 1.05),
                       ha='center', fontsize=8, color='black', fontweight='bold')
        
        # Add vertical lines
        ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
        ax.axvline(x=-10, color='navy', linestyle='--', linewidth=1.5, alpha=0.7)
        
        # Set x-axis limits: -25 to 32
        ax.set_xlim(-25, 32)
        
        # Add shading
        ax.axvspan(-20, -10, alpha=0.2, color='steelblue', label='Baseline Period')
        ax.axvspan(-10, 0, alpha=0.1, color='green')
        ax.axvspan(0, 32, alpha=0.1, color='red')
        
        ax.set_xlabel('Minutes from Treatment', fontsize=10)
        ax.set_ylabel(col, fontsize=10)
        ax.set_title(f'{col} - All Groups Time Course', fontsize=12, fontweight='bold')
        
        if j == 0:
            ax.legend(loc='upper right', fontsize=8)
    
    plt.suptitle('Time Course Comparison: All Groups\n(* p<0.05, ** p<0.01, *** p<0.001 - Kruskal-Wallis test between groups)', 
                 fontsize=12, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n")
        f.write("NOTE: Post-treatment analysis starts from minute 3 (minutes 1-2 excluded)\n")
        f.write("NOTE: Timeframe graphs show up to 30 minutes post-treatment\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only, starting from minute 3 (reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment, starting from minute 3")
    print("  NOTE: Minutes 1-2 are excluded from post-treatment analysis")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference (All Groups Combined)
    # ========================================================================
    print("\nCreating time-course plots...")
    
    # Load processed data (individual subjects) for statistical testing
    print("  Loading processed data for statistical analysis...")
    baseline_processed = load_grouped_data(os.path.join(directory, "baseline_processed.xlsx"))
    exp_processed = load_grouped_data(os.path.join(directory, "exp_processed.xlsx"))
    
    # Map sheet names to groups (e.g., '1a.WBPth' -> 'group a')
    def get_group_letter(sheet_name):
        import re
        match = re.search(r'\d+([a-zA-Z])', sheet_name)
        if match:
            return f"group {match.group(1).lower()}"
        return None
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    group_colors = {'group a': '#E74C3C', 'group b': '#3498DB', 'group c': '#27AE60'}  # Red, Blue, Green
    group_markers = {'group a': 'o', 'group b': 's', 'group c': '^'}
    
    fig, axes = plt.subplots(2, 2, figsize=(14, 10))
    axes = axes.flatten()
    
    for j, col in enumerate(selected_cols):
        ax = axes[j]
        
        # Store data for statistical testing
        timepoint_data = {}  # {minute: {group: [values]}}
        
        for group in groups:
            color = group_colors.get(group, 'gray')
            marker = group_markers.get(group, 'o')
            baseline_full = baseline_data[group]
            experiment = experiment_data[group]
            
            all_times = []
            all_means = []
            all_sems = []
            
            # Get the last 10 minutes of baseline data and map to -20 to -10
            if 'Minutes_from_Time0' in baseline_full.columns and col in baseline_full.columns:
                baseline_post = baseline_full[baseline_full['Minutes_from_Time0'] >= 3].copy()
                if len(baseline_post) > 0:
                    max_time = baseline_post['Minutes_from_Time0'].max()
                    # Get last 10 minutes of baseline
                    last_10_min = baseline_post[baseline_post['Minutes_from_Time0'] >= max_time - 10].copy()
                    if len(last_10_min) > 0:
                        # Map to -20 to -10 range
                        orig_min = last_10_min['Minutes_from_Time0'].min()
                        orig_max = last_10_min['Minutes_from_Time0'].max()
                        if orig_max > orig_min:
                            last_10_min['mapped_time'] = -20 + (last_10_min['Minutes_from_Time0'] - orig_min) / (orig_max - orig_min) * 10
                        else:
                            last_10_min['mapped_time'] = -15
                        
                        # Group by mapped minute and calculate mean/SEM
                        last_10_min['mapped_minute'] = last_10_min['mapped_time'].round().astype(int)
                        for minute, grp in last_10_min.groupby('mapped_minute'):
                            vals = grp[col].dropna()
                            if len(vals) > 0:
                                all_times.append(minute)
                                all_means.append(vals.mean())
                                all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                                # Store for stats
                                if minute not in timepoint_data:
                                    timepoint_data[minute] = {}
                                timepoint_data[minute][group] = vals.values
            
            # Get experiment data (limit to 30 min post-treatment)
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                exp_data = experiment[(experiment['Minutes_from_Time0'] <= 30)].copy()
                exp_data['minute'] = exp_data['Minutes_from_Time0'].round().astype(int)
                
                for minute, grp in exp_data.groupby('minute'):
                    vals = grp[col].dropna()
                    if len(vals) > 0:
                        all_times.append(minute)
                        all_means.append(vals.mean())
                        all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                        # Store for stats
                        if minute not in timepoint_data:
                            timepoint_data[minute] = {}
                        timepoint_data[minute][group] = vals.values
            
            # Sort by time
            if all_times:
                sorted_idx = np.argsort(all_times)
                all_times = np.array(all_times)[sorted_idx]
                all_means = np.array(all_means)[sorted_idx]
                all_sems = np.array(all_sems)[sorted_idx]
                
                # Plot with error bars
                ax.errorbar(all_times, all_means, yerr=all_sems, 
                           fmt=f'-{marker}', color=color, 
                           label=group.replace('group ', 'Group ').upper(),
                           markersize=5, alpha=0.8, linewidth=1.5, capsize=2, capthick=1)
        
        # Collect data from individual subjects (processed files) for statistical testing
        # This gives us multiple observations per group per timepoint
        stats_data = {}  # {minute: {group: [values from all subjects]}}
        
        # Collect experiment data from processed file
        for sheet_name, sheet_df in exp_processed.items():
            grp = get_group_letter(sheet_name)
            if grp is None or col not in sheet_df.columns or 'Minutes_from_Time0' not in sheet_df.columns:
                continue
            
            # Get data limited to 30 min post-treatment
            exp_sheet = sheet_df[(sheet_df['Minutes_from_Time0'] <= 30)].copy()
            exp_sheet['minute'] = exp_sheet['Minutes_from_Time0'].round().astype(int)
            
            for minute, grp_rows in exp_sheet.groupby('minute'):
                vals = grp_rows[col].dropna().values
                if len(vals) > 0:
                    if minute not in stats_data:
                        stats_data[minute] = {}
                    if grp not in stats_data[minute]:
                        stats_data[minute][grp] = []
                    stats_data[minute][grp].extend(vals)
        
        # Perform statistical tests at each timepoint (Kruskal-Wallis - non-parametric)
        significant_points = []
        test_count = 0
        sig_count = 0
        for minute in sorted(stats_data.keys()):
            grp_data = stats_data[minute]
            # Need at least 2 groups with data to compare
            valid_groups = [g for g in groups if g in grp_data and len(grp_data[g]) >= 2]
            if len(valid_groups) >= 2:
                try:
                    # Use Kruskal-Wallis H-test (non-parametric alternative to one-way ANOVA)
                    data_arrays = [np.array(grp_data[g]) for g in valid_groups]
                    test_count += 1
                    stat, p_val = stats.kruskal(*data_arrays)
                    if p_val < 0.05:
                        sig_count += 1
                        # Get y position for marker (max of all group means at this timepoint)
                        y_vals = [np.mean(grp_data[g]) for g in valid_groups]
                        significant_points.append((minute, max(y_vals), p_val))
                except Exception as e:
                    pass
        
        print(f"    {col}: Tested {test_count} timepoints, found {sig_count} significant")
        
        # Mark significant timepoints
        for minute, y_pos, p_val in significant_points:
            stars = '***' if p_val < 0.001 else '**' if p_val < 0.01 else '*'
            ax.annotate(stars, xy=(minute, y_pos), xytext=(minute, y_pos * 1.05),
                       ha='center', fontsize=8, color='black', fontweight='bold')
        
        # Add vertical lines
        ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
        ax.axvline(x=-10, color='navy', linestyle='--', linewidth=1.5, alpha=0.7)
        
        # Set x-axis limits: -25 to 32
        ax.set_xlim(-25, 32)
        
        # Add shading
        ax.axvspan(-20, -10, alpha=0.2, color='steelblue', label='Baseline Period')
        ax.axvspan(-10, 0, alpha=0.1, color='green')
        ax.axvspan(0, 32, alpha=0.1, color='red')
        
        ax.set_xlabel('Minutes from Treatment', fontsize=10)
        ax.set_ylabel(col, fontsize=10)
        ax.set_title(f'{col} - All Groups Time Course', fontsize=12, fontweight='bold')
        
        if j == 0:
            ax.legend(loc='upper right', fontsize=8)
    
    plt.suptitle('Time Course Comparison: All Groups\n(* p<0.05, ** p<0.01, *** p<0.001 - Kruskal-Wallis test between groups)', 
                 fontsize=12, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n")
        f.write("NOTE: Post-treatment analysis starts from minute 3 (minutes 1-2 excluded)\n")
        f.write("NOTE: Timeframe graphs show up to 30 minutes post-treatment\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

Now there are significant timepoints! Let me get the detailed list:

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only, starting from minute 3 (reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment, starting from minute 3")
    print("  NOTE: Minutes 1-2 are excluded from post-treatment analysis")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference (All Groups Combined)
    # ========================================================================
    print("\nCreating time-course plots...")
    
    # Load processed data (individual subjects) for statistical testing
    print("  Loading processed data for statistical analysis...")
    baseline_processed = load_grouped_data(os.path.join(directory, "baseline_processed.xlsx"))
    exp_processed = load_grouped_data(os.path.join(directory, "exp_processed.xlsx"))
    
    # Map sheet names to groups (e.g., '1a.WBPth' -> 'group a')
    def get_group_letter(sheet_name):
        import re
        match = re.search(r'\d+([a-zA-Z])', sheet_name)
        if match:
            return f"group {match.group(1).lower()}"
        return None
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    group_colors = {'group a': '#E74C3C', 'group b': '#3498DB', 'group c': '#27AE60'}  # Red, Blue, Green
    group_markers = {'group a': 'o', 'group b': 's', 'group c': '^'}
    
    fig, axes = plt.subplots(2, 2, figsize=(14, 10))
    axes = axes.flatten()
    
    for j, col in enumerate(selected_cols):
        ax = axes[j]
        
        # Store data for statistical testing
        timepoint_data = {}  # {minute: {group: [values]}}
        
        for group in groups:
            color = group_colors.get(group, 'gray')
            marker = group_markers.get(group, 'o')
            baseline_full = baseline_data[group]
            experiment = experiment_data[group]
            
            all_times = []
            all_means = []
            all_sems = []
            
            # Get the last 10 minutes of baseline data and map to -20 to -10
            if 'Minutes_from_Time0' in baseline_full.columns and col in baseline_full.columns:
                baseline_post = baseline_full[baseline_full['Minutes_from_Time0'] >= 3].copy()
                if len(baseline_post) > 0:
                    max_time = baseline_post['Minutes_from_Time0'].max()
                    # Get last 10 minutes of baseline
                    last_10_min = baseline_post[baseline_post['Minutes_from_Time0'] >= max_time - 10].copy()
                    if len(last_10_min) > 0:
                        # Map to -20 to -10 range
                        orig_min = last_10_min['Minutes_from_Time0'].min()
                        orig_max = last_10_min['Minutes_from_Time0'].max()
                        if orig_max > orig_min:
                            last_10_min['mapped_time'] = -20 + (last_10_min['Minutes_from_Time0'] - orig_min) / (orig_max - orig_min) * 10
                        else:
                            last_10_min['mapped_time'] = -15
                        
                        # Group by mapped minute and calculate mean/SEM
                        last_10_min['mapped_minute'] = last_10_min['mapped_time'].round().astype(int)
                        for minute, grp in last_10_min.groupby('mapped_minute'):
                            vals = grp[col].dropna()
                            if len(vals) > 0:
                                all_times.append(minute)
                                all_means.append(vals.mean())
                                all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                                # Store for stats
                                if minute not in timepoint_data:
                                    timepoint_data[minute] = {}
                                timepoint_data[minute][group] = vals.values
            
            # Get experiment data (limit to 30 min post-treatment)
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                exp_data = experiment[(experiment['Minutes_from_Time0'] <= 30)].copy()
                exp_data['minute'] = exp_data['Minutes_from_Time0'].round().astype(int)
                
                for minute, grp in exp_data.groupby('minute'):
                    vals = grp[col].dropna()
                    if len(vals) > 0:
                        all_times.append(minute)
                        all_means.append(vals.mean())
                        all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                        # Store for stats
                        if minute not in timepoint_data:
                            timepoint_data[minute] = {}
                        timepoint_data[minute][group] = vals.values
            
            # Sort by time
            if all_times:
                sorted_idx = np.argsort(all_times)
                all_times = np.array(all_times)[sorted_idx]
                all_means = np.array(all_means)[sorted_idx]
                all_sems = np.array(all_sems)[sorted_idx]
                
                # Plot with error bars
                ax.errorbar(all_times, all_means, yerr=all_sems, 
                           fmt=f'-{marker}', color=color, 
                           label=group.replace('group ', 'Group ').upper(),
                           markersize=5, alpha=0.8, linewidth=1.5, capsize=2, capthick=1)
        
        # Collect data from individual subjects (processed files) for statistical testing
        # This gives us multiple observations per group per timepoint
        stats_data = {}  # {minute: {group: [values from all subjects]}}
        
        # Collect experiment data from processed file
        for sheet_name, sheet_df in exp_processed.items():
            grp = get_group_letter(sheet_name)
            if grp is None or col not in sheet_df.columns or 'Minutes_from_Time0' not in sheet_df.columns:
                continue
            
            # Get data limited to 30 min post-treatment
            exp_sheet = sheet_df[(sheet_df['Minutes_from_Time0'] <= 30)].copy()
            exp_sheet['minute'] = exp_sheet['Minutes_from_Time0'].round().astype(int)
            
            for minute, grp_rows in exp_sheet.groupby('minute'):
                vals = grp_rows[col].dropna().values
                if len(vals) > 0:
                    if minute not in stats_data:
                        stats_data[minute] = {}
                    if grp not in stats_data[minute]:
                        stats_data[minute][grp] = []
                    stats_data[minute][grp].extend(vals)
        
        # Perform statistical tests at each timepoint (Kruskal-Wallis - non-parametric)
        significant_points = []
        test_count = 0
        sig_count = 0
        for minute in sorted(stats_data.keys()):
            grp_data = stats_data[minute]
            # Need at least 2 groups with data to compare
            valid_groups = [g for g in groups if g in grp_data and len(grp_data[g]) >= 2]
            if len(valid_groups) >= 2:
                try:
                    # Use Kruskal-Wallis H-test (non-parametric alternative to one-way ANOVA)
                    data_arrays = [np.array(grp_data[g]) for g in valid_groups]
                    test_count += 1
                    stat, p_val = stats.kruskal(*data_arrays)
                    if p_val < 0.05:
                        sig_count += 1
                        # Get y position for marker (max of all group means at this timepoint)
                        y_vals = [np.mean(grp_data[g]) for g in valid_groups]
                        significant_points.append((minute, max(y_vals), p_val))
                except Exception as e:
                    pass
        
        print(f"    {col}: Tested {test_count} timepoints, found {sig_count} significant")
        if sig_count > 0:
            for minute, y_pos, p_val in significant_points:
                stars = '***' if p_val < 0.001 else '**' if p_val < 0.01 else '*'
                print(f"      -> Minute {minute}: p={p_val:.4f} {stars}")
        
        # Mark significant timepoints
        for minute, y_pos, p_val in significant_points:
            stars = '***' if p_val < 0.001 else '**' if p_val < 0.01 else '*'
            ax.annotate(stars, xy=(minute, y_pos), xytext=(minute, y_pos * 1.05),
                       ha='center', fontsize=8, color='black', fontweight='bold')
        
        # Add vertical lines
        ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
        ax.axvline(x=-10, color='navy', linestyle='--', linewidth=1.5, alpha=0.7)
        
        # Set x-axis limits: -25 to 32
        ax.set_xlim(-25, 32)
        
        # Add shading
        ax.axvspan(-20, -10, alpha=0.2, color='steelblue', label='Baseline Period')
        ax.axvspan(-10, 0, alpha=0.1, color='green')
        ax.axvspan(0, 32, alpha=0.1, color='red')
        
        ax.set_xlabel('Minutes from Treatment', fontsize=10)
        ax.set_ylabel(col, fontsize=10)
        ax.set_title(f'{col} - All Groups Time Course', fontsize=12, fontweight='bold')
        
        if j == 0:
            ax.legend(loc='upper right', fontsize=8)
    
    plt.suptitle('Time Course Comparison: All Groups\n(* p<0.05, ** p<0.01, *** p<0.001 - Kruskal-Wallis test between groups)', 
                 fontsize=12, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n")
        f.write("NOTE: Post-treatment analysis starts from minute 3 (minutes 1-2 excluded)\n")
        f.write("NOTE: Timeframe graphs show up to 30 minutes post-treatment\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

Now there are significant datapoints. The Kruskal-Wallis test found:

**f (Breathing frequency):** 6 significant timepoints
- Minute 5: p=0.0261 *
- Minute 6: p=0.0210 *
- Minute 9: p=0.0311 *
- Minute 10: p=0.0196 *
- Minute 11: p=0.0056 **
- Minute 12: p=0.0408 *

**TVb (Tidal Volume):** 5 significant timepoints
- Minute -9: p=0.0498 *
- Minute 4: p=0.0497 *
- Minute 5: p=0.0445 *
- Minute 7: p=0.0367 *
- Minute 8: p=0.0434 *

**Penh:** 0 significant timepoints (no significant differences between groups)

**MVb (Minute Ventilation):** 9 significant timepoints
- Minutes -9, -8: p<0.05 * (pre-treatment)
- Minutes 17-20, 23, 28, 30: p<0.05 * (post-treatment)

The asterisks should now appear on the graph. Let me also improve the annotation positioning to make them more visible:

```python
import pandas as pd
import matplotlib
matplotlib.use('Agg')  # Use non-interactive backend
import matplotlib.pyplot as plt
import numpy as np
from scipy import stats
import os
import gc
import warnings
warnings.filterwarnings('ignore')

# Set style for better looking plots
plt.style.use('seaborn-v0_8-whitegrid')
plt.rcParams['figure.figsize'] = (14, 8)
plt.rcParams['font.size'] = 10
plt.rcParams['axes.titlesize'] = 12
plt.rcParams['axes.labelsize'] = 10

def load_grouped_data(filepath):
    """Load all sheets from a grouped Excel file"""
    xl = pd.ExcelFile(filepath)
    sheets = {}
    for sheet_name in xl.sheet_names:
        sheets[sheet_name] = pd.read_excel(filepath, sheet_name=sheet_name)
    return sheets

def get_baseline_data(df):
    """Get baseline data (post-treatment only, as reference)
    Ignores first 2 minutes after treatment - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return df
    # Use post-treatment data as baseline reference, starting from minute 3
    return df[df['Minutes_from_Time0'] >= 3].copy()

def get_pre_post_data(df):
    """Split experiment data into pre-treatment and post-treatment
    Post-treatment ignores first 2 minutes - starts from minute 3"""
    if 'Minutes_from_Time0' not in df.columns:
        return None, None
    
    pre = df[df['Minutes_from_Time0'] < 0].copy()
    # Start post-treatment from minute 3 (ignore minutes 1 and 2)
    post = df[df['Minutes_from_Time0'] >= 3].copy()
    
    return pre, post

def calculate_stats(data, column):
    """Calculate statistics for a data column"""
    if data is None or len(data) == 0:
        return None
    
    vals = data[column].dropna() if column in data.columns else pd.Series([])
    
    if len(vals) == 0:
        return None
    
    return {
        'mean': vals.mean(),
        'std': vals.std(),
        'n': len(vals),
        'sem': vals.std() / np.sqrt(len(vals)),
        'values': vals
    }

def main():
    # Directory
    directory = r"C:\Users\user\ambs"
    
    # Load data
    print("Loading data...")
    baseline_data = load_grouped_data(os.path.join(directory, "baseline_grouped.xlsx"))
    experiment_data = load_grouped_data(os.path.join(directory, "exp_grouped.xlsx"))
    
    print(f"Baseline groups: {list(baseline_data.keys())}")
    print(f"Experiment groups: {list(experiment_data.keys())}")
    
    # Get common groups
    groups = sorted(set(baseline_data.keys()) & set(experiment_data.keys()))
    print(f"Common groups for comparison: {groups}")
    
    # Key measurement columns to analyze
    key_columns = ['f', 'TVb', 'MVb', 'Penh', 'Ti', 'Te', 'PIFb', 'PEFb']
    
    # Create output directory for plots
    plots_dir = os.path.join(directory, "analysis_plots_v3")
    os.makedirs(plots_dir, exist_ok=True)
    
    # ========================================================================
    # Data preparation: Baseline (post only) vs Experiment (pre and post)
    # ========================================================================
    print("\n" + "="*70)
    print("DATA STRUCTURE:")
    print("  - BASELINE: Post-treatment data only, starting from minute 3 (reference)")
    print("  - EXPERIMENT PRE: Before treatment")
    print("  - EXPERIMENT POST: After treatment, starting from minute 3")
    print("  NOTE: Minutes 1-2 are excluded from post-treatment analysis")
    print("="*70)
    
    # Store all statistics
    all_stats = {}
    
    for group in groups:
        all_stats[group] = {}
        
        # Get baseline (post-treatment only)
        baseline = get_baseline_data(baseline_data[group])
        
        # Get experiment pre and post
        exp_pre, exp_post = get_pre_post_data(experiment_data[group])
        
        for col in key_columns:
            bl_stats = calculate_stats(baseline, col)
            pre_stats = calculate_stats(exp_pre, col)
            post_stats = calculate_stats(exp_post, col)
            
            all_stats[group][col] = {
                'baseline': bl_stats,
                'exp_pre': pre_stats,
                'exp_post': post_stats
            }
    
    # ========================================================================
    # PART 1: Summary Statistics
    # ========================================================================
    print("\n" + "="*70)
    print("PART 1: SUMMARY STATISTICS")
    print("="*70)
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        print(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}")
        print("-" * 70)
        
        for col in key_columns:
            col_stats = all_stats[group][col]
            
            bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else float('nan')
            pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else float('nan')
            post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else float('nan')
            
            # Calculate percent difference from baseline
            pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean and not np.isnan(bl_mean) else float('nan')
            
            print(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%")
    
    # ========================================================================
    # PART 2: Statistical Comparisons
    # ========================================================================
    print("\n" + "="*70)
    print("PART 2: STATISTICAL COMPARISONS")
    print("="*70)
    
    comparison_results = {}
    
    for group in groups:
        print(f"\n{'='*50}")
        print(f"  {group.upper()}")
        print(f"{'='*50}")
        comparison_results[group] = {}
        
        print("\n--- Experiment Pre vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                diff_pct = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Pre={col_stats['exp_pre']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_pre_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Post vs Baseline ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Baseline={col_stats['baseline']['mean']:.2f}, Exp Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Diff={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_post_vs_bl'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
        
        print("\n--- Experiment Pre vs Post (Treatment Effect) ---")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                t_stat, p_val = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                diff_pct = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                sig = "***" if p_val < 0.001 else "**" if p_val < 0.01 else "*" if p_val < 0.05 else ""
                print(f"  {col}: Pre={col_stats['exp_pre']['mean']:.2f} -> Post={col_stats['exp_post']['mean']:.2f}, "
                      f"Change={diff_pct:+.1f}%, p={p_val:.4f} {sig}")
                comparison_results[group][f'{col}_treatment'] = {'p': p_val, 'diff': diff_pct, 'sig': sig}
    
    # ========================================================================
    # VISUALIZATION 1: Bar Chart - Baseline vs Exp Pre vs Exp Post
    # ========================================================================
    print("\n\nCreating visualizations...")
    
    for group in groups:
        fig, axes = plt.subplots(2, 4, figsize=(14, 8))
        axes = axes.flatten()
        
        for idx, col in enumerate(key_columns):
            ax = axes[idx]
            col_stats = all_stats[group][col]
            
            x = np.arange(3)
            
            means = [
                col_stats['baseline']['mean'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
            ]
            sems = [
                col_stats['baseline']['sem'] if col_stats['baseline'] else 0,
                col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0,
                col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0
            ]
            
            colors = ['steelblue', 'lightsalmon', 'coral']
            bars = ax.bar(x, means, yerr=sems, capsize=4, color=colors, edgecolor='black', linewidth=1.2)
            
            ax.set_ylabel(col)
            ax.set_title(f'{col}')
            ax.set_xticks(x)
            ax.set_xticklabels(['Baseline', 'Exp Pre', 'Exp Post'], rotation=15)
            
            # Add significance markers
            if col_stats['exp_pre'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[1]) + max(sems[0], sems[1])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 1], [max_y * 1.05, max_y * 1.05], 'k-', linewidth=1)
                    ax.text(0.5, max_y * 1.07, stars, ha='center', fontsize=10)
            
            if col_stats['exp_post'] and col_stats['baseline']:
                _, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                if p < 0.05:
                    max_y = max(means[0], means[2]) + max(sems[0], sems[2])
                    stars = "***" if p < 0.001 else "**" if p < 0.01 else "*"
                    ax.plot([0, 2], [max_y * 1.15, max_y * 1.15], 'k-', linewidth=1)
                    ax.text(1, max_y * 1.17, stars, ha='center', fontsize=10)
        
        plt.suptitle(f'{group.upper()}: Baseline vs Experiment (Pre/Post Treatment)', fontsize=14, fontweight='bold')
        plt.tight_layout()
        plt.savefig(os.path.join(plots_dir, f'comparison_{group.replace(" ", "_")}.png'), dpi=100, bbox_inches='tight')
        plt.close()
        gc.collect()
        print(f"  Saved: comparison_{group.replace(' ', '_')}.png")
    
    # ========================================================================
    # VISUALIZATION 2: Time Course with Baseline Reference (All Groups Combined)
    # ========================================================================
    print("\nCreating time-course plots...")
    
    # Load processed data (individual subjects) for statistical testing
    print("  Loading processed data for statistical analysis...")
    baseline_processed = load_grouped_data(os.path.join(directory, "baseline_processed.xlsx"))
    exp_processed = load_grouped_data(os.path.join(directory, "exp_processed.xlsx"))
    
    # Map sheet names to groups (e.g., '1a.WBPth' -> 'group a')
    def get_group_letter(sheet_name):
        import re
        match = re.search(r'\d+([a-zA-Z])', sheet_name)
        if match:
            return f"group {match.group(1).lower()}"
        return None
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    group_colors = {'group a': '#E74C3C', 'group b': '#3498DB', 'group c': '#27AE60'}  # Red, Blue, Green
    group_markers = {'group a': 'o', 'group b': 's', 'group c': '^'}
    
    fig, axes = plt.subplots(2, 2, figsize=(14, 10))
    axes = axes.flatten()
    
    for j, col in enumerate(selected_cols):
        ax = axes[j]
        
        # Store data for statistical testing
        timepoint_data = {}  # {minute: {group: [values]}}
        
        for group in groups:
            color = group_colors.get(group, 'gray')
            marker = group_markers.get(group, 'o')
            baseline_full = baseline_data[group]
            experiment = experiment_data[group]
            
            all_times = []
            all_means = []
            all_sems = []
            
            # Get the last 10 minutes of baseline data and map to -20 to -10
            if 'Minutes_from_Time0' in baseline_full.columns and col in baseline_full.columns:
                baseline_post = baseline_full[baseline_full['Minutes_from_Time0'] >= 3].copy()
                if len(baseline_post) > 0:
                    max_time = baseline_post['Minutes_from_Time0'].max()
                    # Get last 10 minutes of baseline
                    last_10_min = baseline_post[baseline_post['Minutes_from_Time0'] >= max_time - 10].copy()
                    if len(last_10_min) > 0:
                        # Map to -20 to -10 range
                        orig_min = last_10_min['Minutes_from_Time0'].min()
                        orig_max = last_10_min['Minutes_from_Time0'].max()
                        if orig_max > orig_min:
                            last_10_min['mapped_time'] = -20 + (last_10_min['Minutes_from_Time0'] - orig_min) / (orig_max - orig_min) * 10
                        else:
                            last_10_min['mapped_time'] = -15
                        
                        # Group by mapped minute and calculate mean/SEM
                        last_10_min['mapped_minute'] = last_10_min['mapped_time'].round().astype(int)
                        for minute, grp in last_10_min.groupby('mapped_minute'):
                            vals = grp[col].dropna()
                            if len(vals) > 0:
                                all_times.append(minute)
                                all_means.append(vals.mean())
                                all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                                # Store for stats
                                if minute not in timepoint_data:
                                    timepoint_data[minute] = {}
                                timepoint_data[minute][group] = vals.values
            
            # Get experiment data (limit to 30 min post-treatment)
            if col in experiment.columns and 'Minutes_from_Time0' in experiment.columns:
                exp_data = experiment[(experiment['Minutes_from_Time0'] <= 30)].copy()
                exp_data['minute'] = exp_data['Minutes_from_Time0'].round().astype(int)
                
                for minute, grp in exp_data.groupby('minute'):
                    vals = grp[col].dropna()
                    if len(vals) > 0:
                        all_times.append(minute)
                        all_means.append(vals.mean())
                        all_sems.append(vals.std() / np.sqrt(len(vals)) if len(vals) > 1 else 0)
                        # Store for stats
                        if minute not in timepoint_data:
                            timepoint_data[minute] = {}
                        timepoint_data[minute][group] = vals.values
            
            # Sort by time
            if all_times:
                sorted_idx = np.argsort(all_times)
                all_times = np.array(all_times)[sorted_idx]
                all_means = np.array(all_means)[sorted_idx]
                all_sems = np.array(all_sems)[sorted_idx]
                
                # Plot with error bars
                ax.errorbar(all_times, all_means, yerr=all_sems, 
                           fmt=f'-{marker}', color=color, 
                           label=group.replace('group ', 'Group ').upper(),
                           markersize=5, alpha=0.8, linewidth=1.5, capsize=2, capthick=1)
        
        # Collect data from individual subjects (processed files) for statistical testing
        # This gives us multiple observations per group per timepoint
        stats_data = {}  # {minute: {group: [values from all subjects]}}
        
        # Collect experiment data from processed file
        for sheet_name, sheet_df in exp_processed.items():
            grp = get_group_letter(sheet_name)
            if grp is None or col not in sheet_df.columns or 'Minutes_from_Time0' not in sheet_df.columns:
                continue
            
            # Get data limited to 30 min post-treatment
            exp_sheet = sheet_df[(sheet_df['Minutes_from_Time0'] <= 30)].copy()
            exp_sheet['minute'] = exp_sheet['Minutes_from_Time0'].round().astype(int)
            
            for minute, grp_rows in exp_sheet.groupby('minute'):
                vals = grp_rows[col].dropna().values
                if len(vals) > 0:
                    if minute not in stats_data:
                        stats_data[minute] = {}
                    if grp not in stats_data[minute]:
                        stats_data[minute][grp] = []
                    stats_data[minute][grp].extend(vals)
        
        # Perform statistical tests at each timepoint (Kruskal-Wallis - non-parametric)
        significant_points = []
        test_count = 0
        sig_count = 0
        for minute in sorted(stats_data.keys()):
            grp_data = stats_data[minute]
            # Need at least 2 groups with data to compare
            valid_groups = [g for g in groups if g in grp_data and len(grp_data[g]) >= 2]
            if len(valid_groups) >= 2:
                try:
                    # Use Kruskal-Wallis H-test (non-parametric alternative to one-way ANOVA)
                    data_arrays = [np.array(grp_data[g]) for g in valid_groups]
                    test_count += 1
                    stat, p_val = stats.kruskal(*data_arrays)
                    if p_val < 0.05:
                        sig_count += 1
                        # Get y position for marker (max of all group means at this timepoint)
                        y_vals = [np.mean(grp_data[g]) for g in valid_groups]
                        significant_points.append((minute, max(y_vals), p_val))
                except Exception as e:
                    pass
        
        print(f"    {col}: Tested {test_count} timepoints, found {sig_count} significant")
        if sig_count > 0:
            for minute, y_pos, p_val in significant_points:
                stars = '***' if p_val < 0.001 else '**' if p_val < 0.01 else '*'
                print(f"      -> Minute {minute}: p={p_val:.4f} {stars}")
        
        # Mark significant timepoints with visible markers
        for minute, y_pos, p_val in significant_points:
            stars = '***' if p_val < 0.001 else '**' if p_val < 0.01 else '*'
            # Use a more visible annotation with background
            ax.annotate(stars, xy=(minute, y_pos), xytext=(minute, y_pos * 1.08),
                       ha='center', fontsize=10, color='red', fontweight='bold',
                       bbox=dict(boxstyle='round,pad=0.1', facecolor='yellow', alpha=0.7, edgecolor='none'))
        
        # Add vertical lines
        ax.axvline(x=0, color='black', linestyle='--', linewidth=2, label='Treatment')
        ax.axvline(x=-10, color='navy', linestyle='--', linewidth=1.5, alpha=0.7)
        
        # Set x-axis limits: -25 to 32
        ax.set_xlim(-25, 32)
        
        # Add shading
        ax.axvspan(-20, -10, alpha=0.2, color='steelblue', label='Baseline Period')
        ax.axvspan(-10, 0, alpha=0.1, color='green')
        ax.axvspan(0, 32, alpha=0.1, color='red')
        
        ax.set_xlabel('Minutes from Treatment', fontsize=10)
        ax.set_ylabel(col, fontsize=10)
        ax.set_title(f'{col} - All Groups Time Course', fontsize=12, fontweight='bold')
        
        if j == 0:
            ax.legend(loc='upper right', fontsize=8)
    
    plt.suptitle('Time Course Comparison: All Groups\n(* p<0.05, ** p<0.01, *** p<0.001 - Kruskal-Wallis test between groups)', 
                 fontsize=12, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'timecourse_vs_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: timecourse_vs_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 3: Difference from Baseline Heatmap
    # ========================================================================
    print("\nCreating difference heatmap...")
    
    fig, axes = plt.subplots(1, 2, figsize=(12, 4))
    
    # Pre vs Baseline
    pre_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        pre_diffs.append(row)
    
    im1 = axes[0].imshow(pre_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[0].set_xticks(np.arange(len(key_columns)))
    axes[0].set_yticks(np.arange(len(groups)))
    axes[0].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[0].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[0].set_title('EXPERIMENT PRE vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = pre_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[0].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im1, ax=axes[0], label='% Difference from Baseline')
    
    # Post vs Baseline
    post_diffs = []
    for group in groups:
        row = []
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
            else:
                diff = 0
            row.append(diff)
        post_diffs.append(row)
    
    im2 = axes[1].imshow(post_diffs, cmap='RdBu_r', aspect='auto', vmin=-200, vmax=200)
    axes[1].set_xticks(np.arange(len(key_columns)))
    axes[1].set_yticks(np.arange(len(groups)))
    axes[1].set_xticklabels(key_columns, rotation=45, ha='right')
    axes[1].set_yticklabels([g.replace('group ', '').upper() for g in groups])
    axes[1].set_title('EXPERIMENT POST vs BASELINE (%)', fontweight='bold')
    for i in range(len(groups)):
        for j in range(len(key_columns)):
            val = post_diffs[i][j]
            color = 'white' if abs(val) > 100 else 'black'
            axes[1].text(j, i, f'{val:+.0f}%', ha='center', va='center', color=color, fontsize=9)
    plt.colorbar(im2, ax=axes[1], label='% Difference from Baseline')
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'diff_from_baseline_heatmap.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: diff_from_baseline_heatmap.png")
    
    # ========================================================================
    # VISUALIZATION 4: Treatment Effect Lines
    # ========================================================================
    print("\nCreating treatment effect plots...")
    
    fig, axes = plt.subplots(len(groups), 4, figsize=(14, 3*len(groups)))
    if len(groups) == 1:
        axes = axes.reshape(1, -1)
    
    selected_cols = ['f', 'TVb', 'Penh', 'MVb']
    
    for i, group in enumerate(groups):
        for j, col in enumerate(selected_cols):
            ax = axes[i, j]
            col_stats = all_stats[group][col]
            
            if col_stats['baseline'] and col_stats['exp_pre'] and col_stats['exp_post']:
                bl_mean = col_stats['baseline']['mean']
                pre_mean = col_stats['exp_pre']['mean']
                post_mean = col_stats['exp_post']['mean']
                
                # Plot baseline as reference line
                ax.axhline(y=bl_mean, color='steelblue', linestyle='-', linewidth=3, label='Baseline')
                
                # Plot experiment pre to post
                ax.plot([0, 1], [pre_mean, post_mean], 'o-', color='coral', 
                       linewidth=2.5, markersize=12, label='Experiment')
                
                # Add percentage annotations
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100)
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100)
                treatment_effect = ((post_mean - pre_mean) / pre_mean * 100) if pre_mean != 0 else 0
                
                ax.annotate(f'{pre_vs_bl:+.0f}% vs BL', xy=(0, pre_mean), xytext=(-0.15, pre_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'{post_vs_bl:+.0f}% vs BL', xy=(1, post_mean), xytext=(1.05, post_mean),
                           fontsize=9, color='coral', fontweight='bold')
                ax.annotate(f'Treatment:\n{treatment_effect:+.0f}%', xy=(0.5, (pre_mean+post_mean)/2),
                           fontsize=8, ha='center', color='darkred')
            
            ax.set_xticks([0, 1])
            ax.set_xticklabels(['Pre-Treatment', 'Post-Treatment'])
            ax.set_ylabel(col)
            ax.set_title(f'{group.upper()}: {col}')
            ax.set_xlim(-0.3, 1.5)
            
            if i == 0 and j == 0:
                ax.legend(loc='best', fontsize=8)
    
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'treatment_effect_lines.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: treatment_effect_lines.png")
    
    # ========================================================================
    # VISUALIZATION 5: Normalized to Baseline (100%)
    # ========================================================================
    print("\nCreating normalized comparison...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        # Baseline is always 100%
        baseline_normalized = [100] * len(groups)
        
        pre_normalized = []
        post_normalized = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                pre_normalized.append((col_stats['exp_pre']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                pre_normalized.append(0)
            
            if col_stats['baseline'] and col_stats['exp_post']:
                post_normalized.append((col_stats['exp_post']['mean'] / col_stats['baseline']['mean']) * 100)
            else:
                post_normalized.append(0)
        
        ax.bar(x - width, baseline_normalized, width, label='Baseline', color='steelblue', edgecolor='black')
        ax.bar(x, pre_normalized, width, label='Exp Pre', color='lightsalmon', edgecolor='black')
        ax.bar(x + width, post_normalized, width, label='Exp Post', color='coral', edgecolor='black')
        
        ax.axhline(y=100, color='gray', linestyle='--', alpha=0.5)
        
        ax.set_ylabel(f'{col} (% of Baseline)')
        ax.set_title(f'{col}')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('All Parameters Normalized to Baseline (100%)', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'normalized_to_baseline.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: normalized_to_baseline.png")
    
    # ========================================================================
    # VISUALIZATION 6: Summary Grouped Bar Chart
    # ========================================================================
    print("\nCreating summary chart...")
    
    fig, axes = plt.subplots(2, 4, figsize=(14, 8))
    axes = axes.flatten()
    
    for idx, col in enumerate(key_columns):
        ax = axes[idx]
        
        x = np.arange(len(groups))
        width = 0.25
        
        baseline_vals = []
        pre_vals = []
        post_vals = []
        baseline_sems = []
        pre_sems = []
        post_sems = []
        
        for group in groups:
            col_stats = all_stats[group][col]
            baseline_vals.append(col_stats['baseline']['mean'] if col_stats['baseline'] else 0)
            pre_vals.append(col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0)
            post_vals.append(col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0)
            baseline_sems.append(col_stats['baseline']['sem'] if col_stats['baseline'] else 0)
            pre_sems.append(col_stats['exp_pre']['sem'] if col_stats['exp_pre'] else 0)
            post_sems.append(col_stats['exp_post']['sem'] if col_stats['exp_post'] else 0)
        
        ax.bar(x - width, baseline_vals, width, yerr=baseline_sems, label='Baseline', 
               color='steelblue', edgecolor='black', capsize=3)
        ax.bar(x, pre_vals, width, yerr=pre_sems, label='Exp Pre', 
               color='lightsalmon', edgecolor='black', capsize=3)
        ax.bar(x + width, post_vals, width, yerr=post_sems, label='Exp Post', 
               color='coral', edgecolor='black', capsize=3)
        
        ax.set_ylabel(col)
        ax.set_title(f'{col} Comparison')
        ax.set_xticks(x)
        ax.set_xticklabels([g.replace('group ', '').upper() for g in groups])
        
        if idx == 0:
            ax.legend(loc='best', fontsize=8)
    
    plt.suptitle('Baseline vs Experiment Pre/Post Comparison', fontsize=14, fontweight='bold')
    plt.tight_layout()
    plt.savefig(os.path.join(plots_dir, 'summary_comparison.png'), dpi=100, bbox_inches='tight')
    plt.close()
    gc.collect()
    print(f"  Saved: summary_comparison.png")
    
    # ========================================================================
    # SUMMARY AND CONCLUSIONS
    # ========================================================================
    print("\n" + "="*70)
    print("SUMMARY AND KEY FINDINGS")
    print("="*70)
    
    print("\n[1] EXPERIMENT PRE-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows initial state of experiment animals compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_pre']:
                diff = ((col_stats['exp_pre']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_pre']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[2] EXPERIMENT POST-TREATMENT vs BASELINE")
    print("-" * 50)
    print("(Shows state after treatment compared to baseline)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['baseline'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['baseline']['mean']) / col_stats['baseline']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['baseline']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    print(f"  {col}: {diff:+.1f}% vs Baseline (p={p:.4f}) {sig}")
    
    print("\n\n[3] TREATMENT EFFECT (Pre to Post)")
    print("-" * 50)
    print("(Shows the effect of treatment within experiment group)")
    
    for group in groups:
        print(f"\n{group.upper()}:")
        for col in key_columns:
            col_stats = all_stats[group][col]
            if col_stats['exp_pre'] and col_stats['exp_post']:
                diff = ((col_stats['exp_post']['mean'] - col_stats['exp_pre']['mean']) / col_stats['exp_pre']['mean'] * 100)
                t, p = stats.ttest_ind(col_stats['exp_pre']['values'], col_stats['exp_post']['values'])
                sig = "***" if p < 0.001 else "**" if p < 0.01 else "*" if p < 0.05 else ""
                if abs(diff) > 20 or p < 0.05:
                    direction = "increased" if diff > 0 else "decreased"
                    print(f"  {col}: {direction} by {abs(diff):.1f}% (p={p:.4f}) {sig}")
    
    print("\n\n[4] KEY CONCLUSIONS")
    print("-" * 50)
    
    # Analyze key parameters
    print("\nPenh (Airway Resistance):")
    for group in groups:
        penh_stats = all_stats[group]['Penh']
        if penh_stats['baseline'] and penh_stats['exp_pre'] and penh_stats['exp_post']:
            pre_vs_bl = ((penh_stats['exp_pre']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            post_vs_bl = ((penh_stats['exp_post']['mean'] - penh_stats['baseline']['mean']) / penh_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl > 100 and post_vs_bl < pre_vs_bl:
                print(f"    -> Treatment REDUCED Penh towards baseline")
    
    print("\nMVb (Minute Ventilation):")
    for group in groups:
        mvb_stats = all_stats[group]['MVb']
        if mvb_stats['baseline'] and mvb_stats['exp_pre'] and mvb_stats['exp_post']:
            pre_vs_bl = ((mvb_stats['exp_pre']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            post_vs_bl = ((mvb_stats['exp_post']['mean'] - mvb_stats['baseline']['mean']) / mvb_stats['baseline']['mean'] * 100)
            print(f"  {group.upper()}: Pre={pre_vs_bl:+.0f}% vs BL, Post={post_vs_bl:+.0f}% vs BL")
            if pre_vs_bl < -30 and post_vs_bl > pre_vs_bl:
                print(f"    -> Treatment INCREASED MVb towards baseline")
    
    print("\n" + "="*70)
    print(f"All visualizations saved to: {plots_dir}")
    print("="*70)
    
    # Save summary to file
    summary_path = os.path.join(directory, "analysis_summary_v3.txt")
    with open(summary_path, 'w', encoding='utf-8') as f:
        f.write("EXPERIMENT ANALYSIS SUMMARY (v3)\n")
        f.write("================================\n")
        f.write("Analysis compares: Baseline | Experiment Pre | Experiment Post\n")
        f.write("Baseline = post-treatment data from baseline condition (reference)\n")
        f.write("NOTE: Post-treatment analysis starts from minute 3 (minutes 1-2 excluded)\n")
        f.write("NOTE: Timeframe graphs show up to 30 minutes post-treatment\n\n")
        
        f.write("="*70 + "\n")
        f.write("SUMMARY STATISTICS\n")
        f.write("="*70 + "\n\n")
        
        for group in groups:
            f.write(f"\n{group.upper()}\n")
            f.write("-"*50 + "\n")
            f.write(f"{'Parameter':<10} {'Baseline':>12} {'Exp Pre':>12} {'Exp Post':>12} {'Pre vs BL':>12} {'Post vs BL':>12}\n")
            
            for col in key_columns:
                col_stats = all_stats[group][col]
                bl_mean = col_stats['baseline']['mean'] if col_stats['baseline'] else 0
                pre_mean = col_stats['exp_pre']['mean'] if col_stats['exp_pre'] else 0
                post_mean = col_stats['exp_post']['mean'] if col_stats['exp_post'] else 0
                pre_vs_bl = ((pre_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                post_vs_bl = ((post_mean - bl_mean) / bl_mean * 100) if bl_mean else 0
                f.write(f"{col:<10} {bl_mean:>12.2f} {pre_mean:>12.2f} {post_mean:>12.2f} {pre_vs_bl:>+11.1f}% {post_vs_bl:>+11.1f}%\n")
    
    print(f"\nSummary saved to: {summary_path}")

if __name__ == "__main__":
    main()


```

The graph has been regenerated with **visible significance markers** (red asterisks on yellow background). Here's a summary of the statistical analysis results:

| Parameter | Significant Timepoints | Details |
|-----------|----------------------|---------|
| **f** | 6 | Minutes 5, 6, 9, 10, 11**, 12 |
| **TVb** | 5 | Minute -9, 4, 5, 7, 8 |
| **Penh** | 0 | No significant differences between groups |
| **MVb** | 9 | Minutes -9, -8 (pre), 17-20, 23, 28, 30 (post) |

**Statistical method used:** Kruskal-Wallis H-test (non-parametric test for comparing 3+ independent groups - appropriate when data may not be normally distributed)

**Key findings:**
- **Penh** shows no significant differences between groups at any timepoint
- **f** and **TVb** show significant group differences mainly in early post-treatment (minutes 4-12)
- **MVb** shows significant differences both pre-treatment (minutes -9, -8) and in later post-treatment (minutes 17-30)

The significance markers should now be clearly visible on the `timecourse_vs_baseline.png` plot with yellow highlighting.

---

**User**

push everything back into GitHub

---

**Cursor**

Done! All changes have been pushed to GitHub:

**Repository:** https://github.com/natali-work/Final

**Commit:** `e1693a7` - "Update timecourse plot: combined groups, error bars, statistical significance markers"

**Files updated:**
- `analyze_experiment_v3.py` - Updated analysis script with new timecourse visualization
- `analysis_summary_v3.txt` - Updated summary
- `analysis_plots_v3/` - All regenerated plots including the new combined timecourse plot with significance markers

